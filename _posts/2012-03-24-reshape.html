--- 
layout: post
name: reshape
title: "\xE5\xA6\x82\xE4\xBD\x95\xE4\xBD\xBF\xE7\x94\xA8reshape\xE5\x8C\x85\xE8\xBF\x9B\xE8\xA1\x8C\xE6\x95\xB0\xE6\x8D\xAE\xE6\xB1\x87\xE6\x80\xBB"
date: 2012-03-24 12:00:00 +08:00
categories: 
- "\xE6\x95\xB0\xE6\x8D\xAE\xE9\xA2\x84\xE5\xA4\x84\xE7\x90\x86"
permalink: /2012/03/reshape.html
---
<div class="separator" style="clear: both; text-align: center;"><a href="http://thumbsnap.com/i/8AYMq5ML.jpg" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" src="http://thumbsnap.com/i/8AYMq5ML.jpg" /></a></div>在数据分析过程中，利用各种图表进行数据探索是必要的前期工作。描述性统计中就包括了直方图、散点图等工具来探索连续数据，对于分类数据，则可以采用条形图、交叉分组表等工具。Excel中所谓的“数据透视表”，其实就是一个交互式的交叉分组表。在R语言中可以很容易的用<b>table()</b>等函数得到相应的结果。对于一些更为复杂的任务，就需要其它的函数或包来完成。本例先以iris数据集为研究对象示范一些基本函数的用法，再介绍reshape包的强大功能。<br /><br /><b>iris</b>数据集中有五个变量，其中Species表示鸢尾属花的子类，其它四个变量分别是花瓣和萼片的长度和宽度。你可以用head(iris)来观察原始数据的一些样本。我们的第一个任务是想计算不同种类花在四个指标上的平均值。用到的函数有<b>tapply</b>，<b>by</b>及<b>aggregate</b>。<a href="http://xccds1977.blogspot.com/2012/02/r_29.html">这篇文章</a>对它们有所涉及。<br /><a name='more'></a><br />将数据解包后，先用tapply函数尝试，但会发现该函数一次只允许输入一个变量。如果要完全四个变量的计算可能得用到循环。放弃这个函数来试试用by函数，该函数可以一次输入多个变量，但输出结果为一个list格式，还需要用do.call函数进行整合，有点麻烦。最方便友好的还是aggregate函数，直接输出为数据框格式。另外它还允许用公式来设置分组因子。<br /><br /><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><a href="http://inside-r.org/r-doc/base/attach"><span style="color: #003399;">attach</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/datasets/iris"><span style="color: #003399;">iris</span></a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/names"><span style="color: #003399;">names</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/datasets/iris"><span style="color: #003399;">iris</span></a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/tapply"><span style="color: #003399;">tapply</span></a><span style="color: #009900;">(</span>X=Sepal.Length<span style="color: #339933;">,</span>INDEX=Species<span style="color: #339933;">,</span>FUN=<a href="http://inside-r.org/r-doc/base/mean"><span style="color: #003399;">mean</span></a><span style="color: #009900;">)</span><br />temp &lt;-<a href="http://inside-r.org/r-doc/base/by"><span style="color: #003399;">by</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>=<a href="http://inside-r.org/r-doc/datasets/iris"><span style="color: #003399;">iris</span></a><span style="color: #009900;">[</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">1</span>:<span style="color: #cc66cc;">4</span><span style="color: #009900;">]</span><span style="color: #339933;">,</span>INDICES=Species<span style="color: #339933;">,</span>FUN=<a href="http://inside-r.org/r-doc/base/mean"><span style="color: #003399;">mean</span></a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/do.call"><span style="color: #003399;">do.call</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/rbind"><span style="color: #003399;">rbind</span></a><span style="color: #339933;">,</span>temp<span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/stats/aggregate"><span style="color: #003399;">aggregate</span></a><span style="color: #009900;">(</span>x=<a href="http://inside-r.org/r-doc/datasets/iris"><span style="color: #003399;">iris</span></a><span style="color: #009900;">[</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">1</span>:<span style="color: #cc66cc;">4</span><span style="color: #009900;">]</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/by"><span style="color: #003399;">by</span></a>=<a href="http://inside-r.org/r-doc/base/list"><span style="color: #003399;">list</span></a><span style="color: #009900;">(</span>Species<span style="color: #009900;">)</span><span style="color: #339933;">,</span>FUN=<a href="http://inside-r.org/r-doc/base/mean"><span style="color: #003399;">mean</span></a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/stats/aggregate"><span style="color: #003399;">aggregate</span></a><span style="color: #009900;">(</span>.~ Species<span style="color: #339933;">,</span> <a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a> = <a href="http://inside-r.org/r-doc/datasets/iris"><span style="color: #003399;">iris</span></a><span style="color: #339933;">,</span> <a href="http://inside-r.org/r-doc/base/mean"><span style="color: #003399;">mean</span></a><span style="color: #009900;">)</span></span></pre>aggreagate函数表现已然不错，但还不够强大。比如说它没法直接得出表格的边际值，所以下面就请出本场的主角，即<b>reshape包</b>中的两员大将：<b>melt</b>与<b>cast</b>。这两个通常是配合使用，melt专门负责<b>“融合”</b>原始数据，形成长型（long）数据结构。cast则专职将融合后的数据<b>“重铸”</b>为新的形式（让人想起了“铁索连环”）。基本上只要有这两个函数，就能统一解决所有的汇总问题。<br /><br />还是以上面的问题为例子，先加载reshape包，然后用melt函数进行融合数据，其中参数id指定了用Species为编号变量，measure参数用来指定分析变量（即被融合的变量），本例中只指定了参数id，所以原始数据中未包括在id中的其它变量均指定为分析变量。你可以观察到新的数据iris.melt其实就是堆叠（stack）后的数据。然后我们再用cast来重铸，cast函数中可以使用公式，波浪号左侧变量将纵列显示，右侧变量将以横行显示。margins参数设定了以列作为边际汇总方向。如果希望在计算中只包括两种花，可以使用subset参数。<br /><br /><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/reshape"><span style="color: #003399;">reshape</span></a><span style="color: #009900;">)</span><br />iris.melt &lt;- melt<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/datasets/iris"><span style="color: #003399;">iris</span></a><span style="color: #339933;">,</span>id=<span style="color: blue;">'Species'</span><span style="color: #009900;">)</span><br />cast<span style="color: #009900;">(</span>Species~variable<span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>=iris.melt<span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/mean"><span style="color: #003399;">mean</span></a><span style="color: #339933;">,</span>margins=<span style="color: blue;">"grand_row"</span><span style="color: #009900;">)</span><br />cast<span style="color: #009900;">(</span>Species~variable<span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>=iris.melt<span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/mean"><span style="color: #003399;">mean</span></a><span style="color: #339933;">,</span><br />     <a href="http://inside-r.org/r-doc/base/subset"><span style="color: #003399;">subset</span></a>=Species %in% <a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><span style="color: blue;">'setosa'</span><span style="color: #339933;">,</span><span style="color: blue;">'versicolor'</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><br />     margins=<span style="color: blue;">'grand_row'</span><span style="color: #009900;">)</span></span></pre>reshape包的作者也是ggplot2包的开发者，这个牛人是个完美主义者，在reshape包推出五年后，他重构代码推出了新的<b>reshape2包</b>。这个新包的特性在于：<br /><ul><li>改进算法，使计算与内存使用效能增强；</li><li>用dcast和acast代替了原来的cast函数；</li><li>用变量名来设定边际参数；</li><li>删除cast中的一些特性，因为他确认plyr包能更好的处理；</li><li>所有的melt函数族都增加了处理缺失值的参数。</li></ul>下面我们以diamonds数据为例，来完成一个略为复杂的任务。我们希望计算不同切工和不同纯净度条件下，钻石的单位平均价格，并加以比较。首先加载reshape2包和ggplot2包，然后取子集。将原始数据融合，以切工、颜色和净度为编号变量。再利用dcast函数重铸数据，得到汇总结果。计算出单位价格，最后用条形图表现结果。<br /><br /><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;">library</span></a><span style="color: #009900;">(</span>reshape2<span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/ggplot2">ggplot2</a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a> &lt;- <a href="http://inside-r.org/packages/cran/diamonds">diamonds</a><span style="color: #009900;">[</span><span style="color: #cc66cc;">1</span>:<span style="color: #cc66cc;">7</span><span style="color: #009900;">]</span><br />data.melt &lt;- melt<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a><span style="color: #339933;">,</span>id=<a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><span style="color: blue;">'cut'</span><span style="color: #339933;">,</span><span style="color: blue;">'color'</span><span style="color: #339933;">,</span><span style="color: blue;">'clarity'</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><br />diam.sum &lt;- dcast<span style="color: #009900;">(</span>data.melt<span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/cut"><span style="color: #003399;">cut</span></a>+clarity~variable<span style="color: #339933;">,</span><br />     <a href="http://inside-r.org/r-doc/base/subset"><span style="color: #003399;">subset</span></a>=.<span style="color: #009900;">(</span>variable %in% <a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><span style="color: blue;">'price'</span><span style="color: #339933;">,</span><span style="color: blue;">'carat'</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/mean"><span style="color: #003399;">mean</span></a><span style="color: #009900;">)</span><br />diam.sum$average &lt;- diam.sum$price/diam.sum$carat <br />p &lt;- <a href="http://inside-r.org/packages/cran/ggplot">ggplot</a><span style="color: #009900;">(</span>diam.sum<span style="color: #339933;">,</span>aes<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/cut"><span style="color: #003399;">cut</span></a><span style="color: #339933;">,</span>average<span style="color: #339933;">,</span>fill=clarity<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br />p + geom_bar<span style="color: #009900;">(</span>position=<span style="color: blue;">'dodge'</span><span style="color: #009900;">)</span></span></pre><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://thumbsnap.com/i/WfjcpGSW.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="266" src="http://thumbsnap.com/i/WfjcpGSW.jpg" width="400" /></a></div>除了reshape包以外，R语言中还有<b>stack、unstack、reshape</b>等函数能完成类似的工作，但论功能的强大，还是首推reshape包中的哼哈二将。
