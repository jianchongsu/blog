--- 
layout: post
name: plyrapply
title: "\xE7\x94\xA8plyr\xE5\x8C\x85\xE6\x89\xA9\xE5\xB1\x95apply\xE6\x97\x8F\xE5\x87\xBD\xE6\x95\xB0\xE7\x9A\x84\xE5\x8A\x9F\xE8\x83\xBD"
date: 2012-04-21 08:07:00 +08:00
categories: 
- other
permalink: /2012/04/plyrapply.html
---
<div class="separator" style="clear: both; text-align: center;"><a href="http://thumbsnap.com/i/Fn6hkDSi.jpg" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" src="http://thumbsnap.com/i/Fn6hkDSi.jpg" /></a></div>apply族函数是R语言中很有特色的一类函数，包括了apply、sapply、lapply、tapply、aggregate等等。在这篇<a href="http://xccds1977.blogspot.com/2012/02/r_29.html">博文</a>里对它们进行了简略的说明。这一类函数本质上是将数据进行分割、计算和整合。它们在数据分析的各个阶段都有很好的用处。例如在数据准备阶段，我们可以按某个标准将数据分组，然后获得各组的统计描述。或是在建模阶段，为不同组的数据建立模型并比较建模结果。apply族函数与Google提出的mapreduce策略有着一致的思路。因为mapreduce的思路也是将数据进行分割、计算和整合。只不过它是将分割后的数据分发给多个处理核心进行运算。如果你熟悉了apply族函数，那么将数据转为并行运算是轻而易举的事情。plyr包则可看作是apply族函数的扩展，使之更容易运用，功能更为强大。<br /><br />plyr包的主函数是**ply形式的，其中首字母可以是(d、l、a)，第二个字母可以是 (d、l、a、_)，不同的字母表示不同的数据格式，d表示数据框格式，l表示列表，a表示数组，_则表示没有输出。第一个字母表示输入的待处理的数据格式，第二个字母表示输出的数据格式。例如ddply函数，即表示输入一个数据框，输出也是一个数据框。<br /><br /><a name='more'></a><br />下面首先来用一个简单的例子说明一下用法。还是用iris数据集，其中包括了一个分类变量和四个数值变量。我们希望数据按不同类别，分别计算数值变量的均值。下面我们分别用三种方法来得到同样的结果。<br /><br /><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/plyr">plyr</a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;">library</span></a><span style="color: #009900;">(</span>reshape2<span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 用aggregate函数进行数据汇总</span><br /><a href="http://inside-r.org/r-doc/stats/aggregate"><span style="color: #003399;">aggregate</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/datasets/iris"><span style="color: #003399;">iris</span></a><span style="color: #009900;">[</span><span style="color: #cc66cc;">1</span>:<span style="color: #cc66cc;">4</span><span style="color: #009900;">]</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/list"><span style="color: #003399;">list</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/datasets/iris"><span style="color: #003399;">iris</span></a>$Species<span style="color: #009900;">)</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/mean"><span style="color: #003399;">mean</span></a><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 用reshape2包进行数据汇总</span><br />data.melt &lt;- melt<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/datasets/iris"><span style="color: #003399;">iris</span></a><span style="color: #339933;">,</span>id=<a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><span style="color: blue;">'Species'</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><br />dcast<span style="color: #009900;">(</span>data.melt<span style="color: #339933;">,</span>Species~variable<span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/mean"><span style="color: #003399;">mean</span></a><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 用ddply函数进行数据汇总</span><br />ddply<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/datasets/iris"><span style="color: #003399;">iris</span></a><span style="color: #339933;">,</span>.<span style="color: #009900;">(</span>Species<span style="color: #009900;">)</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399;">function</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/df"><span style="color: #003399;">df</span></a><span style="color: #009900;">)</span> <a href="http://inside-r.org/r-doc/base/mean"><span style="color: #003399;">mean</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/df"><span style="color: #003399;">df</span></a><span style="color: #009900;">[</span><span style="color: #cc66cc;">1</span>:<span style="color: #cc66cc;">4</span><span style="color: #009900;">]</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span></span></pre><br />初看起来plyr包所具备的功能并不很出彩，下面我们看一个略为复杂例子。还是用iris数据，我们希望对每一种花做一个简单回归。<br /><br /><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><span style="color: #666666; font-style: italic;"># 首先定义回归函数</span><br />model &lt;- <a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399;">function</span></a><span style="color: #009900;">(</span>x<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />    <a href="http://inside-r.org/r-doc/stats/lm"><span style="color: #003399;">lm</span></a><span style="color: #009900;">(</span>Petal.Length~Petal.Width<span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>=x<span style="color: #009900;">)</span><br /><span style="color: #009900;">}</span><br /><span style="color: #666666; font-style: italic;"># 如果用普通的函数则需要如下的分割、计算、整合三个步骤共四条命令</span><br />pieces &lt;- <a href="http://inside-r.org/r-doc/base/split"><span style="color: #003399;">split</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/datasets/iris"><span style="color: #003399;">iris</span></a><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/list"><span style="color: #003399;">list</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/datasets/iris"><span style="color: #003399;">iris</span></a>$Species<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br />models &lt;- <a href="http://inside-r.org/r-doc/base/lapply"><span style="color: #003399;">lapply</span></a><span style="color: #009900;">(</span>pieces<span style="color: #339933;">,</span>model<span style="color: #009900;">)</span><br />result &lt;- <a href="http://inside-r.org/r-doc/base/lapply"><span style="color: #003399;">lapply</span></a><span style="color: #009900;">(</span>models<span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/stats/coef"><span style="color: #003399;">coef</span></a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/do.call"><span style="color: #003399;">do.call</span></a><span style="color: #009900;">(</span><span style="color: blue;">'rbind'</span><span style="color: #339933;">,</span>result<span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 用plyr包只用下面两个函数，每个函数都内置了分割、计算、整合的功能。</span><br />result1 &lt;- dlply<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/datasets/iris"><span style="color: #003399;">iris</span></a><span style="color: #339933;">,</span>.<span style="color: #009900;">(</span>Species<span style="color: #009900;">)</span><span style="color: #339933;">,</span>model<span style="color: #009900;">)</span><br />result2 &lt;- ldply<span style="color: #009900;">(</span>result1<span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399;">function</span></a><span style="color: #009900;">(</span>x<span style="color: #009900;">)</span> <a href="http://inside-r.org/r-doc/stats/coef"><span style="color: #003399;">coef</span></a><span style="color: #009900;">(</span>x<span style="color: #009900;">)</span><span style="color: #009900;">)</span></span></pre><br />plyr包中还有两个比较特别的函数，分别是r*ply和m*ply，它们分别对应的是replicate和mapply函数。<br /><br /><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><a href="http://inside-r.org/r-doc/base/replicate"><span style="color: #003399;">replicate</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">20</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/mean"><span style="color: #003399;">mean</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/runif"><span style="color: #003399;">runif</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">100</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><br />rdply<span style="color: #009900;">(</span><span style="color: #cc66cc;">20</span><span style="color: #339933;">,</span> <a href="http://inside-r.org/r-doc/base/mean"><span style="color: #003399;">mean</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/runif"><span style="color: #003399;">runif</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">100</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/mapply"><span style="color: #003399;">mapply</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/rnorm"><span style="color: #003399;">rnorm</span></a><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/mean"><span style="color: #003399;">mean</span></a>=<span style="color: #cc66cc;">1</span>:<span style="color: #cc66cc;">5</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/stats/sd"><span style="color: #003399;">sd</span></a>=<span style="color: #cc66cc;">1</span>:<span style="color: #cc66cc;">5</span><span style="color: #339933;">,</span> n=<span style="color: #cc66cc;">2</span><span style="color: #009900;">)</span><br />mdply<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/data.frame"><span style="color: #003399;">data.frame</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/mean"><span style="color: #003399;">mean</span></a> = <span style="color: #cc66cc;">1</span>:<span style="color: #cc66cc;">5</span><span style="color: #339933;">,</span> <a href="http://inside-r.org/r-doc/stats/sd"><span style="color: #003399;">sd</span></a> = <span style="color: #cc66cc;">1</span>:<span style="color: #cc66cc;">5</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span> <a href="http://inside-r.org/r-doc/stats/rnorm"><span style="color: #003399;">rnorm</span></a><span style="color: #339933;">,</span> n = <span style="color: #cc66cc;">2</span><span style="color: #009900;">)</span></span></pre><br />最后我们来看一个mdply函数的应用，我们希望用神经网络包来为不同的花进行分类，使用BP神经网络需要的一个参数就是隐藏层神经元的个数。我们来尝试用1到10这十个参数运行模型十次，并观察十个建模结果的预测准确率。但我们并不需要手动运行十次。而是使用mdply函数来完成这个任务。<br /><br /><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/nnet/nnet"><span style="color: #003399;">nnet</span></a><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 确定建模函数</span><br />nnet.m &lt;- <a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399;">function</span></a><span style="color: #009900;">(</span>...<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />  <a href="http://inside-r.org/r-doc/nnet/nnet"><span style="color: #003399;">nnet</span></a><span style="color: #009900;">(</span>Species~.<span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>=<a href="http://inside-r.org/r-doc/datasets/iris"><span style="color: #003399;">iris</span></a><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/trace"><span style="color: #003399;">trace</span></a>=F<span style="color: #339933;">,</span>...<span style="color: #009900;">)</span><br /><span style="color: #009900;">}</span><br /><span style="color: #666666; font-style: italic;"># 确定输入参数</span><br />opts &lt;- <a href="http://inside-r.org/r-doc/base/data.frame"><span style="color: #003399;">data.frame</span></a><span style="color: #009900;">(</span>size=<span style="color: #cc66cc;">1</span>:<span style="color: #cc66cc;">10</span><span style="color: #339933;">,</span>maxiter=<span style="color: #cc66cc;">50</span><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 建立预测准确率的函数</span><br /><a href="http://inside-r.org/packages/cran/accuracy">accuracy</a> &lt;- <a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399;">function</span></a><span style="color: #009900;">(</span>mod<span style="color: #339933;">,</span>true<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />  pred &lt;- <a href="http://inside-r.org/r-doc/base/factor"><span style="color: #003399;">factor</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/predict"><span style="color: #003399;">predict</span></a><span style="color: #009900;">(</span>mod<span style="color: #339933;">,</span>type=<span style="color: blue;">'class'</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/levels"><span style="color: #003399;">levels</span></a>=<a href="http://inside-r.org/r-doc/base/levels"><span style="color: #003399;">levels</span></a><span style="color: #009900;">(</span>true<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br />  tb &lt;- <a href="http://inside-r.org/r-doc/base/table"><span style="color: #003399;">table</span></a><span style="color: #009900;">(</span>pred<span style="color: #339933;">,</span>true<span style="color: #009900;">)</span><br />  <a href="http://inside-r.org/r-doc/base/sum"><span style="color: #003399;">sum</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/diag"><span style="color: #003399;">diag</span></a><span style="color: #009900;">(</span>tb<span style="color: #009900;">)</span><span style="color: #009900;">)</span>/sum<span style="color: #009900;">(</span>tb<span style="color: #009900;">)</span><br /><span style="color: #009900;">}</span><br /><span style="color: #666666; font-style: italic;"># 用mlply函数建立包括10个元素的列表，每个元素包括了一个建模结果</span><br />models &lt;- mlply<span style="color: #009900;">(</span>opts<span style="color: #339933;">,</span>nnet.m<span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 再用ldply函数读取列表，计算后得到最终结果</span><br />ldply<span style="color: #009900;">(</span>models<span style="color: #339933;">,</span><span style="color: blue;">'accuracy'</span><span style="color: #339933;">,</span>true=<a href="http://inside-r.org/r-doc/datasets/iris"><span style="color: #003399;">iris</span></a>$Species<span style="color: #009900;">)</span></span></pre><br /><b>参考资料：</b><br /><a href="http://plyr.had.co.nz/09-user/">http://plyr.had.co.nz/09-user/</a><br /><a href="http://www.jstatsoft.org/v40/i01/paper">http://www.jstatsoft.org/v40/i01/paper</a><br /><br /><br />
