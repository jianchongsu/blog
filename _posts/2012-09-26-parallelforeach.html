--- 
layout: post
name: parallelforeach
title: "\xE7\x94\xA8Parallel\xE5\x92\x8Cforeach\xE5\x8C\x85\xE7\x8E\xA9\xE8\xBD\xAC\xE5\xB9\xB6\xE8\xA1\x8C\xE8\xAE\xA1\xE7\xAE\x97"
date: 2012-09-26 10:07:00 +08:00
categories: 
- "\xE5\xB9\xB6\xE8\xA1\x8C\xE8\xAE\xA1\xE7\xAE\x97"
- "\xE9\x9A\x8F\xE6\x9C\xBA\xE6\xA3\xAE\xE6\x9E\x97"
permalink: /2012/09/parallelforeach.html
---
<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-17whRDAaHBo/UGJgxGei0nI/AAAAAAAABMw/jCqLCLmaYU8/s1600/lrg.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="320" src="http://4.bp.blogspot.com/-17whRDAaHBo/UGJgxGei0nI/AAAAAAAABMw/jCqLCLmaYU8/s320/lrg.jpg" width="243" /></a></div>众所周知，在大数据时代R语言有两个弱项，其中一个就是只能使用单线程计算。但是在2.14版本之后，R就内置了<b>parallel包</b>，强化了R的并行计算能力。parallel包实际上整合了之前已经比较成熟的<b>snow包和multicore包</b>。前者已经在<a href="http://xccds1977.blogspot.com/2012/02/snow.html">之前的文章</a>中介绍过了，而后者无法在windows下运行，所以也就先不管了。parallel包可以很容易的在计算集群上实施并行计算，在多个CPU核心的单机上，也能发挥并行计算的功能。我们今天就来探索一下parallel包在多核心单机上的使用。<br /><br />parallel包的思路和lapply函数很相似，都是将输入数据分割、计算、整合结果。只不过并行计算是用到了不同的cpu来运算。下面的例子是解决欧拉问题的<a href="http://projecteuler.net/problem=14">第14个问题</a>。<br /><a name='more'></a><br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R" style="font-family: monospace;"><span style="color: #666666; font-style: italic;"># 并行计算euler14问题</span><br /><span style="color: #666666; font-style: italic;"># 自定义函数以返回原始数值和步数</span><br />func &lt;- <a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399; font-weight: bold;">function</span></a><span style="color: #009900;">(</span>x<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />    n = <span style="color: #cc66cc;">1</span><br />    <a href="http://inside-r.org/r-doc/base/raw"><span style="color: #003399; font-weight: bold;">raw</span></a> &lt;- x<br />    <span style="color: black; font-weight: bold;">while</span> <span style="color: #009900;">(</span>x &gt; <span style="color: #cc66cc;">1</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />        x &lt;- <a href="http://inside-r.org/r-doc/base/ifelse"><span style="color: #003399; font-weight: bold;">ifelse</span></a><span style="color: #009900;">(</span>x%%2==<span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span>x/<span style="color: #cc66cc;">2</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">3</span>*x+<span style="color: #cc66cc;">1</span><span style="color: #009900;">)</span><br />        n = n + <span style="color: #cc66cc;">1</span><br />    <span style="color: #009900;">}</span><br />    <a href="http://inside-r.org/r-doc/base/return"><span style="color: #003399; font-weight: bold;">return</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399; font-weight: bold;">c</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/raw"><span style="color: #003399; font-weight: bold;">raw</span></a><span style="color: #339933;">,</span>n<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br /><span style="color: #009900;">}</span><br />&nbsp;<br /><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399; font-weight: bold;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/lattice/parallel"><span style="color: #003399; font-weight: bold;">parallel</span></a><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 用system.time来返回计算所需时间</span><br /><a href="http://inside-r.org/r-doc/base/system.time"><span style="color: #003399; font-weight: bold;">system.time</span></a><span style="color: #009900;">(</span><span style="color: #009900;">{</span><br />    x &lt;- <span style="color: #cc66cc;">1</span>:1e6<br />    cl &lt;- makeCluster<span style="color: #009900;">(</span><span style="color: #cc66cc;">4</span><span style="color: #009900;">)</span>  <span style="color: #666666; font-style: italic;"># 初始化四核心集群</span><br />    results &lt;- parLapply<span style="color: #009900;">(</span>cl<span style="color: #339933;">,</span>x<span style="color: #339933;">,</span>func<span style="color: #009900;">)</span> <span style="color: #666666; font-style: italic;"># lapply的并行版本</span><br />    res.df &lt;- <a href="http://inside-r.org/r-doc/base/do.call"><span style="color: #003399; font-weight: bold;">do.call</span></a><span style="color: #009900;">(</span><span style="color: blue;">'rbind'</span><span style="color: #339933;">,</span>results<span style="color: #009900;">)</span> <span style="color: #666666; font-style: italic;"># 整合结果</span><br />    stopCluster<span style="color: #009900;">(</span>cl<span style="color: #009900;">)</span> <span style="color: #666666; font-style: italic;"># 关闭集群</span><br /><span style="color: #009900;">}</span><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 找到最大的步数对应的数字</span><br />res.df<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/which.max"><span style="color: #003399; font-weight: bold;">which.max</span></a><span style="color: #009900;">(</span>res.df<span style="color: #009900;">[</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">]</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">]</span><br />&nbsp;<br /></pre></div></div>上例中关键的函数就是parLapply，其中三个参数分别是集群对象、输入参数和运算函数名。我们最后算出的结果是837799。<br /><br /><b>foreach包</b>是revolutionanalytics公司贡献给R开源社区的一个包。它能使R中的并行计算更为方便。与sapply函数类似，foreach函数中的第一个参数是输入参数，%do%后面的对象表示运算函数，而.combine则表示运算结果的整合方式。 下面的例子即是用foreach来完成前面的同一个任务。如果要启用并行，则需要加载doParallel包，并将%do%改为%dopar%。这样一行代码就能方便的完成并行计算了。<br /><br /><pre class="r geshifilter-R"><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399; font-weight: bold;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/foreach">foreach</a><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 非并行计算方式，类似于sapply函数的功能</span><br />x &lt;- <a href="http://inside-r.org/packages/cran/foreach">foreach</a><span style="color: #009900;">(</span>x=<span style="color: #cc66cc;">1</span>:<span style="color: #cc66cc;">1000</span><span style="color: #339933;">,</span>.combine=<span style="color: blue;">'rbind'</span><span style="color: #009900;">)</span> %do% func<span style="color: #009900;">(</span>x<span style="color: #009900;">)</span><br />&nbsp;<br /><span style="color: #666666; font-style: italic;"># 启用parallel作为foreach并行计算的后端</span><br /><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399; font-weight: bold;">library</span></a><span style="color: #009900;">(</span>doParallel<span style="color: #009900;">)</span><br />cl &lt;- makeCluster<span style="color: #009900;">(</span><span style="color: #cc66cc;">4</span><span style="color: #009900;">)</span><br />registerDoParallel<span style="color: #009900;">(</span>cl<span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 并行计算方式</span><br />x &lt;- <a href="http://inside-r.org/packages/cran/foreach">foreach</a><span style="color: #009900;">(</span>x=<span style="color: #cc66cc;">1</span>:<span style="color: #cc66cc;">1000</span><span style="color: #339933;">,</span>.combine=<span style="color: blue;">'rbind'</span><span style="color: #009900;">)</span> %dopar% func<span style="color: #009900;">(</span>x<span style="color: #009900;">)</span><br />stopCluster<span style="color: #009900;">(</span>cl<span style="color: #009900;">)</span></pre><br />下面的例子是用foreach函数来进行随机森林的并行计算。我们一共要生成十万个树来组合成一个随机森林，每个核心负责生成两万五千个树。最后用combine进行组合。<br /><br /><pre class="r geshifilter-R"><span style="color: #666666; font-style: italic;"># 随机森林的并行计算</span><br /><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399; font-weight: bold;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/randomForest">randomForest</a><span style="color: #009900;">)</span><br /> cl &lt;- makeCluster<span style="color: #009900;">(</span><span style="color: #cc66cc;">4</span><span style="color: #009900;">)</span><br /> registerDoParallel<span style="color: #009900;">(</span>cl<span style="color: #009900;">)</span><br /> <a href="http://inside-r.org/r-doc/stats/rf"><span style="color: #003399; font-weight: bold;">rf</span></a> &lt;- <a href="http://inside-r.org/packages/cran/foreach">foreach</a><span style="color: #009900;">(</span>ntree=<a href="http://inside-r.org/r-doc/base/rep"><span style="color: #003399; font-weight: bold;">rep</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">25000</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">4</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span> <br />                  .combine=combine<span style="color: #339933;">,</span><br />                  <a href="http://inside-r.org/r-doc/base/.packages"><span style="color: #003399; font-weight: bold;">.packages</span></a>=<span style="color: blue;">'randomForest'</span><span style="color: #009900;">)</span> %dopar%<br />          <a href="http://inside-r.org/packages/cran/randomForest">randomForest</a><span style="color: #009900;">(</span>Species~.<span style="color: #339933;">,</span> <a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399; font-weight: bold;">data</span></a>=<a href="http://inside-r.org/r-doc/datasets/iris"><span style="color: #003399; font-weight: bold;">iris</span></a><span style="color: #339933;">,</span> ntree=ntree<span style="color: #009900;">)</span><br />stopCluster<span style="color: #009900;">(</span>cl<span style="color: #009900;">)</span></pre><br />并行不仅可以在建模时进行，也可以在数据整理阶段进行。之前我们提到过的plyr包也可以进行并行，前提是加载了foreach包，并且参数.parallel设置为TURE。当然不是所有的任务都能并行计算，而且并行计算前你需要改写你的代码。<br /><br />参考资料：<br /><a href="http://stat.ethz.ch/R-manual/R-devel/library/parallel/doc/parallel.pdf">http://stat.ethz.ch/R-manual/R-devel/library/parallel/doc/parallel.pdf</a><br /><a href="http://cran.r-project.org/web/packages/foreach/vignettes/foreach.pdf">http://cran.r-project.org/web/packages/foreach/vignettes/foreach.pdf</a><br /><a href="http://cran.r-project.org/web/packages/doParallel/vignettes/gettingstartedParallel.pdf">http://cran.r-project.org/web/packages/doParallel/vignettes/gettingstartedParallel.pdf</a>
