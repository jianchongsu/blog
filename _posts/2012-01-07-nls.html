--- 
layout: post
name: nls
title: "\xE7\x94\xA8nls\xE5\x87\xBD\xE6\x95\xB0\xE8\xBF\x9B\xE8\xA1\x8C\xE9\x9D\x9E\xE7\xBA\xBF\xE6\x80\xA7\xE5\x9B\x9E\xE5\xBD\x92"
date: 2012-01-07 20:21:00 +08:00
categories: 
- "\xE9\x9D\x9E\xE7\xBA\xBF\xE6\x80\xA7\xE5\x9B\x9E\xE5\xBD\x92"
permalink: /2012/01/nls.html
---
在许多实际问题中，回归模型中响应变量和预测变量之间的关系可能是复杂的非线性函数。有时候能通过变量变换的方法可以将其变为线性模型，有时则不能。在后一种情况下，就需要采取专门的非线性回归方法来建立模型。<br /><br />非线性回归是在对变量的非线性关系有一定认识前提下，对非线性函数的参数进行最优化的过程，最优化后的参数会使得模型的RSS（残差平方和）达到最小。在R语言中最为常用的非线性回归建模函数是nls，下面以car包中的USPop数据集为例来讲解其用法。数据中population表示人口数，year表示年份。如果将二者绘制散点图可以发现它们之间的非线性关系。在建立非线性回归模型时需要事先确定两件事，一个是非线性函数形式，另一个是参数初始值。<br /><a name='more'></a><br /><br /><b><span style="font-size: large;">一、模型拟合</span></b><br />对于人口模型可以采用Logistic增长函数形式，它考虑了初期的指数增长以及总资源的限制。其函数形式如下。<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-QiaIA-JtHBE/Twg2qeO_74I/AAAAAAAAApU/zPNgl_JZNfQ/s1600/function.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-QiaIA-JtHBE/Twg2qeO_74I/AAAAAAAAApU/zPNgl_JZNfQ/s1600/function.JPG" /></a></div><br />首先载入car包以便读取数据，然后使用nls函数进行建模，其中theta1、theta2、theta3表示三个待估计参数，start设置了参数初始值，设定trace为真以显示迭代过程。nls函数默认采用Gauss-Newton方法寻找极值，迭代过程中第一列为RSS值，后面三列是各参数估计值。然后用summary返回回归结果。<br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/car">car</a><span style="color: #009900;">)</span><br />pop.mod1 &lt;- <a href="http://inside-r.org/r-doc/stats/nls"><span style="color: #003399;">nls</span></a><span style="color: #009900;">(</span>population ~ theta1/<span style="color: #009900;">(</span><span style="color: #cc66cc;">1</span>+<a href="http://inside-r.org/r-doc/base/exp"><span style="color: #003399;">exp</span></a><span style="color: #009900;">(</span>-<span style="color: #009900;">(</span>theta2+theta3*year<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/stats/start"><span style="color: #003399;">start</span></a>=<a href="http://inside-r.org/r-doc/base/list"><span style="color: #003399;">list</span></a><span style="color: #009900;">(</span>theta1 = <span style="color: #cc66cc;">400</span><span style="color: #339933;">,</span> theta2 = -<span style="color: #cc66cc;">49</span><span style="color: #339933;">,</span> theta3 = <span style="color: #cc66cc;">0.025</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span> <a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>=USPop<span style="color: #339933;">,</span> <a href="http://inside-r.org/r-doc/base/trace"><span style="color: #003399;">trace</span></a>=T<span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/summary"><span style="color: #003399;">summary</span></a><span style="color: #009900;">(</span>pop.mod<span style="color: #009900;">)</span><br /></span></pre></div></div>在上面的回归过程中我们直接指定参数初始值，另一种方法是采用搜索策略，首先确定参数取值范围，然后利用nls2包的暴力方法来得到最优参数。但这种方法相当费时。<br /><br />还有一种更为简便的方法就是采用内置自启动模型(self-starting Models)，此时我们只需要指定函数形式，而不需要指定参数初始值。本例的logistic函数所对应的selfstarting函数名为SSlogis<br /><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;">pop.mod2 &lt;- <a href="http://inside-r.org/r-doc/stats/nls"><span style="color: #003399;">nls</span></a><span style="color: #009900;">(</span>population ~ <a href="http://inside-r.org/r-doc/stats/SSlogis"><span style="color: #003399;">SSlogis</span></a><span style="color: #009900;">(</span>year<span style="color: #339933;">,</span>phi1<span style="color: #339933;">,</span>phi2<span style="color: #339933;">,</span>phi3<span style="color: #009900;">)</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>=USPop<span style="color: #009900;">)</span></span></pre><b><span style="font-size: large;">二、判断拟合效果</span></b><br />非线性回归模型建立后需要判断拟合效果，因为有时候参数最优化过程会捕捉到局部极值点而非全局极值点。最直观的方法是在原始数据点上绘制拟合曲线。<br /><a href="http://inside-r.org/r-doc/base/library" style="font-family: 'Courier New', Courier, monospace;"><span style="color: #003399;">library</span></a><span style="color: #009900; font-family: 'Courier New', Courier, monospace;">(</span><a href="http://inside-r.org/packages/cran/ggplot2" style="font-family: 'Courier New', Courier, monospace;">ggplot2</a><span style="color: #009900; font-family: 'Courier New', Courier, monospace;">)</span><br /><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;">p &lt;- <a href="http://inside-r.org/packages/cran/ggplot">ggplot</a><span style="color: #009900;">(</span>USPop<span style="color: #339933;">,</span>aes<span style="color: #009900;">(</span>year<span style="color: #339933;">,</span> population<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br />p+geom_point<span style="color: #009900;">(</span>size=<span style="color: #cc66cc;">3</span><span style="color: #009900;">)</span>+geom_line<span style="color: #009900;">(</span>aes<span style="color: #009900;">(</span>year<span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/stats/fitted"><span style="color: #003399;">fitted</span></a><span style="color: #009900;">(</span>pop.mod1<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/col"><span style="color: #003399;">col</span></a>=<span style="color: blue;">'red'</span><span style="color: #009900;">)</span></span><a href="http://3.bp.blogspot.com/-JK1ClxVTvEg/Twg2xUymC6I/AAAAAAAAApc/A0a5D9KoPas/s1600/Rplot01.jpeg" imageanchor="1" style="margin-left: 1em; margin-right: 1em; text-align: center;"><img border="0" src="http://3.bp.blogspot.com/-JK1ClxVTvEg/Twg2xUymC6I/AAAAAAAAApc/A0a5D9KoPas/s1600/Rplot01.jpeg" /></a></pre><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><span style="color: #009900;"><br /></span></span></pre>若比较多个模型的拟合效果可使用AIC函数，取最小值为佳。<br /><br /><b><span style="font-size: large;">三、残差诊断</span></b><br />和线性回归类似，非线性回归假设误差是正态、独立和同方差性。为了检测这些假设是否成立我们用拟合模型的残差来代替误差进行判断。<br /><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><a href="http://inside-r.org/r-doc/graphics/plot"><span style="color: #003399;">plot</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/fitted"><span style="color: #003399;">fitted</span></a><span style="color: #009900;">(</span>pop.mod1<span style="color: #009900;">)</span> <span style="color: #339933;">,</span> <a href="http://inside-r.org/r-doc/stats/resid"><span style="color: #003399;">resid</span></a><span style="color: #009900;">(</span>pop.mod1<span style="color: #009900;">)</span><span style="color: #339933;">,</span>type=<span style="color: blue;">'b'</span><span style="color: #009900;">)</span></span></pre>同方差假设采用残差绝对值和拟合值的散点图判断，或是使用bartlett.test函数检测。正态性检测除了画QQ图外还可用shapiro.test函数。独立性检验则可以绘制滞后残差图或是使用acf函数。<br /><br />其它可以使用的泛型函数还包括了anova、coef、confint、deviance、fitted、plot、predict、vcov。如果预测变量中包括了分类数据，这种情况下可利用nlme包中的nlsList函数进行非线性回归。nlstools包中也有许多对非线性回归有用的函数。<br /><br />参考资料：Nonlinear Regression with R (use R)
