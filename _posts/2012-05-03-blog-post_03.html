--- 
layout: post
name: blog-post_03
title: "\xE6\x97\xA5\xE5\x8E\x86\xE4\xB8\xAD\xE7\x9A\x84\xE5\xA4\x8F\xE5\xA4\xA9"
date: 2012-05-03 21:54:00 +08:00
categories: 
- ggplot2
- "\xE5\x8F\xAF\xE8\xA7\x86\xE5\x8C\x96"
- "\xE6\x95\xB0\xE6\x8D\xAE\xE5\xAF\xBC\xE5\x85\xA5"
permalink: /2012/05/blog-post_03.html
---
<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-di0E4x2GyiQ/T6KE66A9IBI/AAAAAAAAA2U/FWNLhnKXEQY/s1600/images.jpg" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-di0E4x2GyiQ/T6KE66A9IBI/AAAAAAAAA2U/FWNLhnKXEQY/s1600/images.jpg" /></a></div><b style="color: #999999;">看着有节，摸着无节--打一生活用品</b><br /><br />不知不觉，夏日已慢慢临近。姑娘们飞扬的裙角，小贩叫卖的西瓜，蚊蝇嗡嗡的声音，以及翻过的一页日历，都提醒着你--夏天快来了。夏季有着不同的定义，根据中国人的日历，我们所俗称的夏季从“立夏”开始，到“立秋”结束。在气候学上，若连续五天平均温度超过22度，则算作夏季的开始，若五天平均温度低于22度则算作入秋。而天文学上的夏季一般是指6、7、8三个月。<br /><br />我们想知道：哪一种夏季的定义更合乎我们的感觉？还是用数据可视化来说话吧。这项任务基本上有两个步骤，一是获取某城市的2011年日平均温度数据，二是根据数据绘制<b>日历热图（Calendar Heatmap）</b>。<br /><br /><a name='more'></a><br />本文所采用的数据源是<a href="http://www.wunderground.com/weather/api/d/documentation.html">Wunderground</a>提供的API。该API所提供的数据极为丰富，除了历史温度数据外，还有湿度、风向等大量信息可以利用，所以它被<a href="http://xccds1977.blogspot.com/2012/04/30.html">数据源手册所</a>推荐。为了使用这个API我们先申请一个免费帐户，然后利用R语言中的RJSONIO包来解析所得到的天气数据。使用这个API要注意的是，其免费帐户每分钟限制10次调用，超出会中断连接。不知道别人怎么弄的，本人的笨办法是在程序中增加了暂停。这样就获得了365个日平均温度。<br /><br />日历热图是一种有趣的工具，它可以在日历表中显示时间序列数据的变化。在2009年的<a href="http://blog.revolutionanalytics.com/2009/09/analysis-of-airline-performance.html">The Data Expo</a>中，获奖团队就是利用了SAS来生成日历热图。多才多艺的R语言当然也可以做到。在《R Graphs Cookbook》这本书中就提到了绘制日历热图的方法，第一种方法是Paul Bleicher所写的一个<a href="http://blog.revolution-computing.com/downloads/calendarHeat.R">函数</a>，它是基于grid,lattice,chron这三个扩展包来编写的。第二种方法是使用openair扩展包中的calendarPlot函数。生成的图形就象下面这个样子。<br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-GzExqldaagE/T6KGh6-QTmI/AAAAAAAAA2k/OK3p76XON04/s1600/Rplot01.jpeg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-GzExqldaagE/T6KGh6-QTmI/AAAAAAAAA2k/OK3p76XON04/s1600/Rplot01.jpeg" /></a></div>看起来不错，但是我们还没完。我们希望挑选出平均温度在22度以上的日子，突出显示出来。所以我们采用第三种方法，用ggplot2包来绘制日历热图，下面的图形参考了MarginTale的<a href="http://margintale.blogspot.com/2012/04/ggplot2-time-series-heatmaps.html">这篇文章</a>。<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-e8KlGNZi63g/T6KGrx_L8wI/AAAAAAAAA2s/JGO-Mqhtzmo/s1600/Rplot.jpeg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-e8KlGNZi63g/T6KGrx_L8wI/AAAAAAAAA2s/JGO-Mqhtzmo/s1600/Rplot.jpeg" /></a></div>上图中数日子是竖着来数的，横轴表示每月的第几周，纵轴表示星期几。灰色部分表示当天平均温度在22度以下，有色彩的区块表示在22度以上。颜色越偏黄则表示温度越高。在2011年，立夏的时间是5月6日，立秋是8月8日，但可以观察到立秋之后仍有很多时间温度在22度以上。这就是我们所俗称的“秋老虎”。如果按照气候学的定义来看，四月末就出现了连续五天的高温，所以夏天应该在四月末就开始了，一直延续到十月初结束。而天文学上的夏季则是六、七、八三个月，这三个月基本上全是22度以上。看起来天文学的夏季是比较符合我们人体的感觉的。其它的要么偏短，要么偏长。<br /><br />写到这里，想起了梁静茹的一首歌：<br />宁静的夏天<br />天空中繁星点点<br />心里头有些思念<br />思念着你的脸<br />我可以假装看不见<br />也可以偷偷的想念<br />直到让我摸到你那温暖的脸<br /><br />（最后要说的是，本人不是气象专家，本文也没有考虑到湿度对体感温度的影响等其它因素。主要还是向各位介绍R语言中日历热图的绘制。）<br /><br />R代码<a href="https://gist.github.com/2585753">在此</a>：<br /><script src="https://gist.github.com/2585753.js">  </script>
