--- 
layout: post
name: roc
title: "\xE6\xB5\x85\xE8\xB0\x88ROC\xE6\x9B\xB2\xE7\xBA\xBF"
date: 2013-01-04 22:31:00 +08:00
categories: 
- "\xE6\x9C\xBA\xE5\x99\xA8\xE5\xAD\xA6\xE4\xB9\xA0"
- "ROC\xE5\x9B\xBE"
- "\xE6\x95\xB0\xE6\x8D\xAE\xE6\x8C\x96\xE6\x8E\x98"
permalink: /2013/01/roc.html
---
<div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/--dU5-Js5epQ/UObmkh9dlTI/AAAAAAAABVw/UrId0a9EGak/s1600/Rplot02.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="400" src="http://2.bp.blogspot.com/--dU5-Js5epQ/UObmkh9dlTI/AAAAAAAABVw/UrId0a9EGak/s400/Rplot02.png" width="400" /></a></div>机器学习中很常见的一个大类就是二元分类器。很多二元分类器会产生一个概率预测值，而非仅仅是0-1预测值。我们可以使用某个临界点（例如0.5），以划分哪些预测为1，哪些预测为0。得到二元预测值后，可以构建一个混淆矩阵来评价二元分类器的预测效果。所有的训练数据都会落入这个矩阵中，而对角线上的数字代表了预测正确的数目，即True Positive+True Nagetive。同时可以相应算出TPR（真正率或称为灵敏度）和TNR（真负率或称为特异度）。我们主观上希望这两个指标越大越好，但可惜二者是一个此消彼涨的关系。除了分类器的训练参数，临界点的选择，也会大大的影响TPR和TNR。有时可以根据具体问题和需要，来选择具体的临界点。<br /><br /><br /><a name='more'></a>如果我们选择一系列的临界点，就会得到一系列的TPR和TNR，将这些值对应的点连接起来，就构成了ROC曲线。ROC曲线可以帮助我们清楚的了解到这个分类器的性能表现，还能方便比较不同分类器的性能。在绘制ROC曲线的时候，习惯上是使用1-TNR作为横坐标，TPR作为纵坐标。下面来看看如何在R语言中绘制ROC曲线。<br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R"><span style="color: #666666; font-family: monospace; font-style: italic;"># 做一个logistic回归，生成概率预测值</span><br />model1 <span style="font-family: monospace;">&lt;-</span> <a href="http://inside-r.org/r-doc/stats/glm" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">glm</span></a><span style="color: #009900; font-family: monospace;">(</span>y<span style="font-family: monospace;">~</span>.<span style="color: #339933; font-family: monospace;">,</span> <a href="http://inside-r.org/r-doc/utils/data" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">data</span></a>=newdata<span style="color: #339933; font-family: monospace;">,</span> <a href="http://inside-r.org/r-doc/stats/family" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">family</span></a>=<span style="color: blue; font-family: monospace;">'binomial'</span><span style="color: #009900; font-family: monospace;">)</span><br />pre <span style="font-family: monospace;">&lt;-</span> <a href="http://inside-r.org/r-doc/stats/predict" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">predict</span></a><span style="color: #009900; font-family: monospace;">(</span>model1<span style="color: #339933; font-family: monospace;">,</span>type=<span style="color: blue; font-family: monospace;">'response'</span><span style="color: #009900; font-family: monospace;">)</span><br /><span style="color: #666666; font-family: monospace; font-style: italic;"># 将预测概率prob和实际结果y放在一个数据框中</span><br /><a href="http://inside-r.org/r-doc/utils/data" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">data</span></a> <span style="font-family: monospace;">&lt;-</span> <a href="http://inside-r.org/r-doc/base/data.frame" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">data.frame</span></a><span style="color: #009900; font-family: monospace;">(</span><a href="http://inside-r.org/packages/cran/prob" style="font-family: monospace;">prob</a>=pre<span style="color: #339933; font-family: monospace;">,</span>obs=newdata<span style="font-family: monospace;">$</span>y<span style="color: #009900; font-family: monospace;">)</span><br /><span style="color: #666666; font-family: monospace; font-style: italic;"># 按预测概率从低到高排序</span><br /><a href="http://inside-r.org/r-doc/utils/data" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">data</span></a> <span style="font-family: monospace;">&lt;-</span> <a href="http://inside-r.org/r-doc/utils/data" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">data</span></a><span style="color: #009900; font-family: monospace;">[</span><a href="http://inside-r.org/r-doc/base/order" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">order</span></a><span style="color: #009900; font-family: monospace;">(</span><a href="http://inside-r.org/r-doc/utils/data" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">data</span></a><span style="font-family: monospace;">$</span>prob<span style="color: #009900; font-family: monospace;">)</span><span style="color: #339933; font-family: monospace;">,</span><span style="color: #009900; font-family: monospace;">]</span><br />n <span style="font-family: monospace;">&lt;-</span> <a href="http://inside-r.org/r-doc/base/nrow" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">nrow</span></a><span style="color: #009900; font-family: monospace;">(</span><a href="http://inside-r.org/r-doc/utils/data" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">data</span></a><span style="color: #009900; font-family: monospace;">)</span><br /><a href="http://inside-r.org/packages/cran/tpr" style="font-family: monospace;">tpr</a> <span style="font-family: monospace;">&lt;-</span> fpr <span style="font-family: monospace;">&lt;-</span> <a href="http://inside-r.org/r-doc/base/rep" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">rep</span></a><span style="color: #009900; font-family: monospace;">(</span><span style="color: #cc66cc; font-family: monospace;">0</span><span style="color: #339933; font-family: monospace;">,</span>n<span style="color: #009900; font-family: monospace;">)</span><br /><span style="color: #666666; font-family: monospace; font-style: italic;"># 根据不同的临界值threshold来计算TPR和FPR，之后绘制成图</span><br /><span style="color: black; font-family: monospace; font-weight: bold;">for</span> <span style="color: #009900; font-family: monospace;">(</span>i <span style="color: black; font-family: monospace; font-weight: bold;">in</span> <span style="color: #cc66cc; font-family: monospace;">1</span><span style="font-family: monospace;">:</span>n<span style="color: #009900; font-family: monospace;">)</span> <span style="color: #009900; font-family: monospace;">{</span><br />    threshold <span style="font-family: monospace;">&lt;-</span> <a href="http://inside-r.org/r-doc/utils/data" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">data</span></a><span style="font-family: monospace;">$</span>prob<span style="color: #009900; font-family: monospace;">[</span>i<span style="color: #009900; font-family: monospace;">]</span><br />    tp <span style="font-family: monospace;">&lt;-</span> <a href="http://inside-r.org/r-doc/base/sum" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">sum</span></a><span style="color: #009900; font-family: monospace;">(</span><a href="http://inside-r.org/r-doc/utils/data" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">data</span></a><span style="font-family: monospace;">$</span>prob <span style="font-family: monospace;">&gt;</span> threshold <span style="font-family: monospace;">&amp;</span> <a href="http://inside-r.org/r-doc/utils/data" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">data</span></a><span style="font-family: monospace;">$</span>obs <span style="font-family: monospace;">==</span> <span style="color: #cc66cc; font-family: monospace;">1</span><span style="color: #009900; font-family: monospace;">)</span><br />    fp <span style="font-family: monospace;">&lt;-</span> <a href="http://inside-r.org/r-doc/base/sum" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">sum</span></a><span style="color: #009900; font-family: monospace;">(</span><a href="http://inside-r.org/r-doc/utils/data" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">data</span></a><span style="font-family: monospace;">$</span>prob <span style="font-family: monospace;">&gt;</span> threshold <span style="font-family: monospace;">&amp;</span> <a href="http://inside-r.org/r-doc/utils/data" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">data</span></a><span style="font-family: monospace;">$</span>obs <span style="font-family: monospace;">==</span> <span style="color: #cc66cc; font-family: monospace;">0</span><span style="color: #009900; font-family: monospace;">)</span><br />    tn <span style="font-family: monospace;">&lt;-</span> <a href="http://inside-r.org/r-doc/base/sum" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">sum</span></a><span style="color: #009900; font-family: monospace;">(</span><a href="http://inside-r.org/r-doc/utils/data" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">data</span></a><span style="font-family: monospace;">$</span>prob <span style="font-family: monospace;">&lt;</span> threshold <span style="font-family: monospace;">&amp;</span> <a href="http://inside-r.org/r-doc/utils/data" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">data</span></a><span style="font-family: monospace;">$</span>obs <span style="font-family: monospace;">==</span> <span style="color: #cc66cc; font-family: monospace;">0</span><span style="color: #009900; font-family: monospace;">)</span><br />    fn <span style="font-family: monospace;">&lt;-</span> <a href="http://inside-r.org/r-doc/base/sum" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">sum</span></a><span style="color: #009900; font-family: monospace;">(</span><a href="http://inside-r.org/r-doc/utils/data" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">data</span></a><span style="font-family: monospace;">$</span>prob <span style="font-family: monospace;">&lt;</span> threshold <span style="font-family: monospace;">&amp;</span> <a href="http://inside-r.org/r-doc/utils/data" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">data</span></a><span style="font-family: monospace;">$</span>obs <span style="font-family: monospace;">==</span> <span style="color: #cc66cc; font-family: monospace;">1</span><span style="color: #009900; font-family: monospace;">)</span><br />    <a href="http://inside-r.org/packages/cran/tpr" style="font-family: monospace;">tpr</a><span style="color: #009900; font-family: monospace;">[</span>i<span style="color: #009900; font-family: monospace;">]</span> <span style="font-family: monospace;">&lt;-</span> tp<span style="font-family: monospace;">/</span><span style="color: #009900; font-family: monospace;">(</span>tp<span style="font-family: monospace;">+</span>fn<span style="color: #009900; font-family: monospace;">)</span> <span style="color: #666666; font-family: monospace; font-style: italic;"># 真正率</span><br />    fpr<span style="color: #009900; font-family: monospace;">[</span>i<span style="color: #009900; font-family: monospace;">]</span> <span style="font-family: monospace;">&lt;-</span> fp<span style="font-family: monospace;">/</span><span style="color: #009900; font-family: monospace;">(</span>tn<span style="font-family: monospace;">+</span>fp<span style="color: #009900; font-family: monospace;">)</span> <span style="color: #666666; font-family: monospace; font-style: italic;"># 假正率</span><br /><span style="color: #009900; font-family: monospace;">}</span><br /><a href="http://inside-r.org/r-doc/graphics/plot" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">plot</span></a><span style="color: #009900; font-family: monospace;">(</span>fpr<span style="color: #339933; font-family: monospace;">,</span><a href="http://inside-r.org/packages/cran/tpr" style="font-family: monospace;">tpr</a><span style="color: #339933; font-family: monospace;">,</span>type=<span style="color: blue; font-family: monospace;">'l'</span><span style="color: #009900; font-family: monospace;">)</span><br /><a href="http://inside-r.org/r-doc/graphics/abline" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">abline</span></a><span style="color: #009900; font-family: monospace;">(</span>a=<span style="color: #cc66cc; font-family: monospace;">0</span><span style="color: #339933; font-family: monospace;">,</span>b=<span style="color: #cc66cc; font-family: monospace;">1</span><span style="color: #009900; font-family: monospace;">)</span></pre><pre class="r geshifilter-R"><span style="font-family: 微软雅黑;"><span style="white-space: normal;">R中也有专门用来绘制ROC曲线的包，例如常见的ROCR包，它不仅可以用来画图，还能计算ROC曲线下面积AUC，以评价分类器的综合性能，该数值取0-1之间，越大越好。</span></span><br /><a href="http://inside-r.org/r-doc/base/library" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">library</span></a><span style="color: #009900; font-family: monospace;">(</span><a href="http://inside-r.org/packages/cran/ROCR" style="font-family: monospace;">ROCR</a><span style="color: #009900; font-family: monospace;">)</span><br />pred <span style="font-family: monospace;">&lt;-</span> prediction<span style="color: #009900; font-family: monospace;">(</span>pre<span style="color: #339933; font-family: monospace;">,</span>newdata<span style="font-family: monospace;">$</span>y<span style="color: #009900; font-family: monospace;">)</span><br />performance<span style="color: #009900; font-family: monospace;">(</span>pred<span style="color: #339933; font-family: monospace;">,</span><span style="color: blue; font-family: monospace;">'auc'</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;">@</span>y.values <span style="color: #666666; font-family: monospace; font-style: italic;">#AUC值</span><br />perf <span style="font-family: monospace;">&lt;-</span> performance<span style="color: #009900; font-family: monospace;">(</span>pred<span style="color: #339933; font-family: monospace;">,</span><span style="color: blue; font-family: monospace;">'tpr'</span><span style="color: #339933; font-family: monospace;">,</span><span style="color: blue; font-family: monospace;">'fpr'</span><span style="color: #009900; font-family: monospace;">)</span><br /><a href="http://inside-r.org/r-doc/graphics/plot" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">plot</span></a><span style="color: #009900; font-family: monospace;">(</span>perf<span style="color: #009900; font-family: monospace;">)</span></pre><pre class="r geshifilter-R"><span style="font-family: 微软雅黑;"><span style="white-space: normal;">ROCR包画图函数功能比较单一，笔者比较偏好使用功能更强大的pROC包。它可以方便比较两个分类器，还能自动标注出最优的临界点，图看起来也比较漂亮。</span></span><br /><a href="http://inside-r.org/r-doc/base/library" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">library</span></a><span style="color: #009900; font-family: monospace;">(</span>pROC<span style="color: #009900; font-family: monospace;">)</span><br />modelroc <span style="font-family: monospace;">&lt;-</span> roc<span style="color: #009900; font-family: monospace;">(</span>newdata<span style="font-family: monospace;">$</span>y<span style="color: #339933; font-family: monospace;">,</span>pre<span style="color: #009900; font-family: monospace;">)</span><br /><a href="http://inside-r.org/r-doc/graphics/plot" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">plot</span></a><span style="color: #009900; font-family: monospace;">(</span>modelroc<span style="color: #339933; font-family: monospace;">,</span> print.auc=<span style="color: black; font-family: monospace; font-weight: bold;">TRUE</span><span style="color: #339933; font-family: monospace;">,</span> auc.polygon=<span style="color: black; font-family: monospace; font-weight: bold;">TRUE</span><span style="color: #339933; font-family: monospace;">,</span> <a href="http://inside-r.org/r-doc/graphics/grid" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">grid</span></a>=<a href="http://inside-r.org/r-doc/base/c" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">c</span></a><span style="color: #009900; font-family: monospace;">(</span><span style="color: #cc66cc; font-family: monospace;">0.1</span><span style="color: #339933; font-family: monospace;">,</span> <span style="color: #cc66cc; font-family: monospace;">0.2</span><span style="color: #009900; font-family: monospace;">)</span><span style="color: #339933; font-family: monospace;">,</span><br />     grid.col=<a href="http://inside-r.org/r-doc/base/c" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">c</span></a><span style="color: #009900; font-family: monospace;">(</span><span style="color: blue; font-family: monospace;">"green"</span><span style="color: #339933; font-family: monospace;">,</span> <span style="color: blue; font-family: monospace;">"red"</span><span style="color: #009900; font-family: monospace;">)</span><span style="color: #339933; font-family: monospace;">,</span> max.auc.polygon=<span style="color: black; font-family: monospace; font-weight: bold;">TRUE</span><span style="color: #339933; font-family: monospace;">,</span><br />     auc.polygon.col=<span style="color: blue; font-family: monospace;">"skyblue"</span><span style="color: #339933; font-family: monospace;">,</span> print.thres=<span style="color: black; font-family: monospace; font-weight: bold;">TRUE</span><span style="color: #009900; font-family: monospace;">)</span></pre></div></div><br />
