--- 
layout: post
name: ggplotjpeg
title: "ggplot\xE7\x9A\x84\xE5\x9B\xBE\xE5\xBD\xA2\xE7\xBB\x84\xE5\x90\x88\xE4\xB8\x8E\xE6\xB7\xBB\xE5\x8A\xA0jpeg\xE6\x96\x87\xE6\xA1\xA3\xE7\x9A\x84\xE6\x96\xB9\xE6\xB3\x95"
date: 2012-06-19 09:29:00 +08:00
categories: 
- ggplot2
- "\xE7\xBB\x98\xE5\x9B\xBE"
permalink: /2012/06/ggplotjpeg.html
---
<br />最近有位朋友问了一个关于ggplot2作图的问题。涉及到多个图形组合的问题，所以还是费了一些时间来解决，自己也从中学习了一些新东西。顺手将这个画图的过程扔上来当作一篇博文吧。下图就是最后的结果。画这个图有几个障碍，一个是二维散点的置信椭圆，另一个是一维直方图的边缘显示。解决的方法是用ellipse包来生成置信椭圆数据，并且用gridExtra包来组合多个图形，还要用opts来去除图例标注的显示。<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/--lxrb96L6QU/T9_UiuyP2UI/AAAAAAAAA-o/2AB6fX8SWPg/s1600/Rplot02.jpeg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/--lxrb96L6QU/T9_UiuyP2UI/AAAAAAAAA-o/2AB6fX8SWPg/s1600/Rplot02.jpeg" /></a></div><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><span style="color: #666666; font-style: italic;"><a name='more'></a># 读入数据和加载包</span><br /><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a> &lt;-<a href="http://inside-r.org/r-doc/utils/read.csv"><span style="color: #003399;">read.csv</span></a><span style="color: #009900;">(</span><span style="color: blue;">'d:<span style="color: #000099;">\\</span>data.csv'</span><span style="color: #339933;">,</span>T<span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/ggplot2">ggplot2</a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/ellipse">ellipse</a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;">library</span></a><span style="color: #009900;">(</span>gridExtra<span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/plyr">plyr</a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/ReadImages">ReadImages</a><span style="color: #009900;">)</span><br />&nbsp;<br /><span style="color: #666666; font-style: italic;">#建立一个函数以生成置信椭圆</span><br />generatfun &lt;- <a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399;">function</span></a><span style="color: #009900;">(</span>x<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />    <a href="http://inside-r.org/r-doc/base/as.data.frame"><span style="color: #003399;">as.data.frame</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/with"><span style="color: #003399;">with</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a><span style="color: #339933;">,</span><a href="http://inside-r.org/packages/cran/ellipse">ellipse</a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/cor"><span style="color: #003399;">cor</span></a><span style="color: #009900;">(</span>a<span style="color: #339933;">,</span>b<span style="color: #009900;">)</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/scale"><span style="color: #003399;">scale</span></a>=<a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/sd"><span style="color: #003399;">sd</span></a><span style="color: #009900;">(</span>a<span style="color: #009900;">)</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/stats/sd"><span style="color: #003399;">sd</span></a><span style="color: #009900;">(</span>b<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><br />             level=x<span style="color: #339933;">,</span>centre=<a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/mean"><span style="color: #003399;">mean</span></a><span style="color: #009900;">(</span>a<span style="color: #009900;">)</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/mean"><span style="color: #003399;">mean</span></a><span style="color: #009900;">(</span>b<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">}</span><br /><span style="color: #666666; font-style: italic;"># 根据不同的置信度来生成多个数据框并整合</span><br />i &lt;-  <a href="http://inside-r.org/r-doc/base/seq"><span style="color: #003399;">seq</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">0.1</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">0.9</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/by"><span style="color: #003399;">by</span></a>=<span style="color: #cc66cc;">0.1</span><span style="color: #009900;">)</span><br />data2 &lt;- adply<span style="color: #009900;">(</span>i<span style="color: #339933;">,</span><span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span>generatfun<span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/names"><span style="color: #003399;">names</span></a><span style="color: #009900;">(</span>data2<span style="color: #009900;">)</span> &lt;- <a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><span style="color: blue;">'level'</span><span style="color: #339933;">,</span><span style="color: blue;">'x'</span><span style="color: #339933;">,</span><span style="color: blue;">'y'</span><span style="color: #009900;">)</span><br />&nbsp;<br /><span style="color: #666666; font-style: italic;"># 绘制主图散点图，并将图例去除，这里point层和path层使用了不同的数据集</span><br />scatter &lt;- <a href="http://inside-r.org/packages/cran/ggplot">ggplot</a><span style="color: #009900;">(</span><span style="color: #009900;">)</span> + <br />    geom_point<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>=<a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a><span style="color: #339933;">,</span>aes<span style="color: #009900;">(</span>a<span style="color: #339933;">,</span>b<span style="color: #339933;">,</span><a href="http://inside-r.org/packages/cran/shape">shape</a>=type<span style="color: #009900;">)</span><span style="color: #009900;">)</span>+<br />    geom_path<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>=data2<span style="color: #339933;">,</span>aes<span style="color: #009900;">(</span>x<span style="color: #339933;">,</span>y<span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/grDevices/group"><span style="color: #003399;">group</span></a>=level<span style="color: #009900;">)</span><span style="color: #009900;">)</span>+<br />    opts<span style="color: #009900;">(</span>legend.position = <span style="color: blue;">"none"</span><span style="color: #009900;">)</span>+<br />    geom_vline<span style="color: #009900;">(</span>xintercept = <a href="http://inside-r.org/r-doc/base/mean"><span style="color: #003399;">mean</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>$a<span style="color: #009900;">)</span><span style="color: #339933;">,</span>linetype=<span style="color: #cc66cc;">2</span><span style="color: #009900;">)</span>+<br />    geom_hline<span style="color: #009900;">(</span>yintercept = <a href="http://inside-r.org/r-doc/base/mean"><span style="color: #003399;">mean</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>$b<span style="color: #009900;">)</span><span style="color: #339933;">,</span>linetype=<span style="color: #cc66cc;">2</span><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 绘制上边的直方图，并将各种标注去除</span><br />hist_top &lt;- <a href="http://inside-r.org/packages/cran/ggplot">ggplot</a><span style="color: #009900;">(</span><span style="color: #009900;">)</span>+geom_histogram<span style="color: #009900;">(</span>aes<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>$a<span style="color: #009900;">)</span><span style="color: #339933;">,</span>colour=<span style="color: blue;">'black'</span><span style="color: #339933;">,</span>fill=<span style="color: blue;">'gray'</span><span style="color: #339933;">,</span>binwidth = <span style="color: #cc66cc;">0.3</span><span style="color: #009900;">)</span>+<br />    opts<span style="color: #009900;">(</span>panel.background=theme_blank<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><br />         axis.title.x=theme_blank<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span> <br />         axis.title.y=theme_blank<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><br />         axis.text.x=theme_blank<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><br />         axis.text.y=theme_blank<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><br />         axis.ticks=theme_blank<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 同样绘制右边的直方图</span><br />hist_right &lt;- <a href="http://inside-r.org/packages/cran/ggplot">ggplot</a><span style="color: #009900;">(</span><span style="color: #009900;">)</span>+geom_histogram<span style="color: #009900;">(</span>aes<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>$b<span style="color: #009900;">)</span><span style="color: #339933;">,</span>colour=<span style="color: blue;">'black'</span><span style="color: #339933;">,</span>fill=<span style="color: blue;">'gray'</span><span style="color: #339933;">,</span>binwidth = <span style="color: #cc66cc;">0.1</span><span style="color: #009900;">)</span>+<br />    opts<span style="color: #009900;">(</span>panel.background=theme_blank<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><br />         axis.title.x=theme_blank<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span> <br />         axis.title.y=theme_blank<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><br />         axis.text.x=theme_blank<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><br />         axis.text.y=theme_blank<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><br />         axis.ticks=theme_blank<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>+<br />         coord_flip<span style="color: #009900;">(</span><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 要由四个图形组合而成，可以用空白图作为右上角的图形也可以，但为了好玩加上了R的logo，这是一种在ggplot中增加jpeg位图的方法</span><br />logo &lt;-  read.jpeg<span style="color: #009900;">(</span><span style="color: blue;">"d:<span style="color: #000099;">\\</span>Rlogo.jpg"</span><span style="color: #009900;">)</span><br />empty &lt;- <a href="http://inside-r.org/packages/cran/ggplot">ggplot</a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/data.frame"><span style="color: #003399;">data.frame</span></a><span style="color: #009900;">(</span>x=<span style="color: #cc66cc;">1</span>:<span style="color: #cc66cc;">10</span><span style="color: #339933;">,</span>y=<span style="color: #cc66cc;">1</span>:<span style="color: #cc66cc;">10</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span>aes<span style="color: #009900;">(</span>x<span style="color: #339933;">,</span>y<span style="color: #009900;">)</span><span style="color: #009900;">)</span>+<br />    annotation_raster<span style="color: #009900;">(</span>logo<span style="color: #339933;">,</span>-<span style="color: black;">Inf</span><span style="color: #339933;">,</span> <span style="color: black;">Inf</span><span style="color: #339933;">,</span> -<span style="color: black;">Inf</span><span style="color: #339933;">,</span> <span style="color: black;">Inf</span><span style="color: #009900;">)</span>+<br />    opts<span style="color: #009900;">(</span>axis.title.x=theme_blank<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span> <br />         axis.title.y=theme_blank<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><br />         axis.text.x=theme_blank<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><br />         axis.text.y=theme_blank<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><br />         axis.ticks=theme_blank<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 最终的组合</span><br />grid.arrange<span style="color: #009900;">(</span>hist_top<span style="color: #339933;">,</span> empty<span style="color: #339933;">,</span> scatter<span style="color: #339933;">,</span> hist_right<span style="color: #339933;">,</span> <a href="http://inside-r.org/r-doc/base/ncol"><span style="color: #003399;">ncol</span></a>=<span style="color: #cc66cc;">2</span><span style="color: #339933;">,</span> <a href="http://inside-r.org/r-doc/base/nrow"><span style="color: #003399;">nrow</span></a>=<span style="color: #cc66cc;">2</span><span style="color: #339933;">,</span> widths=<a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">4</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span> heights=<a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">4</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span></span></pre></div></div>参考资料：<br /><a href="http://stackoverflow.com/questions/2397097/how-can-a-data-ellipse-be-superimposed-on-a-ggplot2-scatterplot">http://stackoverflow.com/questions/2397097/how-can-a-data-ellipse-be-superimposed-on-a-ggplot2-scatterplot</a><br /><a href="http://stackoverflow.com/questions/8545035/scatterplot-with-marginal-histograms-in-ggplot2">http://stackoverflow.com/questions/8545035/scatterplot-with-marginal-histograms-in-ggplot2</a>
