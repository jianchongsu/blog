--- 
layout: post
name: r_12
title: "\xE5\x9C\xA8R\xE8\xAF\xAD\xE8\xA8\x80\xE4\xB8\xAD\xE4\xBD\xBF\xE7\x94\xA8\xE6\xAD\xA3\xE5\x88\x99\xE8\xA1\xA8\xE8\xBE\xBE\xE5\xBC\x8F"
date: 2012-04-12 07:56:00 +08:00
categories: 
- "\xE6\x95\xB0\xE6\x8D\xAE\xE9\xA2\x84\xE5\xA4\x84\xE7\x90\x86"
permalink: /2012/04/r_12.html
---
<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://thumbsnap.com/i/S9EaY563.jpg" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" src="http://thumbsnap.com/i/S9EaY563.jpg" /></a></div>有时候我们要处理的是非结构化的数据，例如网页或是电邮资料，那么就需要用R来抓取所需的字符串，整理为进一步处理的数据形式。R语言中有一整套可以用来处理字符的函数，在之前的<a href="http://xccds1977.blogspot.com/2012/02/r_28.html">博文</a>中已经有所涉及。但真正的要用好字符处理函数，则不得不用到正则表达式。<b>正则表达式（Regular Expression、regexp）</b>是指一种用来描述一定数量文本的模式。熟练掌握正则表达式能使你随心所欲的操作文本来达成目标。其实学习正则表达式并没有想像中的那么困难。最好方法是从例子开始，然后多练习，多使用。网络上已经有许多不错的参考资料，例如<a href="http://deerchao.net/tutorials/regex/regex.htm">这篇</a>或<a href="http://dragon.cnblogs.com/archive/2006/05/08/394078.html">那篇</a>。本文假设你对正则表达式有了基本的了解，下面我们来看看如何在R里面来使用它。<br /><a name='more'></a><br /><br />假设我们有一个字符向量，包括了三个字符串。我们的目标是从中抽取电邮地址。R语言中很多字符函数都能识别正则表达式，而最重要的函数就是<b>gregexpr()</b>。该函数的第一个参数是正则表达式，前后需要用引号，对元字符进行转义时要用\\。第二个参数是等待处理的文本。那么用如下三行代码，我们从word字符向量中得到一个列表，其中第一项元素中的5表示电邮地址从第5个字符位置开始，24表示电邮地址长度为24。<br /><br /><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;">word &lt;- <a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><span style="color: blue;">'abc noboby@stat.berkeley.edu'</span><span style="color: #339933;">,</span><span style="color: blue;">'text with no email'</span><span style="color: #339933;">,</span><span style="color: blue;">'first me@mything.com also you@yourspace.com'</span><span style="color: #009900;">)</span><br />pattern &lt;- <span style="color: blue;">'[-A-Za-z0-9_.%]+@[-A-Za-z0-9_.%]+<span style="color: #000099;">\\</span>.[A-Za-z]+'</span><br /><span style="color: #009900;">(</span>gregout &lt;- <a href="http://inside-r.org/r-doc/base/gregexpr"><span style="color: #003399;">gregexpr</span></a><span style="color: #009900;">(</span>pattern<span style="color: #339933;">,</span>word<span style="color: #009900;">)</span><span style="color: #009900;">)</span></span></pre><br />[[1]]<br />[1] 5<br />attr(,"match.length")<br />[1] 24<br /><br />[[2]]<br />[1] -1<br />attr(,"match.length")<br />[1] -1<br /><br />[[3]]<br />[1] &nbsp;7 27<br />attr(,"match.length")<br />[1] 14 17<br /><br />下一步我们需要将电邮地址抽取出来，此时配合<b>substr</b>函数，即可根据需要字符串的位置来提取子集。<br /><br /><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><a href="http://inside-r.org/r-doc/base/substr"><span style="color: #003399;">substr</span></a><span style="color: #009900;">(</span>word<span style="color: #009900;">[</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">]</span><span style="color: #339933;">,</span>gregout<span style="color: #009900;">[</span><span style="color: #009900;">[</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">]</span><span style="color: #009900;">]</span><span style="color: #339933;">,</span>gregout<span style="color: #009900;">[</span><span style="color: #009900;">[</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">]</span><span style="color: #009900;">]</span>+<a href="http://inside-r.org/r-doc/base/attr"><span style="color: #003399;">attr</span></a><span style="color: #009900;">(</span>gregout<span style="color: #009900;">[</span><span style="color: #009900;">[</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">]</span><span style="color: #009900;">]</span><span style="color: #339933;">,</span><span style="color: blue;">'match.length'</span><span style="color: #009900;">)</span>-<span style="color: #cc66cc;">1</span><span style="color: #009900;">)</span></span></pre><br />[1] "noboby@stat.berkeley.edu"<br /><br />更方便的使用方式是根据上述方法建立一个自定义函数getcontent，参数s表示待处理的文本，参数g表示的是通过gregexpr函数处理后的结果。这个函数我们在后面还会用到。<br /><br /><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;">getcontent &lt;- <a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399;">function</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/mgcv/s"><span style="color: #003399;">s</span></a><span style="color: #339933;">,</span>g<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />    <a href="http://inside-r.org/r-doc/base/substring"><span style="color: #003399;">substring</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/mgcv/s"><span style="color: #003399;">s</span></a><span style="color: #339933;">,</span>g<span style="color: #339933;">,</span>g+<a href="http://inside-r.org/r-doc/base/attr"><span style="color: #003399;">attr</span></a><span style="color: #009900;">(</span>g<span style="color: #339933;">,</span><span style="color: blue;">'match.length'</span><span style="color: #009900;">)</span>-<span style="color: #cc66cc;">1</span><span style="color: #009900;">)</span><br /><span style="color: #009900;">}</span><br />getcontent<span style="color: #009900;">(</span>word<span style="color: #009900;">[</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">]</span><span style="color: #339933;">,</span>gregout<span style="color: #009900;">[</span><span style="color: #009900;">[</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">]</span><span style="color: #009900;">]</span><span style="color: #009900;">)</span></span></pre><br />下面我们用一个较大的例子来说明在实际的数据抓取工作中，如何使用正则表达式。豆瓣电影是博主经常去的地方。此次任务目标是要抓取豆瓣电影中<a href="http://movie.douban.com/top250?format=text">250部最佳电影的资料</a>。R代码如下：<br /><a href="http://inside-r.org/r-doc/base/url" style="font-family: 'Courier New', Courier, monospace;"><span style="color: #003399;">url</span></a><span style="font-family: 'Courier New', Courier, monospace;"> </span><span style="font-family: 'Courier New', Courier, monospace;">&lt;-</span><span style="color: blue; font-family: 'Courier New', Courier, monospace;">'http://movie.douban.com/top250?format=text'</span><br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><span style="color: #666666; font-style: italic;"># 获取网页原代码，以行的形式存放在web变量中</span><br />web &lt;- <a href="http://inside-r.org/r-doc/base/readLines"><span style="color: #003399;">readLines</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/url"><span style="color: #003399;">url</span></a><span style="color: #339933;">,</span>encoding=<span style="color: blue;">"UTF-8"</span><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 找到包含电影名称的行编号</span><br />name &lt;- web<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/grep"><span style="color: #003399;">grep</span></a><span style="color: #009900;">(</span><span style="color: blue;">'&lt;td headers="m_name"&gt;'</span><span style="color: #339933;">,</span>web<span style="color: #009900;">)</span>+<span style="color: #cc66cc;">1</span><span style="color: #009900;">]</span><br /><span style="color: #666666; font-style: italic;"># 用正则表达式来提取电影名</span><br />gregout &lt;- <a href="http://inside-r.org/r-doc/base/gregexpr"><span style="color: #003399;">gregexpr</span></a><span style="color: #009900;">(</span><span style="color: blue;">'&gt;<span style="color: #000099;">\\</span>w+'</span><span style="color: #339933;">,</span>name<span style="color: #009900;">)</span><br />movie.names = <span style="color: #cc66cc;">0</span><br /><span style="color: black;">for</span> <span style="color: #009900;">(</span>i <span style="color: black;">in</span> <span style="color: #cc66cc;">1</span>:<span style="color: #cc66cc;">250</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />    movie.names<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span> &lt;-getcontent<span style="color: #009900;">(</span>name<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #339933;">,</span>gregout<span style="color: #009900;">[</span><span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #009900;">]</span><span style="color: #009900;">)</span><br /><span style="color: #009900;">}</span><br />movie.names &lt;- <a href="http://inside-r.org/r-doc/base/sub"><span style="color: #003399;">sub</span></a><span style="color: #009900;">(</span><span style="color: blue;">'&gt;'</span><span style="color: #339933;">,</span><span style="color: blue;">''</span><span style="color: #339933;">,</span>movie.names<span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 找到包含电影发行年份的行编号并进行提取</span><br />year &lt;- web<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/grep"><span style="color: #003399;">grep</span></a><span style="color: #009900;">(</span><span style="color: blue;">'&lt;span class="year"&gt;'</span><span style="color: #339933;">,</span>web<span style="color: #009900;">)</span><span style="color: #009900;">]</span> <br />movie.year &lt;- <a href="http://inside-r.org/r-doc/base/substr"><span style="color: #003399;">substr</span></a><span style="color: #009900;">(</span>year<span style="color: #339933;">,</span><span style="color: #cc66cc;">36</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">39</span><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 找到包含电影评分的行编号并进行提取</span><br />score &lt;- web<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/grep"><span style="color: #003399;">grep</span></a><span style="color: #009900;">(</span><span style="color: blue;">'&lt;td headers="m_rating_score"&gt;'</span><span style="color: #339933;">,</span>web<span style="color: #009900;">)</span>+<span style="color: #cc66cc;">1</span><span style="color: #009900;">]</span><br />movie.score &lt;- <a href="http://inside-r.org/r-doc/base/substr"><span style="color: #003399;">substr</span></a><span style="color: #009900;">(</span>score<span style="color: #339933;">,</span><span style="color: #cc66cc;">21</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">23</span><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 找到包含电影评价数量的行编号并进行提取</span><br />rating &lt;- web<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/grep"><span style="color: #003399;">grep</span></a><span style="color: #009900;">(</span><span style="color: blue;">'&lt;td headers="m_rating_num"&gt;'</span><span style="color: #339933;">,</span>web<span style="color: #009900;">)</span>+<span style="color: #cc66cc;">1</span><span style="color: #009900;">]</span><br />movie.rating &lt;- <a href="http://inside-r.org/r-doc/base/sub"><span style="color: #003399;">sub</span></a><span style="color: #009900;">(</span><span style="color: blue;">' *'</span><span style="color: #339933;">,</span><span style="color: blue;">''</span><span style="color: #339933;">,</span>rating<span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 合成为数据框</span><br />movie &lt;- <a href="http://inside-r.org/r-doc/base/data.frame"><span style="color: #003399;">data.frame</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/names"><span style="color: #003399;">names</span></a>=movie.names<span style="color: #339933;">,</span>year=<a href="http://inside-r.org/r-doc/base/as.numeric"><span style="color: #003399;">as.numeric</span></a><span style="color: #009900;">(</span>movie.year<span style="color: #009900;">)</span><span style="color: #339933;">,</span><br />                    score=<a href="http://inside-r.org/r-doc/base/as.numeric"><span style="color: #003399;">as.numeric</span></a><span style="color: #009900;">(</span>movie.score<span style="color: #009900;">)</span><span style="color: #339933;">,</span>rate=<a href="http://inside-r.org/r-doc/base/as.numeric"><span style="color: #003399;">as.numeric</span></a><span style="color: #009900;">(</span>movie.rating<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 绘散点图</span><br /><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/ggplot2">ggplot2</a><span style="color: #009900;">)</span><br />p &lt;- <a href="http://inside-r.org/packages/cran/ggplot">ggplot</a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>=movie<span style="color: #339933;">,</span>aes<span style="color: #009900;">(</span>x=year<span style="color: #339933;">,</span>y=score<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br />p+geom_point<span style="color: #009900;">(</span>aes<span style="color: #009900;">(</span>size=rate<span style="color: #009900;">)</span><span style="color: #339933;">,</span>colour=<span style="color: blue;">'lightskyblue4'</span><span style="color: #339933;">,</span><br />             position=<span style="color: blue;">"jitter"</span><span style="color: #339933;">,</span>alpha=<span style="color: #cc66cc;">0.8</span><span style="color: #009900;">)</span>+<br />  geom_point<span style="color: #009900;">(</span>aes<span style="color: #009900;">(</span>x=<span style="color: #cc66cc;">1997</span><span style="color: #339933;">,</span>y=<span style="color: #cc66cc;">8.9</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span>colour=<span style="color: blue;">'red'</span><span style="color: #339933;">,</span>size=<span style="color: #cc66cc;">4</span><span style="color: #009900;">)</span></span></pre></div></div><div class="separator" style="clear: both; text-align: center;"><a href="http://thumbsnap.com/i/VNVFl4wI.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://thumbsnap.com/i/VNVFl4wI.jpg" /></a></div>用散点图来观察数据，可以看到前250名电影中大部分是1980年之后发行的。1997年和2010年发行的电影有不少精品。而其中红色点所代表的是哪部电影你知道吗？那就是Titanic。<br /><br /><b><span style="color: #666666;">参考资料：Concepts in Computing with Data</span></b>
