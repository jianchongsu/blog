--- 
layout: post
name: blog-post_08
title: "\xE5\xA4\x9A\xE5\xB1\x82\xE5\x9B\x9E\xE5\xBD\x92\xE6\xA8\xA1\xE5\x9E\x8B\xE7\xAE\x80\xE4\xBB\x8B"
date: 2011-12-08 11:55:00 +08:00
categories: 
- "\xE5\xA4\x9A\xE5\xB1\x82\xE5\x9B\x9E\xE5\xBD\x92\xE6\xA8\xA1\xE5\x9E\x8B"
- "\xE6\xB7\xB7\xE5\x90\x88\xE6\x95\x88\xE5\xBA\x94\xE6\xA8\xA1\xE5\x9E\x8B"
- "\xE9\x9D\xA2\xE6\x9D\xBF\xE6\x95\xB0\xE6\x8D\xAE"
permalink: /2011/12/blog-post_08.html
---
多层回归模型（Multi-level model）中有很多容易混淆的概念，因为很多概念是来源于不同的专业背景。首先让我们先罗列这些名词进行区分，再来R语言来举例。<br /><br /><b>多层回归模型</b>通常涉及到对同一个体进行反复测量，这样得到的数据就不再相互独立而是存在某种相关性，所以普通线性回归不再适用。当这种反复测量是在不同时点上进行时，这就称为<b>面板数据分析</b>（panel data analysis）或者<b>纵向数据分析</b>（longitudinal data analysis）。<br /><a name='more'></a><br /><br /><b>Fixed Effect：固定效应</b>，也就是普通线性回归中处理的预测变量，它在模型中对响应变量的期望造成影响，其因子水平包含明确的信息，通常是在实验中加以控制的因素。<br /><br /><b>Random Effect：随机效应</b>，也就是一个随机变量，估计它是没有意义的。它在模型中对响应变量的方差造成影响，其因子水平包含信息不清楚，通常在实验中无法控制的因素，例如在面板数据分析中，不同的个体差异就是随机效应。<br /><br /><b>Fix effect model：混合效应模型</b>，模型中包含了fixed effect和random effect，根据random effect的影响，又区别为对模型截距的影响（random intercept）和对模型截距与斜率的影响（random intercept and slope）。<br /><br />假设一个面板数据中个体之间存在差异，那么它是一个random effect。它的影响分两种情况，一种是只影响截距，即是它与模型中其它预测变量相加，如果对不同个体分别作线性回归，那么得到回归线截距会不同，但回归线平行，此时又称为<b>固定效应回归模型（Fixed Effects Regression Model）</b>。另一种同时影响模型截距与斜率，是指它还与其它变量相乘，那么分别得到的回归线截距和斜率都不同，此时又称为<b>随机效应模型（Random Effects Regression Model）</b>。<br /><br />如果模型中不考虑random effect，也就是认为个体和时间都没有显著性差异，此时模型退化为<b>混合估计模型（Pooled Regression Model）</b>，此时可以直接把面板数据混合在一起用普通线性回归估计参数。<br /><br />下面我们以faraway包中的psid数据来举例，该数据集是对美国人的收入情况进行调查所得到的，其中包括了年龄、教育、性别、时间和个体ID这几个变量，我们希望了解这些因素对收入的影响。<br />&nbsp; age educ sex income year person<br />1 &nbsp;31 &nbsp; 12 &nbsp; M &nbsp; 6000 &nbsp; 68 &nbsp; &nbsp; &nbsp;1<br />2 &nbsp;31 &nbsp; 12 &nbsp; M &nbsp; 5300 &nbsp; 69 &nbsp; &nbsp; &nbsp;1<br />3 &nbsp;31 &nbsp; 12 &nbsp; M &nbsp; 5200 &nbsp; 70 &nbsp; &nbsp; &nbsp;1<br />4 &nbsp;31 &nbsp; 12 &nbsp; M &nbsp; 6900 &nbsp; 71 &nbsp; &nbsp; &nbsp;1<br />5 &nbsp;31 &nbsp; 12 &nbsp; M &nbsp; 7500 &nbsp; 72 &nbsp; &nbsp; &nbsp;1<br />6 &nbsp;31 &nbsp; 12 &nbsp; M &nbsp; 8000 &nbsp; 73 &nbsp; &nbsp; &nbsp;1<br /><br />如果假设认为这些调查对象是同质的，也就是个体间没有差异性，那么可以将数据<b>完全汇集（complete pooling）</b>到一起，直接利用lm函数进行回归。但这个混合效应模型的同质假设往往不成立，数据汇集导致过度简化。<br /><br />另一种思路是假设研究的异质性，将不同的个体分别进行回归，从而得到针对特定个体的估计值，这称为<b>不汇集（no pooling）</b>。但这种方法导致每个回归所用到的样本减少，从而难以估计统计量的标准差。<br /><br />多层回归模型的思路是前两者的折中，所以又称为<b>部分汇集（partial pooling）</b>。在R语言中我们使用<b>lme4包</b>中的<b>lmer函数</b>来完成这项工作。首先载入faraway包以便读取psid数据集，然后加载mgcv包，再将年份数据中心化以方便解释模型，最后用lmer函数进行建模。<br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">-----------------</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">library(faraway)</span><br /><span style="font-family: Courier New, Courier, monospace;">library(lme4)</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">psid$cyear &lt;- psid$year-78&nbsp;</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">model1=lmer(log(income) ~ cyear*sex +age+educ+(cyear|person),psid)&nbsp;</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">-----------------</span><br />lmer函数使用和lm是类似的，一般变量表示固定效应，括号内竖线右侧的person表示它是一个随机效应，它与模型中其它变量相加，而且与年份cyear变量相乘，影响其斜率。这就是一个随机效应模型。如果认为随机效应只影响模型截距，那么固定效应回归模型可以用下面的公式<br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">-----------------</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">model2=lmer(log(income) ~ cyear*sex +age+educ+(1|person),psid)</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">-----------------</span><br />为了判断哪一个模型更为合适，可以使用anova函数，从结果中观察到P值很小，判断应当使用model1<br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">-----------------</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">anova(model1,model2)</span><br /><br /><span class="Apple-style-span" style="font-family: Verdana, sans-serif; font-size: x-small;">Data: psid</span><br /><span class="Apple-style-span" style="font-family: Verdana, sans-serif; font-size: x-small;">Models:</span><br /><span class="Apple-style-span" style="font-family: Verdana, sans-serif; font-size: x-small;">model2: log(income) ~ cyear * sex + age + educ + (1 | person)</span><br /><span class="Apple-style-span" style="font-family: Verdana, sans-serif; font-size: x-small;">model1: log(income) ~ cyear * sex + age + educ + (cyear | person)</span><br /><span class="Apple-style-span" style="font-family: Verdana, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp;Df &nbsp; &nbsp;AIC &nbsp; &nbsp;BIC &nbsp;logLik &nbsp;Chisq Chi Df</span><br /><span class="Apple-style-span" style="font-family: Verdana, sans-serif; font-size: x-small;">model2 &nbsp;8 3943.9 3987.2 -1963.9 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><br /><span class="Apple-style-span" style="font-family: Verdana, sans-serif; font-size: x-small;">model1 10 3805.6 3859.7 -1892.8 142.27 &nbsp; &nbsp; &nbsp;2</span><br /><span class="Apple-style-span" style="font-family: Verdana, sans-serif; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp;Pr(&gt;Chisq) &nbsp; &nbsp;</span><br /><span class="Apple-style-span" style="font-family: Verdana, sans-serif; font-size: x-small;">model2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span><br /><span class="Apple-style-span" style="font-family: Verdana, sans-serif; font-size: x-small;">model1 &nbsp;&lt; 2.2e-16 ***</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">-----------------</span><br /><br />得到的模型结果还可以用各种泛型函数如summary、predict、resid进行进一步处理。当响应变量不符合正态分布假设时，还可以用<b>广义多层回归进行(glmer)</b>建模<br /><br /><span class="Apple-style-span" style="color: #666666;">参考资料：</span><br /><span class="Apple-style-span" style="color: #666666;">环境与生态统计--R语言的应用</span><br /><span class="Apple-style-span" style="color: #666666;">The R Book</span><br /><span class="Apple-style-span" style="color: #666666;">A_Handbook_of_Statistical_Analyses_Using_R</span><br /><span class="Apple-style-span" style="color: #666666;">Extending_the_Linear_Model_with_R__Generalized_Linear__Mixed_Effects_and_Nonparametric_Regression_Model</span>
