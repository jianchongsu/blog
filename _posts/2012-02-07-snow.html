--- 
layout: post
name: snow
title: "\xE4\xBD\xBF\xE7\x94\xA8snow\xE5\x8C\x85\xE5\xAE\x9E\xE7\x8E\xB0\xE5\x8F\x8C\xE6\xA0\xB8\xE5\xBF\x83\xE5\xB9\xB6\xE8\xA1\x8C\xE8\xAE\xA1\xE7\xAE\x97"
date: 2012-02-07 09:32:00 +08:00
categories: 
- "\xE5\xB9\xB6\xE8\xA1\x8C\xE8\xAE\xA1\xE7\xAE\x97"
- "\xE8\x81\x9A\xE7\xB1\xBB\xE5\x88\x86\xE6\x9E\x90"
permalink: /2012/02/snow.html
---
<a href="http://4.bp.blogspot.com/-8SF9nevfB_g/TzB-BdLG_XI/AAAAAAAAAso/zvct4hp7f94/s1600/CM5.jpg" imageanchor="1" style="clear: left; display: inline !important; float: left; margin-bottom: 1em; margin-right: 1em; text-align: center;"><img border="0" height="187" src="http://4.bp.blogspot.com/-8SF9nevfB_g/TzB-BdLG_XI/AAAAAAAAAso/zvct4hp7f94/s200/CM5.jpg" width="200" /></a><br />在数据挖掘和机器学习领域有许多的算法需要强大的计算能力，如果对大数据进行运算操作，那么其工作量之大使单个CPU核心难以承受负荷。目前的个人计算机已经具备有多个核心，如果采用<a href="http://en.wikipedia.org/wiki/Parallel_computing">并行计算</a>将任务分解到多个核心上运行就能大大减少计算时间。进一步还可以将多台计算机组合成计算集群(Cluster)则能使之具备组合金刚般的运算能力。<br /><br />目前已经有<a href="http://cran.r-project.org/web/views/HighPerformanceComputing.html">多个R语言扩展包</a>专注于高性能运算，弥补了R本身单核心作业的弱点。其中<a href="http://cran.r-project.org/web/packages/snow/index.html">snow</a>（Simple Network of Workstations）是R语言中最流行的并行编程包于2003年推出，本文将尝试用snow来运算<a href="http://xccds1977.blogspot.com/2012/01/r.html">K均值聚类</a>。<br /><a name='more'></a>我们先用单核心运算K均值聚类来看看花费的时间，用到的数据集是MASS包中的Boston数据，我们希望将其聚为4类，由于K均值聚类的算法是随机确定初始中心点，所以为了使之收敛到最优解上需要反复运算多次。此处nstart参数设置为100000，即为运算次数。<br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><a href="http://inside-r.org/r-doc/base/system.time"><span style="color: #003399;">system.time</span></a><span style="color: #009900;">(</span><span style="color: #009900;">{</span><br />  <a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/MASS">MASS</a><span style="color: #009900;">)</span><br />  result &lt;- <a href="http://inside-r.org/r-doc/stats/kmeans"><span style="color: #003399;">kmeans</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/MASS/Boston"><span style="color: #003399;">Boston</span></a><span style="color: #339933;">,</span><span style="color: #cc66cc;">4</span><span style="color: #339933;">,</span>nstart=<span style="color: #cc66cc;">100000</span><span style="color: #009900;">)</span><br /><span style="color: #009900;">}</span><span style="color: #009900;">)</span></span></pre></div></div>可看到单核心计算共耗费了<b>61秒</b>，再用本地计算机上用双核心构建集群进行比较。在安装和加载snow包后，首先用makeCluster函数构建本地计算集群，通讯方式使用socket，集群命名为cl。然后将运算所需的Boston数据分发到集群上。之后使用clusterApply函数将计算任务分配到两个核心上，其中第一个参数是集群名称，第二个参数表示每个核心分别计算5万次，第三个参数是一个匿名函数，规定了核心的计算任务。两个核心的计算结果分别存在results的list元素中。比较两个核心的结果取较优的一个，最后关闭集群。<br /><br /><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><a href="http://inside-r.org/r-doc/utils/install.packages"><span style="color: #003399;">install.packages</span></a><span style="color: #009900;">(</span><span style="color: blue;">'snow'</span><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/snow">snow</a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/system.time"><span style="color: #003399;">system.time</span></a><span style="color: #009900;">(</span><span style="color: #009900;">{</span><br />  <a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/MASS/Boston"><span style="color: #003399;">Boston</span></a><span style="color: #009900;">)</span><br />  cl &lt;- makeCluster<span style="color: #009900;">(</span><span style="color: #cc66cc;">2</span><span style="color: #339933;">,</span>type=<span style="color: blue;">'SOCK'</span><span style="color: #009900;">)</span><br />  clusterExport<span style="color: #009900;">(</span>cl<span style="color: #339933;">,</span><span style="color: blue;">'Boston'</span><span style="color: #009900;">)</span><br />  results &lt;- clusterApply<span style="color: #009900;">(</span>cl<span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/rep"><span style="color: #003399;">rep</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">50000</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399;">function</span></a><span style="color: #009900;">(</span>nstart<span style="color: #009900;">)</span> kmean<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/MASS/Boston"><span style="color: #003399;">Boston</span></a><span style="color: #339933;">,</span><span style="color: #cc66cc;">4</span><span style="color: #339933;">,</span>nstart=nstart<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br />  i &lt;- <a href="http://inside-r.org/r-doc/base/sapply"><span style="color: #003399;">sapply</span></a><span style="color: #009900;">(</span>results<span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399;">function</span></a><span style="color: #009900;">(</span>result<span style="color: #009900;">)</span> result$tot.withinss<span style="color: #009900;">)</span><br />  result &lt;- results<span style="color: #009900;">[</span><span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/which.min"><span style="color: #003399;">which.min</span></a><span style="color: #009900;">(</span>i<span style="color: #009900;">)</span><span style="color: #009900;">]</span><span style="color: #009900;">]</span><br />  stopCluster<span style="color: #009900;">(</span>cl<span style="color: #009900;">)</span><br /><span style="color: #009900;">}</span><span style="color: #009900;">)</span></span></pre><br />从结果观察到本地双核心组成的计算集群只耗费了<b>34秒</b>即完成了运算。snow也可以用多台计算机构建集群，不过设置蛮复杂，笔者没有折腾成功。总而言之，snow是一种高级包，它不关注底层的线程之间的通讯，而着重于任务的执行易于使用，相对R的单核心弱点是很好的补充。<br /><br />参考资料：<br />Parallel R<br />The Art of R Programming<br /><a href="http://www.sfu.ca/~sblay/R/snow.html">http://www.sfu.ca/~sblay/R/snow.html</a><br /><a href="http://cran.r-project.org/web/packages/snow/snow.pdf">http://cran.r-project.org/web/packages/snow/snow.pdf</a>
