--- 
layout: post
name: r_29
title: "R\xE8\xAF\xAD\xE8\xA8\x80\xE7\xBC\x96\xE7\xA8\x8B\xE5\x85\xA5\xE9\x97\xA8\xE4\xB9\x8B\xE4\xBA\x94\xEF\xBC\x9A\xE5\x90\x91\xE9\x87\x8F\xE5\x8C\x96\xE8\xBF\x90\xE7\xAE\x97"
date: 2012-02-29 11:01:00 +08:00
categories: 
- "\xE7\xBC\x96\xE7\xA8\x8B"
- "\xE5\x85\xA5\xE9\x97\xA8\xE6\x95\x99\xE7\xA8\x8B"
permalink: /2012/02/r_29.html
---
<a href="http://thumbsnap.com/i/wH5EJyXH.jpg" imageanchor="1" style="clear: left; display: inline !important; float: left; margin-bottom: 1em; margin-right: 1em; text-align: center;"><img border="0" height="200" src="http://thumbsnap.com/i/wH5EJyXH.jpg" width="199" /></a><br />和matlab一样，R语言以向量为基本运算对象。也就是说，当输入的对象为向量时，对其中的每个元素分别进行处理，然后以向量的形式输出。R语言中基本上所有的数据运算均能允许向量操作。不仅如此，R还包含了许多高效的向量运算函数，这也是它不同于其它软件的一个显著特征。向量化运算的好处在于避免使用循环，使代码更为简洁、高效和易于理解。本文来对apply族函数作一个简单的归纳，以便于大家理解其中的区别所在。<br /><br />所谓apply族函数包括了apply,sapply,lappy,tapply等函数，这些函数在不同的情况下能高效的完成复杂的数据处理任务，但角色定位又有所不同。<br /><a name='more'></a><br /><b>apply()函数</b>的处理对象是矩阵或数组，它逐行或逐列的处理数据，其输出的结果将是一个向量或是矩阵。下面的例子即对一个随机矩阵求每一行的均值。要注意的是apply与其它函数不同，它并不能明显改善计算效率，因为它本身内置为循环运算。<br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;">m.data &lt;- <a href="http://inside-r.org/r-doc/base/matrix"><span style="color: #003399;">matrix</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/rnorm"><span style="color: #003399;">rnorm</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">100</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/ncol"><span style="color: #003399;">ncol</span></a>=<span style="color: #cc66cc;">10</span><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/apply"><span style="color: #003399;">apply</span></a><span style="color: #009900;">(</span>m.data<span style="color: #339933;">,</span><span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/mean"><span style="color: #003399;">mean</span></a><span style="color: #009900;">)</span>&nbsp;</span></pre><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><br /></span><b>lappy()</b>的处理对象是向量、列表或其它对象，它将向量中的每个元素作为参数，输入到处理函数中，最后生成结果的格式为列表。在R中数据框是一种特殊的列表，所以数据框的列也将作为函数的处理对象。下面的例子即对一个数据框按列来计算中位数与标准差。</pre></div></div><span style="font-family: 'Courier New', Courier, monospace;">f.data &lt;- </span><a href="http://inside-r.org/r-doc/base/data.frame" style="font-family: 'Courier New', Courier, monospace;"><span style="color: #003399;">data.frame</span></a><span style="color: #009900; font-family: 'Courier New', Courier, monospace;">(</span><span style="font-family: 'Courier New', Courier, monospace;">x=</span><a href="http://inside-r.org/r-doc/stats/rnorm" style="font-family: 'Courier New', Courier, monospace;"><span style="color: #003399;">rnorm</span></a><span style="color: #009900; font-family: 'Courier New', Courier, monospace;">(</span><span style="color: #cc66cc; font-family: 'Courier New', Courier, monospace;">10</span><span style="color: #009900; font-family: 'Courier New', Courier, monospace;">)</span><span style="color: #339933; font-family: 'Courier New', Courier, monospace;">,</span><span style="font-family: 'Courier New', Courier, monospace;">y=</span><a href="http://inside-r.org/r-doc/stats/runif" style="font-family: 'Courier New', Courier, monospace;"><span style="color: #003399;">runif</span></a><span style="color: #009900; font-family: 'Courier New', Courier, monospace;">(</span><span style="color: #cc66cc; font-family: 'Courier New', Courier, monospace;">10</span><span style="color: #009900; font-family: 'Courier New', Courier, monospace;">)</span><span style="color: #009900; font-family: 'Courier New', Courier, monospace;">)</span><br /><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><a href="http://inside-r.org/r-doc/base/lapply"><span style="color: #003399;">lapply</span></a><span style="color: #009900;">(</span>f.data<span style="color: #339933;">,</span>FUN=<a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399;">function</span></a><span style="color: #009900;">(</span>x<span style="color: #009900;">)</span> <a href="http://inside-r.org/r-doc/base/list"><span style="color: #003399;">list</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/median"><span style="color: #003399;">median</span></a>=<a href="http://inside-r.org/r-doc/stats/median"><span style="color: #003399;">median</span></a><span style="color: #009900;">(</span>x<span style="color: #009900;">)</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/stats/sd"><span style="color: #003399;">sd</span></a>=<a href="http://inside-r.org/r-doc/stats/sd"><span style="color: #003399;">sd</span></a><span style="color: #009900;">(</span>x<span style="color: #009900;">)</span><span style="color: #009900;">)</span>）</span></pre><b><br /></b><br /><b>sapply()</b>可能是使用最为频繁的向量化函数了，它和lappy()是非常相似的，但其输出格式则是较为友好的矩阵格式。<br /><a href="http://inside-r.org/r-doc/base/sapply" style="font-family: 'Courier New', Courier, monospace;"><span style="color: #003399;">sapply</span></a><span style="color: #009900; font-family: 'Courier New', Courier, monospace;">(</span><span style="font-family: 'Courier New', Courier, monospace;">f.data</span><span style="color: #339933; font-family: 'Courier New', Courier, monospace;">,</span><span style="font-family: 'Courier New', Courier, monospace;">FUN=</span><a href="http://inside-r.org/r-doc/base/function" style="font-family: 'Courier New', Courier, monospace;"><span style="color: #003399;">function</span></a><span style="color: #009900; font-family: 'Courier New', Courier, monospace;">(</span><span style="font-family: 'Courier New', Courier, monospace;">x</span><span style="color: #009900; font-family: 'Courier New', Courier, monospace;">)</span><span style="font-family: 'Courier New', Courier, monospace;"> </span><a href="http://inside-r.org/r-doc/base/list" style="font-family: 'Courier New', Courier, monospace;"><span style="color: #003399;">list</span></a><span style="color: #009900; font-family: 'Courier New', Courier, monospace;">(</span><a href="http://inside-r.org/r-doc/stats/median" style="font-family: 'Courier New', Courier, monospace;"><span style="color: #003399;">median</span></a><span style="font-family: 'Courier New', Courier, monospace;">=</span><a href="http://inside-r.org/r-doc/stats/median" style="font-family: 'Courier New', Courier, monospace;"><span style="color: #003399;">median</span></a><span style="color: #009900; font-family: 'Courier New', Courier, monospace;">(</span><span style="font-family: 'Courier New', Courier, monospace;">x</span><span style="color: #009900; font-family: 'Courier New', Courier, monospace;">)</span><span style="color: #339933; font-family: 'Courier New', Courier, monospace;">,</span><a href="http://inside-r.org/r-doc/stats/sd" style="font-family: 'Courier New', Courier, monospace;"><span style="color: #003399;">sd</span></a><span style="font-family: 'Courier New', Courier, monospace;">=</span><a href="http://inside-r.org/r-doc/stats/sd" style="font-family: 'Courier New', Courier, monospace;"><span style="color: #003399;">sd</span></a><span style="color: #009900; font-family: 'Courier New', Courier, monospace;">(</span><span style="font-family: 'Courier New', Courier, monospace;">x</span><span style="color: #009900; font-family: 'Courier New', Courier, monospace;">)</span><span style="color: #009900; font-family: 'Courier New', Courier, monospace;">)</span><span style="color: #009900; font-family: 'Courier New', Courier, monospace;">)</span><br /><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><a href="http://inside-r.org/r-doc/base/class"><span style="color: #003399;">class</span></a><span style="color: #009900;">(</span>test<span style="color: #009900;">)</span></span></pre><b><br /></b><br /><b>tapply()</b>的功能则又有不同，它是专门用来处理分组数据的，其参数要比sapply多一个。我们以iris数据集为例，可观察到Species列中存放了三种花的名称，我们的目的是要计算三种花瓣萼片宽度的均值。其输出结果是数组格式。<br /><br /><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><a href="http://inside-r.org/r-doc/utils/head"><span style="color: #003399;">head</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/datasets/iris"><span style="color: #003399;">iris</span></a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/attach"><span style="color: #003399;">attach</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/datasets/iris"><span style="color: #003399;">iris</span></a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/tapply"><span style="color: #003399;">tapply</span></a><span style="color: #009900;">(</span>Sepal.Width<span style="color: #339933;">,</span>INDEX=Species<span style="color: #339933;">,</span>FUN=<a href="http://inside-r.org/r-doc/base/mean"><span style="color: #003399;">mean</span></a><span style="color: #009900;">)</span></span></pre><br />与tapply功能非常相似的还有<b>aggregate()</b>，其输出是更为友好的数据框格式。而<b>by()</b>和上面两个函数是同门师兄弟。<br /><br />另外还有一个非常有用的函数<b>replicate()</b>，它可以将某个函数重复运行N次，常常用来生成较复杂的随机数。下面的例子即先建立一个函数，模拟扔两个骰子的点数之和，然后重复运行10000次。<br /><span style="font-family: 'Courier New', Courier, monospace;">game &lt;- </span><a href="http://inside-r.org/r-doc/base/function" style="font-family: 'Courier New', Courier, monospace;"><span style="color: #003399;">function</span></a><span style="color: #009900; font-family: 'Courier New', Courier, monospace;">(</span><span style="color: #009900; font-family: 'Courier New', Courier, monospace;">)</span><span style="font-family: 'Courier New', Courier, monospace;"> </span><span style="color: #009900; font-family: 'Courier New', Courier, monospace;">{</span><br /><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;">    n &lt;- <a href="http://inside-r.org/r-doc/base/sample"><span style="color: #003399;">sample</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">1</span>:<span style="color: #cc66cc;">6</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">2</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/replace"><span style="color: #003399;">replace</span></a>=T<span style="color: #009900;">)</span><br />    <a href="http://inside-r.org/r-doc/base/return"><span style="color: #003399;">return</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/sum"><span style="color: #003399;">sum</span></a><span style="color: #009900;">(</span>n<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br /><span style="color: #009900;">}</span><br /><a href="http://inside-r.org/r-doc/base/replicate"><span style="color: #003399;">replicate</span></a><span style="color: #009900;">(</span>n=<span style="color: #cc66cc;">10000</span><span style="color: #339933;">,</span>game<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span></span></pre><pre class="r geshifilter-R"><span style="font-family: inherit; white-space: normal;">最后一个有趣的函数<b>Vectorize()</b>，它能将一个不能进行向量化运算的函数进行转化，使之具备向量化运算功能。</span><br /></pre>
