--- 
layout: post
name: lubridate
title: "\xE7\x94\xA8lubridate\xE5\x8C\x85\xE6\x9D\xA5\xE5\xA4\x84\xE7\x90\x86\xE6\x97\xB6\xE9\x97\xB4\xE6\x95\xB0\xE6\x8D\xAE"
date: 2012-07-01 11:50:00 +08:00
categories: 
- "\xE6\x95\xB0\xE6\x8D\xAE\xE9\xA2\x84\xE5\xA4\x84\xE7\x90\x86"
permalink: /2012/07/lubridate.html
---
<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-GP7lQkjtVz4/T-_Hd42apgI/AAAAAAAABAU/wqN9o6cNjV4/s1600/Time.jpg" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" height="158" src="http://4.bp.blogspot.com/-GP7lQkjtVz4/T-_Hd42apgI/AAAAAAAABAU/wqN9o6cNjV4/s200/Time.jpg" width="200" /></a></div>人生有一道难题，那就是如何使一寸光阴等于一寸生命。在数据分析中也有一道难题，那就是如何自如的操作时间数据。R语言的基础包中提供了两种类型的时间数据，一类是Date日期数据，它不包括时间和时区信息，另一类是POSIXct/POSIXlt类型数据，其中包括了日期、时间和时区信息。一般来讲，R语言中建立时序数据是通过字符型转化而来，但由于时序数据形式多样，而且R中存贮格式也是五花八门，例如Date/ts/xts/zoo/tis/fts等等。用户很容易被一系列的数据格式所迷惑，所以时序数据的转化和操作并不是非常方便。所幸的是，我们有了<b>lubridate包</b>。lubridate包主要有两类函数，<b>一类是处理时点数据（time instants），另一类是处理时段数据（time spans）</b>。<br /><br /><b>时点类函数</b>，它包括了解析、抽取、修改。<br /><br /><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><span style="color: #666666; font-style: italic;"># 从字符型数据解析时间，会自动识别各种分隔符</span><br />&gt; x &lt;- ymd<span style="color: #009900;">(</span><span style="color: blue;">'2010-04-08'</span><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 观察x日期是一年中的第几天</span><br />&gt; yday<span style="color: #009900;">(</span>x<span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 修改x日期中的月份为5月</span><br />&gt; month<span style="color: #009900;">(</span>x<span style="color: #009900;">)</span> &lt;- <span style="color: #cc66cc;">5</span></span></pre><br /><a name='more'></a><b style="background-color: white;">时段类函数，</b><span style="background-color: white;">它可以处理三类对象，分别是：</span><br /><ul><li><span style="background-color: white;">interval：最简单的时段对象，它由两个时点数据构成。</span></li><li><span style="background-color: white;">duration：去除了时间两端的信息，纯粹以秒为单位计算时段的长度，不考虑闰年和闰秒，它同时也兼容基本包中的difftime类型对象。</span></li><li><span style="background-color: white;">period：以较长的时钟周期来计算时段长度，它考虑了闰年和闰秒，适用于长期的时间计算。以2012年为例，duration计算的一年是标准不变的365天，而period计算的一年就会变成366天。</span></li></ul><span style="background-color: white;">有了时点和时段数据，就可以进行各种计算了。</span><br /><br /><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><span style="color: #666666; font-style: italic;"># 从两个时点生成一个interval时段数据</span><br />&gt; y &lt;- new_interval<span style="color: #009900;">(</span>x<span style="color: #339933;">,</span>now<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 从interval格式转为duration格式</span><br />&gt; as.duration<span style="color: #009900;">(</span>y<span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 时点+时段生成一个新的时点</span><br />&gt; now<span style="color: #009900;">(</span><span style="color: #009900;">)</span> + as.duration<span style="color: #009900;">(</span>y<span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 10天后的时间数据</span><br />&gt; now<span style="color: #009900;">(</span><span style="color: #009900;">)</span> + ddays<span style="color: #009900;">(</span><span style="color: #cc66cc;">10</span><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 下面的两条语句很容易看出duration和period的区别，dyears(1)表示duration对象的一年，它永远是365天。而years(1)表示period对象的一年，它识别出2012是闰年，它有366天，所以得到正确的时点。</span><br />&gt; ymd<span style="color: #009900;">(</span><span style="color: blue;">'20120101'</span><span style="color: #009900;">)</span> + dyears<span style="color: #009900;">(</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">)</span><br /><span style="color: #009900;">[</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">]</span> <span style="color: blue;">"2012-12-31 UTC"</span><br />&gt; ymd<span style="color: #009900;">(</span><span style="color: blue;">'20120101'</span><span style="color: #009900;">)</span> + years<span style="color: #009900;">(</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">)</span><br /><span style="color: #009900;">[</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">]</span> <span style="color: blue;">"2013-01-01 UTC"</span></span></pre><br /><span style="background-color: white;">为了处理<b>时区信息</b>，lubridate包提供了三个函数：</span><br /><ul><li><span style="background-color: white;">tz：提取时间数据的时区</span></li><li><span style="background-color: white;">with_tz：将时间数据转换为另一个时区的同一时间</span></li><li><span style="background-color: white;">force_tz：将时间数据的时区强制转换为另一个时区</span></li></ul><br /><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><span style="color: #666666; font-style: italic;"># 输入欧洲杯决赛在乌克兰的开场时间，再转为北京时间</span><br />eurotime &lt;- ymd_hms<span style="color: #009900;">(</span><span style="color: blue;">'2012-07-01 21:45:00'</span><span style="color: #339933;">,</span>tz=<span style="color: blue;">'EET'</span><span style="color: #009900;">)</span><br />with_tz<span style="color: #009900;">(</span>eurotime<span style="color: #339933;">,</span>tzone=<span style="color: blue;">'asia/shanghai'</span><span style="color: #009900;">)</span></span></pre><br /><span style="background-color: white;">最后来玩玩股票指数作为结束吧，在金融市场中谣传着一种日历效应。即在一周的第一天或者一年的第一个月份，股票会出现不错的上涨。让我们用热图来观察一下。首先是获取上证指数数据，然后根据不同的月份和星期数，将收益率汇集到不同的组中。将该组收益率的中位数映射到图形颜色上去。可以从下图看到，似乎并不存在明显周一效应或是一月效应。</span><br /><br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/quantmod">quantmod</a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/ggplot2">ggplot2</a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;">library</span></a><span style="color: #009900;">(</span>lubridate<span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 读取上证指数历史数据</span><br />getSymbols<span style="color: #009900;">(</span><span style="color: blue;">'^SSEC'</span><span style="color: #339933;">,</span>src=<span style="color: blue;">'yahoo'</span><span style="color: #339933;">,</span>from = <span style="color: blue;">'1997-01-01'</span><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/stats/time"><span style="color: #003399;">time</span></a> &lt;- ymd<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/as.character"><span style="color: #003399;">as.character</span></a><span style="color: #009900;">(</span>index<span style="color: #009900;">(</span>SSEC<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/open"><span style="color: #003399;">open</span></a> &lt;- <a href="http://inside-r.org/r-doc/base/as.numeric"><span style="color: #003399;">as.numeric</span></a><span style="color: #009900;">(</span>Op<span style="color: #009900;">(</span>SSEC<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br />high &lt;- <a href="http://inside-r.org/r-doc/base/as.numeric"><span style="color: #003399;">as.numeric</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/HI">Hi</a><span style="color: #009900;">(</span>SSEC<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br />low &lt;- <a href="http://inside-r.org/r-doc/base/as.numeric"><span style="color: #003399;">as.numeric</span></a><span style="color: #009900;">(</span>Lo<span style="color: #009900;">(</span>SSEC<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/close"><span style="color: #003399;">close</span></a> &lt;- <a href="http://inside-r.org/r-doc/base/as.numeric"><span style="color: #003399;">as.numeric</span></a><span style="color: #009900;">(</span>Cl<span style="color: #009900;">(</span>SSEC<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/cluster/volume"><span style="color: #003399;">volume</span></a> &lt;- <a href="http://inside-r.org/r-doc/base/as.numeric"><span style="color: #003399;">as.numeric</span></a><span style="color: #009900;">(</span>Vo<span style="color: #009900;">(</span>SSEC<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 根据收盘和开盘计算当日收益率</span><br />profit &lt;- <span style="color: #009900;">(</span>close-<a href="http://inside-r.org/r-doc/base/open"><span style="color: #003399;">open</span></a><span style="color: #009900;">)</span>/open<br /><span style="color: #666666; font-style: italic;"># 提取时间数据中的周数和月份</span><br />wday &lt;- wday<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/time"><span style="color: #003399;">time</span></a><span style="color: #009900;">)</span>-<span style="color: #cc66cc;">1</span><br />mday &lt;-month<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/time"><span style="color: #003399;">time</span></a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a> &lt;- <a href="http://inside-r.org/r-doc/base/data.frame"><span style="color: #003399;">data.frame</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/time"><span style="color: #003399;">time</span></a><span style="color: #339933;">,</span>wday<span style="color: #339933;">,</span>mday<span style="color: #339933;">,</span>profit<span style="color: #009900;">)</span><br />p &lt;- <a href="http://inside-r.org/packages/cran/ggplot">ggplot</a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a><span style="color: #339933;">,</span>aes<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/factor"><span style="color: #003399;">factor</span></a><span style="color: #009900;">(</span>mday<span style="color: #009900;">)</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/factor"><span style="color: #003399;">factor</span></a><span style="color: #009900;">(</span>wday<span style="color: #009900;">)</span><span style="color: #339933;">,</span>z=profit<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 收益率的热图，图中颜色越浅，表示汇集到这个组中的收益率中位数越高</span><br />p +stat_summary2d<span style="color: #009900;">(</span>fun=<a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399;">function</span></a><span style="color: #009900;">(</span>x<span style="color: #009900;">)</span> <a href="http://inside-r.org/r-doc/stats/median"><span style="color: #003399;">median</span></a><span style="color: #009900;">(</span>x<span style="color: #009900;">)</span><span style="color: #009900;">)</span>+<br />  opts<span style="color: #009900;">(</span>legend.position = <span style="color: blue;">"top"</span><span style="color: #009900;">)</span>+ labs<span style="color: #009900;">(</span>x=<span style="color: blue;">'月份'</span><span style="color: #339933;">,</span>y=<span style="color: blue;">'星期'</span><span style="color: #009900;">)</span></span></pre></div></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-v_LLXGdJ_so/T-_Inu11qfI/AAAAAAAABAc/6-xrRiiQm6g/s1600/Rplot01.jpeg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-v_LLXGdJ_so/T-_Inu11qfI/AAAAAAAABAc/6-xrRiiQm6g/s1600/Rplot01.jpeg" /></a></div>参考资料：<br /><a href="http://statistics.berkeley.edu/classes/s133/dates.html">http://statistics.berkeley.edu/classes/s133/dates.html</a><br /><a href="http://www.jstatsoft.org/v40/i03/paper">http://www.jstatsoft.org/v40/i03/paper</a><br /><a href="http://rlogs.sinaapp.com/post/r-package-lubridate.html">http://rlogs.sinaapp.com/post/r-package-lubridate.html</a>
