--- 
layout: post
name: r
title: "\xE5\x9C\xA8R\xE4\xB8\xAD\xE8\xBF\x9B\xE8\xA1\x8C\xE5\x9F\xBA\xE4\xBA\x8E\xE7\xA8\xB3\xE5\x81\xA5\xE9\xA9\xAC\xE6\xB0\x8F\xE8\xB7\x9D\xE7\xA6\xBB\xE7\x9A\x84\xE5\xBC\x82\xE5\xB8\xB8\xE6\xA3\x80\xE9\xAA\x8C"
date: 2012-07-11 18:18:00 +08:00
categories: 
- "\xE5\xBC\x82\xE5\xB8\xB8\xE6\xA3\x80\xE6\xB5\x8B"
permalink: /2012/07/r.html
---
<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-lAef_QErymA/T_1PzFvh8RI/AAAAAAAABBs/YGIo7d5mTiM/s1600/outlier.jpg" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" height="174" src="http://2.bp.blogspot.com/-lAef_QErymA/T_1PzFvh8RI/AAAAAAAABBs/YGIo7d5mTiM/s200/outlier.jpg" width="200" /></a></div><span style="background-color: white;">我们研究的数据中经常包含着一些不同寻常的样本，这称之为<b>异常值(Outlier)</b>。这些异常值会极大的影响回归或分类的效果。异常值产生的原因有很多，其中可能是人为错误、数据测量误差，或者是实际确实存在这样的异常。为了使模型能够反映大部分数据的规律，所以在数据预处理阶段要进行异常值检测，为下一步分析奠定基础。还有一类情况是，当研究人员希望发现不平凡的事物时，异常值检测本身就是分析的首要目的。例如在信用卡欺诈、计算机入侵检测等问题中。此时由于样本的不平衡性，导致一般的分类方法无法使用，必须转而考虑<b>异常检测</b></span><span style="background-color: white;">方法。</span><br /><br />一种常用的异常检验思路是观察各样本点到样本中心的距离。如果某些样本点的距离太大，就可以判断是异常值。这里距离的度量一般使用<b>马氏距离(Mahalanobis Distance)</b>。因为马氏距离不受量纲的影响，而且在多元条件下，马氏距离还考虑了变量之间的相关性，这使得它优于欧氏距离。<br /><br />但是传统的马氏距离检测方法是不稳定的，因为个别异常值会把均值向量和协方差矩阵向自己方向吸引，这样算出来的样本马氏距离起不了检测异常值的所用。所以首先要利用迭代的思想构造一个稳健的均值和协方差矩阵估计量，然后计算<b>稳健马氏距离(Robust Mahalanobis Distance)</b>。这样使得异常值能够正确地被识别出来。<br /><br />在<b>mvoutlier包</b>中提供了基于稳健马氏距离的异常值检验方法。我们首先构造一个二维变量的人工数据，其中80个样本是标准正态分布，另一小撮别有用心的样本是均值为5，标准差为1的观测值。我们首先使用<b>uni.plot</b>函数在一维空间中观察这个数据。<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-DGe85HlexQg/T_1Q3Gay3wI/AAAAAAAABB0/qm1s7v9FWG8/s1600/Rplot01.jpeg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-DGe85HlexQg/T_1Q3Gay3wI/AAAAAAAABB0/qm1s7v9FWG8/s1600/Rplot01.jpeg" /></a></div><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;"><a name='more'></a>library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/mvoutlier">mvoutlier</a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/set.seed"><span style="color: #003399;">set.seed</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">1234</span><span style="color: #009900;">)</span><br />x &lt;- <a href="http://inside-r.org/r-doc/base/cbind"><span style="color: #003399;">cbind</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/rnorm"><span style="color: #003399;">rnorm</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">80</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span> <a href="http://inside-r.org/r-doc/stats/rnorm"><span style="color: #003399;">rnorm</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">80</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><br />y &lt;- <a href="http://inside-r.org/r-doc/base/cbind"><span style="color: #003399;">cbind</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/rnorm"><span style="color: #003399;">rnorm</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">10</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">5</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span> <a href="http://inside-r.org/r-doc/stats/rnorm"><span style="color: #003399;">rnorm</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">10</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">5</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">1</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><br />z &lt;- <a href="http://inside-r.org/r-doc/base/rbind"><span style="color: #003399;">rbind</span></a><span style="color: #009900;">(</span>x<span style="color: #339933;">,</span>y<span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 一维数据的异常检验</span><br />res1 &lt;- uni.plot<span style="color: #009900;">(</span>z<span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 返回异常值的编号</span><br /><a href="http://inside-r.org/r-doc/base/which"><span style="color: #003399;">which</span></a><span style="color: #009900;">(</span>res1$outliers==T<span style="color: #009900;">)</span></span></pre><br />上图中红色点表示疑似异常值，因为它偏离均值太远。更多时候我们会处理多元异常检测问题，此时用<b>aq.plot</b>函数来实行基于稳健马氏距离的异常值检验方法。下图中左上角图形为原始数据，右上角图形的X轴为各样本的稳健马氏距离排序，Y轴为距离的经验分布，红色曲线为卡方分布，蓝色垂线表示阀值，在阀值右侧的样本判断为异常值。左下和右下两张图均是用不同颜色来表示异常值，只是阀值略有不同。可以观察到那一小撮异常值被正确的判断出来，但也有两个正常值被误判为异常值，此时需要调整参数。<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-Juu6Ox8ANAQ/T_1RCpCAK-I/AAAAAAAABB8/4T9WJAC-sfQ/s1600/Rplot02.jpeg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-Juu6Ox8ANAQ/T_1RCpCAK-I/AAAAAAAABB8/4T9WJAC-sfQ/s1600/Rplot02.jpeg" /></a></div><br /><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><span style="color: #666666; font-style: italic;"># 基于稳健马氏距离的多元异常值检验</span><br />res2 &lt;-aq.plot<span style="color: #009900;">(</span>z<span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 返回异常值的编号</span><br /><a href="http://inside-r.org/r-doc/base/which"><span style="color: #003399;">which</span></a><span style="color: #009900;">(</span>res2$outliers==T<span style="color: #009900;">)</span></span></pre><br />如果数据的维数过高，例如基因数据那样几千个变量，数据之间变得稀疏，从而使得距离不再有很大意义。此时可以融合主成分降维的思路来进行异常值检验。mvoutlier包中提供了<b>pcout</b>函数来进行高维空间异常检验。下面是以swiss数据集为例来判断异常值。<br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><span style="color: #666666; font-style: italic;"># 在高维空间中的异常值检验</span><br /><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/datasets/swiss"><span style="color: #003399;">swiss</span></a><span style="color: #009900;">)</span><br />res3 &lt;- pcout<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/datasets/swiss"><span style="color: #003399;">swiss</span></a><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 返回异常值的编号</span><br /><a href="http://inside-r.org/r-doc/base/which"><span style="color: #003399;">which</span></a><span style="color: #009900;">(</span>res3$wfinal01==<span style="color: #cc66cc;">0</span><span style="color: #009900;">)</span></span></pre></div></div><br />参考资料：<br /><a href="http://computerwranglers.com/Com531/Handouts/Mahalanobis.pdf">A Multivariate outlier detection method</a><br /><a href="http://www.statistik.tuwien.ac.at/forschung/CS/CS-2006-3complete.pdf">outlier identification in high dimension</a><br /><a href="http://www3.ntu.edu.sg/SCE/pakdd2006/tutorial/chawla_tutorial_pakddslides.pdf">Outlier Detection: Principles,Techniques and Applications</a>
