--- 
layout: post
name: ggplot2_29
title: "ggplot2\xE7\xBB\x98\xE5\x9B\xBE\xE5\x85\xA5\xE9\x97\xA8\xE7\xB3\xBB\xE5\x88\x97\xE4\xB9\x8B\xE4\xBA\x94\xEF\xBC\x9A\xE6\x97\xB6\xE9\x97\xB4\xE5\xBA\x8F\xE5\x88\x97\xEF\xBC\x88\xE5\xAE\x8C\xEF\xBC\x89"
date: 2012-01-29 13:32:00 +08:00
categories: 
- ggplot2
- "\xE7\xBB\x98\xE5\x9B\xBE"
permalink: /2012/01/ggplot2_29.html
---
ggplot2包也能对时间序列数据绘图，但在处理上需要有些注意的地方。下面我们以上证指数为例进行作图，首先利用quantmod包从yahoo数据源获取从1997年以来的数据，存于变量SSEC中，抽取收盘数字，然后分别提取时间数据和指数数值，绘图结果如下图。<br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/quantmod">quantmod</a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/ggplot2">ggplot2</a><span style="color: #009900;">)</span><br />getSymbols<span style="color: #009900;">(</span><span style="color: blue;">'^SSEC'</span><span style="color: #339933;">,</span>src=<span style="color: blue;">'yahoo'</span><span style="color: #339933;">,</span>from = <span style="color: blue;">'1997-01-01'</span><span style="color: #009900;">)</span><br /><span style="color: #003399;"><a href="http://inside-r.org/r-doc/base/close">close</a> </span>&lt;- <span style="color: #009900;">(</span>Cl<span style="color: #009900;">(</span>SSEC<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br /><span style="color: #003399;"><a href="http://inside-r.org/r-doc/stats/time">time</a> &lt;- </span>index<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/close"><span style="color: #003399;">close</span></a><span style="color: #009900;">)</span><br />value &lt;- <a href="http://inside-r.org/r-doc/base/as.vector"><span style="color: #003399;">as.vector</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/close"><span style="color: #003399;">close</span></a><span style="color: #009900;">)</span><br />p &lt;- <a href="http://inside-r.org/packages/cran/ggplot">ggplot</a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/data.frame"><span style="color: #003399;">data.frame</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/time"><span style="color: #003399;">time</span></a><span style="color: #339933;">,</span>value<span style="color: #009900;">)</span><span style="color: #339933;">,</span>aes<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/time"><span style="color: #003399;">time</span></a><span style="color: #339933;">,</span>value<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br />p + geom_line<span style="color: #009900;">(</span><span style="color: #009900;">)</span></span></pre></div></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-hYBAeSTVfWk/TyTYrP-wzbI/AAAAAAAAArg/1-_AwARONPo/s1600/Rplot2.jpeg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-hYBAeSTVfWk/TyTYrP-wzbI/AAAAAAAAArg/1-_AwARONPo/s1600/Rplot2.jpeg" /></a></div><br /><a name='more'></a>我们希望能够在图中加入一些其它的说明元素，以丰富视图中所包含的信息。这些信息包括用不同的颜色区块来表示“江核心”和“胡核心”的执政时期，以及对中国证券市场的若干大事件进行标注。最后的代码和结果如下。<br /><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;">yrng &lt;- <a href="http://inside-r.org/r-doc/base/range"><span style="color: #003399;">range</span></a><span style="color: #009900;">(</span>value<span style="color: #009900;">)</span><br />xrng &lt;- <a href="http://inside-r.org/r-doc/base/range"><span style="color: #003399;">range</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/time"><span style="color: #003399;">time</span></a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/utils/data" style="color: #003399;">data</a> &lt;- <a href="http://inside-r.org/r-doc/base/data.frame"><span style="color: #003399;">data.frame</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/start"><span style="color: #003399;">start</span></a>=<a href="http://inside-r.org/r-doc/base/as.Date"><span style="color: #003399;">as.Date</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><span style="color: blue;">'1997-01-01'</span><span style="color: #339933;">,</span><span style="color: blue;">'2003-01-01'</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/stats/end"><span style="color: #003399;">end</span></a>=<a href="http://inside-r.org/r-doc/base/as.Date"><span style="color: #003399;">as.Date</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><span style="color: blue;">'2002-12-30'</span><span style="color: #339933;">,</span><span style="color: blue;">'2012-01-20'</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span>core=<a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><span style="color: blue;">'jiang'</span><span style="color: #339933;">,</span><span style="color: blue;">'hu'</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><br />timepoint &lt;- <a href="http://inside-r.org/r-doc/base/as.Date"><span style="color: #003399;">as.Date</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><span style="color: blue;">'1999-07-02'</span><span style="color: #339933;">,</span><span style="color: blue;">'2001-07-26'</span><span style="color: #339933;">,</span><span style="color: blue;">'2005-04-29'</span><span style="color: #339933;">,</span><span style="color: blue;">'2008-01-10'</span><span style="color: #339933;">,</span><span style="color: blue;">'2010-03-31'</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><br />events &lt;- <a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><span style="color: blue;">'证券法实施'</span><span style="color: #339933;">,</span><span style="color: blue;">'国有股减持'</span><span style="color: #339933;">,</span><span style="color: blue;">'股权分置改革'</span><span style="color: #339933;">,</span><span style="color: blue;">'次贷危机爆发'</span><span style="color: #339933;">,</span><span style="color: blue;">'融资融券试点'</span><span style="color: #009900;">)</span><br />data2 &lt;- <a href="http://inside-r.org/r-doc/base/data.frame"><span style="color: #003399;">data.frame</span></a><span style="color: #009900;">(</span>timepoint<span style="color: #339933;">,</span>events<span style="color: #339933;">,</span>stock=value<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/stats/time"><span style="color: #003399;">time</span></a> %in% timepoint<span style="color: #009900;">]</span><span style="color: #009900;">)</span><br /><div style="overflow: auto;"><br /><div class="geshifilter"><br /><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;">p + geom_line<span style="color: #009900;">(</span><span style="color: #009900;">)</span><br />  + geom_rect<span style="color: #009900;">(</span>aes<span style="color: #009900;">(</span><span style="color: black;">NULL</span><span style="color: #339933;">,</span><span style="color: black;">NULL</span><span style="color: #339933;">,</span>xmin = <a href="http://inside-r.org/r-doc/stats/start"><span style="color: #003399;">start</span></a><span style="color: #339933;">,</span> xmax = <a href="http://inside-r.org/r-doc/stats/end"><span style="color: #003399;">end</span></a><span style="color: #339933;">,</span> fill = core<span style="color: #009900;">)</span><span style="color: #339933;">,</span>ymin = yrng<span style="color: #009900;">[</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">]</span><span style="color: #339933;">,</span>ymax=yrng<span style="color: #009900;">[</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">]</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a> = <a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a><span style="color: #009900;">)</span><br />  + scale_fill_manual<span style="color: #009900;">(</span>values = alpha<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><span style="color: blue;">'blue'</span><span style="color: #339933;">,</span><span style="color: blue;">'red'</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">0.2</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><br />  + geom_text<span style="color: #009900;">(</span>aes<span style="color: #009900;">(</span>timepoint<span style="color: #339933;">,</span> stock<span style="color: #339933;">,</span> label = events<span style="color: #009900;">)</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a> = data2<span style="color: #339933;">,</span>vjust = -<span style="color: #cc66cc;">2</span><span style="color: #339933;">,</span>size = <span style="color: #cc66cc;">5</span><span style="color: #009900;">)</span><br />  + geom_point<span style="color: #009900;">(</span>aes<span style="color: #009900;">(</span>timepoint<span style="color: #339933;">,</span> stock<span style="color: #009900;">)</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a> = data2<span style="color: #339933;">,</span>size = <span style="color: #cc66cc;">5</span><span style="color: #339933;">,</span>colour = alpha<span style="color: #009900;">(</span><span style="color: blue;">'red'</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">0.5</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span></span><a href="http://2.bp.blogspot.com/-FNWe4LZ7e6M/TyTYpxhBTsI/AAAAAAAAArY/3emFZSj4j1A/s1600/Rplot.jpeg" imageanchor="1" style="display: inline !important; font-family: 'Courier New', Courier, monospace; margin-left: 1em; margin-right: 1em; text-align: center;"><img border="0" src="http://2.bp.blogspot.com/-FNWe4LZ7e6M/TyTYpxhBTsI/AAAAAAAAArY/3emFZSj4j1A/s1600/Rplot.jpeg" /></a></pre></div></div></span></pre>
