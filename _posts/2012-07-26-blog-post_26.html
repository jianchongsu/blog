--- 
layout: post
name: blog-post_26
title: "\xE4\xB8\xAD\xE5\x9B\xBD\xE5\x9B\xBD\xE5\x86\x85\xE8\x88\xAA\xE7\xBA\xBF\xE4\xBF\xA1\xE6\x81\xAF\xE7\x9A\x84\xE5\x8F\xAF\xE8\xA7\x86\xE5\x8C\x96"
date: 2012-07-26 15:28:00 +08:00
categories: 
- ggplot2
- "\xE5\x8F\xAF\xE8\xA7\x86\xE5\x8C\x96"
- google
permalink: /2012/07/blog-post_26.html
---
<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-v0pXLV2tsRo/UBDusfe_cVI/AAAAAAAABD8/Qw0hjaTVKyQ/s1600/airline.JPG" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" height="508" src="http://4.bp.blogspot.com/-v0pXLV2tsRo/UBDusfe_cVI/AAAAAAAABD8/Qw0hjaTVKyQ/s640/airline.JPG" width="640" /></a></div>上图是对国内机场和航线信息进行了一个简单的可视化。圆点表示了中国163个机场的位置，线条显示了5381条航线。之前曾在<a href="http://spatialanalysis.co.uk/2012/06/mapping-worlds-biggest-airlines/">这个网站</a>上<span style="background-color: white;">见到了作者用R语言来对全世界的航线进行可视化。正所谓见贤思齐，本图就是模仿山寨的结果。但是这个图的生成没有原文那么复杂，所用到的地理图形包和步骤也与原例略有不同，比较失败的是没有展现出原图的夜景效果。具体实施的步骤如下：</span><br /><br /><ul><li><span style="background-color: white;">从这个</span><a href="http://openflights.org/data.html" style="background-color: white;">网站</a><span style="background-color: white;">下载到机场数据和航线数据；</span></li><li><span style="background-color: white;">从中挑选出中国的机场和国内航线，并加以整理；</span></li><li><span style="background-color: white;">用ggmap包读取谷歌地图；</span></li><li><span style="background-color: white;">将机场和航线信息绘制在地图上。</span></li></ul><br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R"><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;"><a name='more'></a><span style="font-family: 'Courier New', Courier, monospace;">library</span></span></a><span style="font-family: 'Courier New', Courier, monospace;"><span style="color: #009900;">(</span>ggmap<span style="color: #009900;">)</span><br />data.port &lt;- <a href="http://inside-r.org/r-doc/utils/read.csv"><span style="color: #003399;">read.csv</span></a><span style="color: #009900;">(</span><span style="color: blue;">'d:<span style="color: #000099;">\\</span>airports.dat'</span><span style="color: #339933;">,</span>F<span style="color: #009900;">)</span><br />data.line &lt;- <a href="http://inside-r.org/r-doc/utils/read.csv"><span style="color: #003399;">read.csv</span></a><span style="color: #009900;">(</span><span style="color: blue;">'d:<span style="color: #000099;">\\</span>routes.dat'</span><span style="color: #339933;">,</span>F<span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/stringr">stringr</a><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 找到中国的机场</span><br />portinchina &lt;- str_detect<span style="color: #009900;">(</span>data.port<span style="color: #009900;">[</span><span style="color: #339933;">,</span><span style="color: blue;">'V4'</span><span style="color: #009900;">]</span><span style="color: #339933;">,</span> <span style="color: blue;">"China"</span><span style="color: #009900;">)</span><br />chinaport &lt;- data.port<span style="color: #009900;">[</span>portinchina<span style="color: #339933;">,</span><span style="color: #009900;">]</span><br /><span style="color: #666666; font-style: italic;"># 去除少数几个没有编号的机场</span><br />chinaport &lt;-chinaport<span style="color: #009900;">[</span>chinaport$V5!=<span style="color: blue;">''</span><span style="color: #339933;">,</span><br />                      <a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><span style="color: blue;">'V3'</span><span style="color: #339933;">,</span><span style="color: blue;">'V5'</span><span style="color: #339933;">,</span><span style="color: blue;">'V7'</span><span style="color: #339933;">,</span><span style="color: blue;">'V8'</span><span style="color: #339933;">,</span><span style="color: blue;">'V9'</span><span style="color: #009900;">)</span><span style="color: #009900;">]</span><br /><a href="http://inside-r.org/r-doc/base/names"><span style="color: #003399;">names</span></a><span style="color: #009900;">(</span>chinaport<span style="color: #009900;">)</span> &lt;- <a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><span style="color: blue;">'city'</span><span style="color: #339933;">,</span><span style="color: blue;">'code'</span><span style="color: #339933;">,</span><span style="color: blue;">'lan'</span><span style="color: #339933;">,</span><span style="color: blue;">'lon'</span><span style="color: #339933;">,</span><span style="color: blue;">'att'</span><span style="color: #009900;">)</span><br />&nbsp;<br /><span style="color: #666666; font-style: italic;"># 找出国内航班</span><br />lineinchina &lt;- <span style="color: #009900;">(</span>data.line<span style="color: #009900;">[</span><span style="color: #339933;">,</span><span style="color: blue;">'V3'</span><span style="color: #009900;">]</span> %in% chinaport$code<span style="color: #009900;">)</span> &amp; <span style="color: #009900;">(</span>data.line<span style="color: #009900;">[</span><span style="color: #339933;">,</span><span style="color: blue;">'V5'</span><span style="color: #009900;">]</span> %in% chinaport$code<span style="color: #009900;">)</span><br />chinaline &lt;- data.line<span style="color: #009900;">[</span>lineinchina<span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><span style="color: blue;">'V3'</span><span style="color: #339933;">,</span><span style="color: blue;">'V5'</span><span style="color: #339933;">,</span><span style="color: blue;">'V9'</span><span style="color: #009900;">)</span><span style="color: #009900;">]</span><br /><a href="http://inside-r.org/r-doc/base/names"><span style="color: #003399;">names</span></a><span style="color: #009900;">(</span>chinaline<span style="color: #009900;">)</span> &lt;- <a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><span style="color: blue;">'source'</span><span style="color: #339933;">,</span><span style="color: blue;">'destination'</span><span style="color: #339933;">,</span><span style="color: blue;">'equipment'</span><span style="color: #009900;">)</span><br />&nbsp;<br /><span style="color: #666666; font-style: italic;">#构建一个函数，根据机场编码得到经纬度</span><br />findposition &lt;- <a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399;">function</span></a><span style="color: #009900;">(</span>code<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />    <a href="http://inside-r.org/r-doc/utils/find"><span style="color: #003399;">find</span></a> &lt;- chinaport$code==code<br />    x &lt;- chinaport<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/utils/find"><span style="color: #003399;">find</span></a><span style="color: #339933;">,</span><span style="color: blue;">'lon'</span><span style="color: #009900;">]</span><br />    y &lt;- chinaport<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/utils/find"><span style="color: #003399;">find</span></a><span style="color: #339933;">,</span><span style="color: blue;">'lan'</span><span style="color: #009900;">]</span><br />    <a href="http://inside-r.org/r-doc/base/return"><span style="color: #003399;">return</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/data.frame"><span style="color: #003399;">data.frame</span></a><span style="color: #009900;">(</span>x<span style="color: #339933;">,</span>y<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br /><span style="color: #009900;">}</span><br />&nbsp;<br /><span style="color: #666666; font-style: italic;"># 将机场编码转为经纬度</span><br />from &lt;- <a href="http://inside-r.org/r-doc/base/lapply"><span style="color: #003399;">lapply</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/as.character"><span style="color: #003399;">as.character</span></a><span style="color: #009900;">(</span>chinaline$source<span style="color: #009900;">)</span><span style="color: #339933;">,</span>findposition<span style="color: #009900;">)</span><br />from &lt;- <a href="http://inside-r.org/r-doc/base/do.call"><span style="color: #003399;">do.call</span></a><span style="color: #009900;">(</span><span style="color: blue;">'rbind'</span><span style="color: #339933;">,</span>from<span style="color: #009900;">)</span><br />from$group &lt;- <span style="color: #cc66cc;">1</span>:<a href="http://inside-r.org/r-doc/base/dim"><span style="color: #003399;">dim</span></a><span style="color: #009900;">(</span>from<span style="color: #009900;">)</span><span style="color: #009900;">[</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">]</span><br /><a href="http://inside-r.org/r-doc/base/names"><span style="color: #003399;">names</span></a><span style="color: #009900;">(</span>from<span style="color: #009900;">)</span> &lt;- <a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><span style="color: blue;">'lon'</span><span style="color: #339933;">,</span><span style="color: blue;">'lan'</span><span style="color: #339933;">,</span><span style="color: blue;">'group'</span><span style="color: #009900;">)</span><br />&nbsp;<br />to &lt;- <a href="http://inside-r.org/r-doc/base/lapply"><span style="color: #003399;">lapply</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/as.character"><span style="color: #003399;">as.character</span></a><span style="color: #009900;">(</span>chinaline$destination<span style="color: #009900;">)</span><span style="color: #339933;">,</span>findposition<span style="color: #009900;">)</span><br />to &lt;- <a href="http://inside-r.org/r-doc/base/do.call"><span style="color: #003399;">do.call</span></a><span style="color: #009900;">(</span><span style="color: blue;">'rbind'</span><span style="color: #339933;">,</span>to<span style="color: #009900;">)</span><br />to$group &lt;-<span style="color: #cc66cc;">1</span>:<a href="http://inside-r.org/r-doc/base/dim"><span style="color: #003399;">dim</span></a><span style="color: #009900;">(</span>to<span style="color: #009900;">)</span><span style="color: #009900;">[</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">]</span><br /><a href="http://inside-r.org/r-doc/base/names"><span style="color: #003399;">names</span></a><span style="color: #009900;">(</span>to<span style="color: #009900;">)</span> &lt;-<a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><span style="color: blue;">'lon'</span><span style="color: #339933;">,</span><span style="color: blue;">'lan'</span><span style="color: #339933;">,</span><span style="color: blue;">'group'</span><span style="color: #009900;">)</span><br />data.line &lt;- <a href="http://inside-r.org/r-doc/base/rbind"><span style="color: #003399;">rbind</span></a><span style="color: #009900;">(</span>from<span style="color: #339933;">,</span>to<span style="color: #009900;">)</span><br />temp&lt;- data.line<span style="color: #009900;">[</span>data.line$group&lt;<span style="color: #cc66cc;">100</span><span style="color: #339933;">,</span><span style="color: #009900;">]</span><br /><span style="color: #666666; font-style: italic;"># 用ggmap包从google读取地图数据，并将之前的数据标注在地图上。</span><br />ggmap<span style="color: #009900;">(</span>get_googlemap<span style="color: #009900;">(</span>center = <span style="color: blue;">'china'</span><span style="color: #339933;">,</span> zoom=<span style="color: #cc66cc;">4</span><span style="color: #339933;">,</span><br />                    maptype=<span style="color: blue;">'roadmap'</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span>extent=<span style="color: blue;">'device'</span><span style="color: #009900;">)</span>+<br />    geom_point<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>=chinaport<span style="color: #339933;">,</span>aes<span style="color: #009900;">(</span>x=lon<span style="color: #339933;">,</span>y=lan<span style="color: #009900;">)</span><span style="color: #339933;">,</span><br />               colour = <span style="color: blue;">'red4'</span><span style="color: #339933;">,</span>alpha=<span style="color: #cc66cc;">0.8</span><span style="color: #009900;">)</span>+<br />    geom_line<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>=data.line<span style="color: #339933;">,</span>aes<span style="color: #009900;">(</span>x=lon<span style="color: #339933;">,</span>y=lan<span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/grDevices/group"><span style="color: #003399;">group</span></a>=<a href="http://inside-r.org/r-doc/grDevices/group"><span style="color: #003399;">group</span></a><span style="color: #009900;">)</span><span style="color: #339933;">,</span><br />              size=<span style="color: #cc66cc;">0.1</span><span style="color: #339933;">,</span>alpha=<span style="color: #cc66cc;">0.05</span><span style="color: #339933;">,</span>color=<span style="color: blue;">'red4'</span><span style="color: #009900;">)</span></span></pre></div></div><br />有兴趣的同学还可以进一步研究，哪个航线最远，分布如何，哪条航线最多，航线飞机档次如何，哪个机场海拔最高，哪个机场最忙....<br /><div><br /></div>
