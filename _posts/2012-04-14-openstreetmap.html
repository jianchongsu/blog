--- 
layout: post
name: openstreetmap
title: "\xE5\x9F\xBA\xE4\xBA\x8EOpenStreetMap\xE7\x9A\x84\xE5\x9C\xB0\xE7\x90\x86\xE4\xBF\xA1\xE6\x81\xAF\xE7\xBB\x98\xE5\x9B\xBE"
date: 2012-04-14 20:00:00 +08:00
categories: 
- "\xE5\x8F\xAF\xE8\xA7\x86\xE5\x8C\x96"
- google
permalink: /2012/04/openstreetmap.html
---
<b>开放街道地图（OpenStreetMap，简称OSM）</b>是一个网上地图协作计划，目标是创造一个内容自由且能让所有人编辑的世界地图。OSM可以根据用户的手持GPS装置、航空摄影照片、卫星影像、其他自由内容甚至单靠用户对目标区域的知识绘制。OSM网站的灵感来自维基百科等网站。这可从该网地图页的“编辑”按钮及其完整修订历史获知。经注册的用户可上载GPS路径及使用内置的编辑程式编辑数据。2010年海地大地震中，OpenStreetMap极大地提高了地面搜救小队的工作效率。这个地图以GeoEye等公司提供的最新卫星照片为基础，又加入了很多新资料，工作人员和志愿者可以随时用随身的电脑或手机在地图上即时标注救护站、帐篷和倒塌的大桥。2012年4月，继苹果和Foursquare相继放弃使用谷歌地图后，维基百科也放弃使用谷歌地图，转向使用OpenStreetMap。<br /><br />本例结合<b>OpenStreetMap包、XLM包和ggplot2包</b>来介绍如何整合地图资料和其它数据。我们的任务是将中国城区人口最多的前十位城市标注在地图上。基本步骤如下：<br /><ul><li>从wikipedia上抓取城市人口资料；</li><li>利用Google API获得十个城市的经纬度；</li><li>根据上面两类数据渲染得到地图如下(点击可看大图)，圆的大小显示了城市居民数的多寡。</li></ul><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://thumbsnap.com/i/UPnjHYM3.png" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" height="526" src="http://thumbsnap.com/i/UPnjHYM3.png" width="640" /></a></div><br /><a name='more'></a>R代码如下：<br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/XML">XML</a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;">library</span></a><span style="color: #009900;">(</span>OpenStreetMap<span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/ggplot2">ggplot2</a><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 从wiki获取中国前十大城市人口数据</span><br /><a href="http://inside-r.org/r-doc/base/url"><span style="color: #003399;">url</span></a> &lt;-<span style="color: blue;">'http://zh.wikipedia.org/wiki/%E4%B8%AD%E5%9B%BD%E5%9F%8E%E5%B8%82%E5%88%97%E8%A1%A8'</span><br />tables &lt;- readHTMLTable<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/url"><span style="color: #003399;">url</span></a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/raw"><span style="color: #003399;">raw</span></a> &lt;- tables<span style="color: #009900;">[</span><span style="color: #009900;">[</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">]</span><span style="color: #009900;">]</span><br /><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a> &lt;- <a href="http://inside-r.org/r-doc/base/raw"><span style="color: #003399;">raw</span></a><span style="color: #009900;">[</span><span style="color: #cc66cc;">1</span>:<span style="color: #cc66cc;">10</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">2</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">4</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">5</span><span style="color: #009900;">)</span><span style="color: #009900;">]</span><br /><a href="http://inside-r.org/r-doc/base/names"><span style="color: #003399;">names</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a><span style="color: #009900;">)</span> &lt;- <a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><span style="color: blue;">'cname'</span><span style="color: #339933;">,</span><span style="color: blue;">'name'</span><span style="color: #339933;">,</span><span style="color: blue;">'pop'</span><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>$name &lt;- <a href="http://inside-r.org/r-doc/base/as.character"><span style="color: #003399;">as.character</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>$name<span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 将人口数从字符型转为数值型</span><br /><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>$pop &lt;- <a href="http://inside-r.org/r-doc/base/as.numeric"><span style="color: #003399;">as.numeric</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/gsub"><span style="color: #003399;">gsub</span></a><span style="color: #009900;">(</span><span style="color: blue;">','</span><span style="color: #339933;">,</span><span style="color: blue;">''</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>$pop<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br />&nbsp;<br /><span style="color: #666666; font-style: italic;"># 建立函数，输入参数为城市名称，返回经纬坐标</span><br /><span style="color: #666666; font-style: italic;"># 先利用google API得到xml形式结果，再用XML包函数提取经纬度</span><br />geoencode &lt;- <a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399;">function</span></a><span style="color: #009900;">(</span>name<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />  requestUrl&lt;-<a href="http://inside-r.org/r-doc/base/paste"><span style="color: #003399;">paste</span></a><span style="color: #009900;">(</span><br />   <span style="color: blue;">"http://maps.googleapis.com/maps/api/geocode/xml?address="</span><span style="color: #339933;">,</span><br />   name<span style="color: #339933;">,</span><span style="color: blue;">"&amp;sensor=false"</span><span style="color: #339933;">,</span> sep=<span style="color: blue;">""</span><span style="color: #009900;">)</span><br />  xmlResult&lt;-xmlTreeParse<span style="color: #009900;">(</span>requestUrl<span style="color: #339933;">,</span>isURL=<span style="color: black;">TRUE</span><span style="color: #009900;">)</span><br />  root &lt;- xmlRoot<span style="color: #009900;">(</span>xmlResult<span style="color: #009900;">)</span><br />  latitude &lt;-xmlValue<span style="color: #009900;">(</span>root<span style="color: #009900;">[</span><span style="color: #009900;">[</span><span style="color: blue;">'result'</span><span style="color: #009900;">]</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #009900;">[</span><span style="color: blue;">'geometry'</span><span style="color: #009900;">]</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #009900;">[</span><span style="color: blue;">'location'</span><span style="color: #009900;">]</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #009900;">[</span><span style="color: blue;">'lat'</span><span style="color: #009900;">]</span><span style="color: #009900;">]</span><span style="color: #009900;">)</span><br />  longitude &lt;-xmlValue<span style="color: #009900;">(</span>root<span style="color: #009900;">[</span><span style="color: #009900;">[</span><span style="color: blue;">'result'</span><span style="color: #009900;">]</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #009900;">[</span><span style="color: blue;">'geometry'</span><span style="color: #009900;">]</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #009900;">[</span><span style="color: blue;">'location'</span><span style="color: #009900;">]</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #009900;">[</span><span style="color: blue;">'lng'</span><span style="color: #009900;">]</span><span style="color: #009900;">]</span><span style="color: #009900;">)</span><br />  <a href="http://inside-r.org/r-doc/base/return"><span style="color: #003399;">return</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/list"><span style="color: #003399;">list</span></a><span style="color: #009900;">(</span>latitude=latitude<span style="color: #339933;">,</span>longitude=longitude<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br /><span style="color: #009900;">}</span><br /><span style="color: #666666; font-style: italic;"># 得到十个城市的经纬度，结果为矩阵形式，整合为数据框</span><br />tempdata &lt;- <a href="http://inside-r.org/r-doc/base/sapply"><span style="color: #003399;">sapply</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>$name<span style="color: #339933;">,</span>geoencode<span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a> &lt;- <a href="http://inside-r.org/r-doc/base/cbind"><span style="color: #003399;">cbind</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/data.frame"><span style="color: #003399;">data.frame</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/t"><span style="color: #003399;">t</span></a><span style="color: #009900;">(</span>tempdata<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>$latitude &lt;-<a href="http://inside-r.org/r-doc/base/as.numeric"><span style="color: #003399;">as.numeric</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/unlist"><span style="color: #003399;">unlist</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>$latitude<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>$longitude &lt;-<a href="http://inside-r.org/r-doc/base/as.numeric"><span style="color: #003399;">as.numeric</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/unlist"><span style="color: #003399;">unlist</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>$longitude<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 将经纬度转为open street map绘图所需的输入参数</span><br /><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a> &lt;- <a href="http://inside-r.org/r-doc/base/cbind"><span style="color: #003399;">cbind</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a><span style="color: #339933;">,</span>projectMercator<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>$latitude<span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>$longitude<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 获取从东经100到125，北纬21到41之间的地图资料</span><br />map &lt;- openmap<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">41</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">100</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">21</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">125</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span>zoom=<span style="color: #cc66cc;">5</span><span style="color: #339933;">,</span>type = <span style="color: blue;">"osm"</span><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 利用ggplot2绘图包增加城市散点，点的大小表示人口</span><br />autoplot<span style="color: #009900;">(</span>map<span style="color: #009900;">)</span>+geom_point<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>=<a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a><span style="color: #339933;">,</span>aes<span style="color: #009900;">(</span>x=x<span style="color: #339933;">,</span>y=y<br />  <span style="color: #339933;">,</span>size=pop<span style="color: #009900;">)</span><span style="color: #339933;">,</span><a href="http://inside-r.org/packages/cran/shape">shape</a>=<span style="color: #cc66cc;">16</span><span style="color: #339933;">,</span>colour=<span style="color: blue;">'gold'</span><span style="color: #339933;">,</span>alpha = <span style="color: #cc66cc;">0.6</span><span style="color: #009900;">)</span>+<br />  geom_point<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>=<a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a><span style="color: #339933;">,</span>aes<span style="color: #009900;">(</span>x=x<span style="color: #339933;">,</span>y=y<br />  <span style="color: #339933;">,</span>size=pop<span style="color: #009900;">)</span><span style="color: #339933;">,</span><a href="http://inside-r.org/packages/cran/shape">shape</a>=<span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span>colour=<span style="color: blue;">'red4'</span><span style="color: #009900;">)</span>+<br />  scale_size_continuous<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/range"><span style="color: #003399;">range</span></a>= <a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">8</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">16</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>+<br />  opts<span style="color: #009900;">(</span>axis.line=theme_blank<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span>axis.text.x=theme_blank<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><br />       axis.text.y=theme_blank<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span>axis.ticks=theme_blank<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><br />       axis.title.x=theme_blank<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><br />       axis.title.y=theme_blank<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> +<br />  geom_text<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>=<a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a><span style="color: #339933;">,</span>colour=<span style="color: blue;">'black'</span><span style="color: #339933;">,</span><br />            aes<span style="color: #009900;">(</span>x=x<span style="color: #339933;">,</span>y=y<span style="color: #339933;">,</span>label=cname<span style="color: #009900;">)</span><span style="color: #339933;">,</span>hjust=<span style="color: #cc66cc;">1.4</span><span style="color: #339933;">,</span>vjust=<span style="color: #cc66cc;">0</span><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 保存图片</span><br />ggsave<span style="color: #009900;">(</span><span style="color: blue;">"plot1.png"</span><span style="color: #339933;">,</span> dpi=<span style="color: #cc66cc;">600</span><span style="color: #009900;">)</span></span></pre></div></div>也可以修改map函数中的type参数将地图渲染成卫星图。<br /><div class="separator" style="clear: both; text-align: center;"></div><b><span style="color: #666666;">参考资料：</span></b><br /><b><span style="color: #666666;">Data mashups with R</span></b><br /><a href="http://www.r-bloggers.com/simple-data-mining-and-plotting-data-on-a-map-with-ggplot2/">R-Blogger文章</a><br /><br />
