--- 
layout: post
name: ggmap
title: "\xE7\x94\xA8ggmap\xE5\x8C\x85\xE8\xBF\x9B\xE8\xA1\x8C\xE5\x9C\xB0\xE9\x9C\x87\xE6\x95\xB0\xE6\x8D\xAE\xE7\x9A\x84\xE5\x8F\xAF\xE8\xA7\x86\xE5\x8C\x96"
date: 2012-06-28 11:23:00 +08:00
categories: 
- ggplot2
- "\xE5\x8A\xA8\xE7\x94\xBB"
permalink: /2012/06/ggmap.html
---
<div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-jGEpq3RPymc/T-v6fAsnezI/AAAAAAAABAI/vhgiCwp3U8c/s1600/Rplot03.jpeg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-jGEpq3RPymc/T-v6fAsnezI/AAAAAAAABAI/vhgiCwp3U8c/s1600/Rplot03.jpeg" /></a></div><span style="background-color: white;">最近又发现了一个比较好玩的包<b>ggmap</b>。从名字上可以猜测出来，它的作用就是将ggplot2和map相结合。这样R语言用户能方便的获取各种静态地图数据，并在其基础上使用强大的ggplot绘图工具。ggmap包整合了四种地图资源，分别是Google、OpenStreetMaps、Stamen和Cloudmade。为了演示ggmap的作用，本例是从<a href="http://data.earthquake.cn/datashare/globeEarthquake_csn.html" target="_blank">地震信息网</a>获取最近一周的地震数据，得到其经纬度，然后以散点形式绘制在google地图上，另外也显示地震发生的密度估计。这个思路本质上和之前的<a href="http://xccds1977.blogspot.com/2012/04/openstreetmap.html" target="_blank">一篇博文</a>是一致的，但用ggmap包实现起来更为简单。</span><br /><br /><a name='more'></a><span style="background-color: white; color: #666666; font-family: 'Courier New', Courier, monospace; font-style: italic;"># 加载扩展包</span><br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;">library</span></a><span style="color: #009900;">(</span>ggmap<span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/animation">animation</a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/XML">XML</a><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 从网页上抓取数据，并进行清理</span><br />webpage &lt;-<span style="color: blue;">'http://data.earthquake.cn/datashare/globeEarthquake_csn.html'</span><br />tables &lt;- readHTMLTable<span style="color: #009900;">(</span>webpage<span style="color: #339933;">,</span>stringsAsFactors = <span style="color: black;">FALSE</span><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/raw"><span style="color: #003399;">raw</span></a> &lt;- tables<span style="color: #009900;">[</span><span style="color: #009900;">[</span><span style="color: #cc66cc;">6</span><span style="color: #009900;">]</span><span style="color: #009900;">]</span><br /><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a> &lt;- <a href="http://inside-r.org/r-doc/base/raw"><span style="color: #003399;">raw</span></a><span style="color: #009900;">[</span>-<span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><span style="color: blue;">'V1'</span><span style="color: #339933;">,</span><span style="color: blue;">'V3'</span><span style="color: #339933;">,</span><span style="color: blue;">'V4'</span><span style="color: #009900;">)</span><span style="color: #009900;">]</span><br /><a href="http://inside-r.org/r-doc/base/names"><span style="color: #003399;">names</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a><span style="color: #009900;">)</span> &lt;- <a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399;">c</span></a><span style="color: #009900;">(</span><span style="color: blue;">'date'</span><span style="color: #339933;">,</span><span style="color: blue;">'lan'</span><span style="color: #339933;">,</span><span style="color: blue;">'lon'</span><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>$lan &lt;- <a href="http://inside-r.org/r-doc/base/as.numeric"><span style="color: #003399;">as.numeric</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>$lan<span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>$lon &lt;- <a href="http://inside-r.org/r-doc/base/as.numeric"><span style="color: #003399;">as.numeric</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>$lon<span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>$date &lt;- <a href="http://inside-r.org/r-doc/base/as.Date"><span style="color: #003399;">as.Date</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>$date<span style="color: #339933;">,</span>  <span style="color: blue;">"%Y-%m-%d"</span><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 用ggmap包从google读取地图数据，并将之前的数据标注在地图上。</span><br />ggmap<span style="color: #009900;">(</span>get_googlemap<span style="color: #009900;">(</span>center = <span style="color: blue;">'china'</span><span style="color: #339933;">,</span> zoom=<span style="color: #cc66cc;">4</span><span style="color: #339933;">,</span>maptype=<span style="color: blue;">'terrain'</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span>extent=<span style="color: blue;">'device'</span><span style="color: #009900;">)</span>+<br />geom_point<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>=<a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a><span style="color: #339933;">,</span>aes<span style="color: #009900;">(</span>x=lon<span style="color: #339933;">,</span>y=lan<span style="color: #009900;">)</span><span style="color: #339933;">,</span>colour = <span style="color: blue;">'red'</span><span style="color: #339933;">,</span>alpha=<span style="color: #cc66cc;">0.7</span><span style="color: #009900;">)+</span></span></pre><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;">stat_density2d(aes(x=lon,y=lan,fill=..level..,alpha=..level..),<br />                   size=2,bins=4,data=data,geom='polygon')+<br />                       opts(legend.position = "none")<br />&nbsp;<br /></span></pre></div></div>更好玩的作法就是根据地震发生的日期生成不同的静态图，然后用<b>animaiton包</b>将其整合为一个gif动画。<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-9YXdEBw0MK4/T-vM54QcGyI/AAAAAAAAA_o/jr3aKLj69eQ/s1600/animation.gif" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-9YXdEBw0MK4/T-vM54QcGyI/AAAAAAAAA_o/jr3aKLj69eQ/s1600/animation.gif" /></a></div><br /><pre class="r geshifilter-R"><span style="font-family: 'Courier New', Courier, monospace;"><span style="color: #666666; font-style: italic;"># 为了生成动画，先准备好一个绘图函数</span><br />plotfunc &lt;- <a href="http://inside-r.org/r-doc/base/function"><span style="color: #003399;">function</span></a><span style="color: #009900;">(</span>x<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />    <a href="http://inside-r.org/r-doc/stats/df"><span style="color: #003399;">df</span></a> &lt;- <a href="http://inside-r.org/r-doc/base/subset"><span style="color: #003399;">subset</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a><span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/date"><span style="color: #003399;">date</span></a> &lt;= x<span style="color: #009900;">)</span><br />    <a href="http://inside-r.org/r-doc/stats/df"><span style="color: #003399;">df</span></a>$lan &lt;- <a href="http://inside-r.org/r-doc/base/as.numeric"><span style="color: #003399;">as.numeric</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/df"><span style="color: #003399;">df</span></a>$lan<span style="color: #009900;">)</span><br />    <a href="http://inside-r.org/r-doc/stats/df"><span style="color: #003399;">df</span></a>$lon &lt;- <a href="http://inside-r.org/r-doc/base/as.numeric"><span style="color: #003399;">as.numeric</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/stats/df"><span style="color: #003399;">df</span></a>$lon<span style="color: #009900;">)</span><br />    p &lt;- ggmap<span style="color: #009900;">(</span>get_googlemap<span style="color: #009900;">(</span>center = <span style="color: blue;">'china'</span><span style="color: #339933;">,</span> zoom=<span style="color: #cc66cc;">4</span><span style="color: #339933;">,</span>maptype=<span style="color: blue;">'terrain'</span><span style="color: #009900;">)</span><span style="color: #339933;">,,</span>extent=<span style="color: blue;">'device'</span><span style="color: #009900;">)</span>+<br />        geom_point<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>=<a href="http://inside-r.org/r-doc/stats/df"><span style="color: #003399;">df</span></a><span style="color: #339933;">,</span>aes<span style="color: #009900;">(</span>x=lon<span style="color: #339933;">,</span>y=lan<span style="color: #009900;">)</span><span style="color: #339933;">,</span>colour = <span style="color: blue;">'red'</span><span style="color: #339933;">,</span>alpha=<span style="color: #cc66cc;">0.7</span><span style="color: #009900;">)</span><br /><span style="color: #009900;">}</span><br /><span style="color: #666666; font-style: italic;"># 获取地震的日期</span><br /><a href="http://inside-r.org/r-doc/stats/time"><span style="color: #003399;">time</span></a> &lt;- <a href="http://inside-r.org/r-doc/base/sort"><span style="color: #003399;">sort</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/unique"><span style="color: #003399;">unique</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399;">data</span></a>$date<span style="color: #009900;">)</span><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 生成并保存动画</span><br />saveMovie<span style="color: #009900;">(</span><span style="color: black;">for</span><span style="color: #009900;">(</span> i <span style="color: black;">in</span> <a href="http://inside-r.org/r-doc/stats/time"><span style="color: #003399;">time</span></a><span style="color: #009900;">)</span> <a href="http://inside-r.org/r-doc/base/print"><span style="color: #003399;">print</span></a><span style="color: #009900;">(</span>plotfunc<span style="color: #009900;">(</span>i<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span></span></pre><br />ggmap包中还有其它一些非常有用的函数。例如<b>geocode</b>函数可以根据地名字符串来查询经纬度，<b>gglocator</b>类似于基本包中的locator，它根据鼠标的点选来返回其坐标值。另外一个是<b>mapdist</b>函数，可以返回两点之间的地图距离和行驶时间。结合这几个函数可以直接在R中绘制地图，选择你的出发地和目标地，然后获得两地之间的距离。当然你还可以配合GPS等其它数据，创造出其它有意思的图形。
