--- 
layout: post
name: xmlxpath
title: "XML\xE5\x92\x8CXPath\xE4\xBD\xBF\xE7\x94\xA8\xE6\x96\xB9\xE6\xB3\x95\xE5\xA4\x87\xE5\xBF\x98"
date: 2013-02-04 19:27:00 +08:00
categories: 
- "\xE6\x95\xB0\xE6\x8D\xAE\xE7\xA7\x91\xE5\xAD\xA6"
- "\xE6\x95\xB0\xE6\x8D\xAE\xE9\xA2\x84\xE5\xA4\x84\xE7\x90\x86"
permalink: /2013/02/xmlxpath.html
---
<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-fH8iQy-1k7c/UQ-ZMmGxpVI/AAAAAAAABX4/-E4hXsIylXA/s1600/XML.gif" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="248" src="http://4.bp.blogspot.com/-fH8iQy-1k7c/UQ-ZMmGxpVI/AAAAAAAABX4/-E4hXsIylXA/s400/XML.gif" width="400" /></a></div>如果把XML看作传统的关系数据库，那么XPath就是SQL。R语言中的XML包可用来解析处理XML或是HTML数据。在<a href="http://xccds1977.blogspot.com/2011/09/xml.html">之前的文章</a>中，我们了解到readHTMLTable函数，如果页面中的数据是一个规整的表格，用它是很方便的，但如果页面中是一些非结构化的数据，就要用到XML包中的其它函数了。其中最重要两个函数是xmlTreeParse()和getNodeSet()，前者负责抓取页面数据并形成树状结构，后者对抓取的数据根据<a href="http://www.w3school.com.cn/xpath/index.asp">XPath语法</a>来选取特定的节点集合。下面用一个简单的例子来看一下这两个函数配合使用的效果。<br /><br /><a name='more'></a>这里是一个简单的<a href="http://www.w3school.com.cn/example/xmle/books.xml">XML文档</a>，下面是一些简单的节点选取操作：<br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R"><a href="http://inside-r.org/r-doc/base/library" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">library</span></a><span style="color: #009900; font-family: monospace;">(</span><a href="http://inside-r.org/packages/cran/XML" style="font-family: monospace;">XML</a><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"><br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 解析XML文件</span><span style="font-family: monospace;"><br />doc </span><span style="font-family: monospace;">&lt;-</span><span style="font-family: monospace;"> xmlParse</span><span style="color: #009900; font-family: monospace;">(</span><span style="color: blue; font-family: monospace;">'http://www.w3school.com.cn/example/xmle/books.xml'</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"><br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 选取属于 bookstore 子元素的第一个 book 元素</span><span style="font-family: monospace;"><br />getNodeSet</span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">doc</span><span style="color: #339933; font-family: monospace;">,</span><span style="color: blue; font-family: monospace;">'/bookstore/book[1]'</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"> <br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 选取属于 bookstore 子元素的最后一个 book 元素。</span><span style="font-family: monospace;"><br />getNodeSet</span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">doc</span><span style="color: #339933; font-family: monospace;">,</span><span style="color: blue; font-family: monospace;">'/bookstore/book[last()]'</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"> <br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 选取最前面的两个属于 bookstore 元素的子元素的 book 元素</span><span style="font-family: monospace;"><br />getNodeSet</span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">doc</span><span style="color: #339933; font-family: monospace;">,</span><span style="color: blue; font-family: monospace;">'/bookstore/book[position()&lt;3]'</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"> <br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 选取所有拥有名为 lang 的属性的 title 元素。</span><span style="font-family: monospace;"><br />getNodeSet</span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">doc</span><span style="color: #339933; font-family: monospace;">,</span><span style="color: blue; font-family: monospace;">'//title[@lang]'</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"> <br /></span><span style="color: #666666; font-family: monospace; font-style: italic;">#选取所有 title 元素，且这些元素拥有值为 eng 的 lang 属性</span><span style="font-family: monospace;"><br />getNodeSet</span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">doc</span><span style="color: #339933; font-family: monospace;">,</span><span style="color: blue; font-family: monospace;">"//title[@lang='eng']"</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"><br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 选取 bookstore 元素的所有 book 元素，且其中的 price 元素的值须大于 35.00。</span><span style="font-family: monospace;"><br />getNodeSet</span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">doc</span><span style="color: #339933; font-family: monospace;">,</span><span style="color: blue; font-family: monospace;">"/bookstore/book[price&gt;35.00]"</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"><br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 选取 bookstore 元素中的 book 元素的所有 title 元素，且 price 元素的值须大于 35.00。</span><span style="font-family: monospace;"><br />getNodeSet</span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">doc</span><span style="color: #339933; font-family: monospace;">,</span><span style="color: blue; font-family: monospace;">"/bookstore/book[price&gt;35.00]/title"</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"><br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 选取 book 元素的所有 title 和 price 元素</span><span style="font-family: monospace;"><br />getNodeSet</span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">doc</span><span style="color: #339933; font-family: monospace;">,</span><span style="color: blue; font-family: monospace;">"//book/title | //book/price"</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"><br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 选取文档中的所有 title 和 price 元素</span><span style="font-family: monospace;"><br />getNodeSet</span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">doc</span><span style="color: #339933; font-family: monospace;">,</span><span style="color: blue; font-family: monospace;">"//title | //price"</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"><br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 选取 bookstore 元素的所有子元素</span><span style="font-family: monospace;"><br />getNodeSet</span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">doc</span><span style="color: #339933; font-family: monospace;">,</span><span style="color: blue; font-family: monospace;">"/bookstore/*"</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"><br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 选取所有带有属性的 title 元素</span><span style="font-family: monospace;"><br />getNodeSet</span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">doc</span><span style="color: #339933; font-family: monospace;">,</span><span style="color: blue; font-family: monospace;">"//title[@*]"</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"><br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 选择所有属性lang的值</span><span style="font-family: monospace;"><br /></span><a href="http://inside-r.org/r-doc/base/unlist" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">unlist</span></a><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">getNodeSet</span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">doc</span><span style="color: #339933; font-family: monospace;">,</span><span style="color: blue; font-family: monospace;">"//title/@lang"</span><span style="color: #009900; font-family: monospace;">)</span><span style="color: #339933; font-family: monospace;">,</span><span style="font-family: monospace;">use.names = </span><span style="color: black; font-family: monospace; font-weight: bold;">FALSE</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"><br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># title结点下的所有文本</span><span style="font-family: monospace;"><br />getNodeSet</span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">doc</span><span style="color: #339933; font-family: monospace;">,</span><span style="color: blue; font-family: monospace;">"//title/text()"</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"><br />&nbsp;</span></pre><pre class="r geshifilter-R"><span style="font-family: 微软雅黑;"><span style="white-space: normal;">如果你比较习惯操作R，也可以用xmlToList转成list格式再说。如果说XML的结构比较简单，我们可以使用xmlToDataFrame直接将其转为R语言中的data.frame。下面再来看一个操作豆瓣API的例子和其它一些有用的函数。</span></span><span style="font-family: monospace;"><br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 豆瓣的例子</span><span style="font-family: monospace;"><br /></span><a href="http://inside-r.org/r-doc/base/url" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">url</span></a><span style="font-family: monospace;"> </span><span style="font-family: monospace;">&lt;-</span><span style="font-family: monospace;"> </span><span style="color: blue; font-family: monospace;">'http://api.douban.com/movie/subject/imdb/tt0111161'</span><span style="font-family: monospace;"><br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 解析获得树结构数据</span><span style="font-family: monospace;"><br />doc </span><span style="font-family: monospace;">&lt;-</span><span style="font-family: monospace;"> xmlTreeParse</span><span style="color: #009900; font-family: monospace;">(</span><a href="http://inside-r.org/r-doc/base/url" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">url</span></a><span style="color: #339933; font-family: monospace;">,</span><span style="font-family: monospace;">useInternal=</span><span style="color: black; font-family: monospace; font-weight: bold;">TRUE</span><span style="color: #339933; font-family: monospace;">,</span><span style="font-family: monospace;">encoding=</span><span style="color: blue; font-family: monospace;">"UTF-8"</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"> <br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 获得根结点信息</span><span style="font-family: monospace;"><br />top </span><span style="font-family: monospace;">&lt;-</span><span style="font-family: monospace;"> xmlRoot</span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">doc</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"><br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 获取子节点</span><span style="font-family: monospace;"><br />top</span><span style="color: #009900; font-family: monospace;">[</span><span style="color: #009900; font-family: monospace;">[</span><span style="color: #cc66cc; font-family: monospace;">5</span><span style="color: #009900; font-family: monospace;">]</span><span style="color: #009900; font-family: monospace;">]</span><span style="font-family: monospace;"> <br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 子节点名称</span><span style="font-family: monospace;"><br />xmlName</span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">top</span><span style="color: #009900; font-family: monospace;">[</span><span style="color: #009900; font-family: monospace;">[</span><span style="color: #cc66cc; font-family: monospace;">5</span><span style="color: #009900; font-family: monospace;">]</span><span style="color: #009900; font-family: monospace;">]</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"><br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 按名字取子节点</span><span style="font-family: monospace;"><br />top</span><span style="color: #009900; font-family: monospace;">[</span><span style="color: #009900; font-family: monospace;">[</span><span style="color: blue; font-family: monospace;">'author'</span><span style="color: #009900; font-family: monospace;">]</span><span style="color: #009900; font-family: monospace;">]</span><span style="font-family: monospace;"><br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 与上一命令相同</span><span style="font-family: monospace;"><br />xmlChildren</span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">top</span><span style="color: #009900; font-family: monospace;">)</span><span style="color: #009900; font-family: monospace;">[</span><span style="color: #009900; font-family: monospace;">[</span><span style="color: blue; font-family: monospace;">'author'</span><span style="color: #009900; font-family: monospace;">]</span><span style="color: #009900; font-family: monospace;">]</span><span style="font-family: monospace;"><br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 显示子节点数量</span><span style="font-family: monospace;"><br />xmlSize</span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">top</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"><br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 获取节点元素</span><span style="font-family: monospace;"><br />xmlValue</span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">top</span><span style="color: #009900; font-family: monospace;">[</span><span style="color: #009900; font-family: monospace;">[</span><span style="color: blue; font-family: monospace;">'author'</span><span style="color: #009900; font-family: monospace;">]</span><span style="color: #009900; font-family: monospace;">]</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"><br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 获取节点属性</span><span style="font-family: monospace;"><br />xmlAttrs</span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">top</span><span style="color: #009900; font-family: monospace;">[</span><span style="color: #009900; font-family: monospace;">[</span><span style="color: #cc66cc; font-family: monospace;">5</span><span style="color: #009900; font-family: monospace;">]</span><span style="color: #009900; font-family: monospace;">]</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"> <br /></span><span style="color: #666666; font-family: monospace; font-style: italic;">#获取节点属性值</span><span style="font-family: monospace;"><br />xmlGetAttr</span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">top</span><span style="color: #009900; font-family: monospace;">[</span><span style="color: #009900; font-family: monospace;">[</span><span style="color: #cc66cc; font-family: monospace;">5</span><span style="color: #009900; font-family: monospace;">]</span><span style="color: #009900; font-family: monospace;">]</span><span style="color: #339933; font-family: monospace;">,</span><span style="font-family: monospace;">name=</span><span style="color: blue; font-family: monospace;">'href'</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"> <br /></span><span style="color: #666666; font-family: monospace; font-style: italic;">#  向量化操作，获取所有子结点的名字</span><span style="font-family: monospace;"><br /></span><a href="http://inside-r.org/r-doc/base/sapply" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">sapply</span></a><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">xmlChildren</span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">top</span><span style="color: #009900; font-family: monospace;">)</span><span style="color: #339933; font-family: monospace;">,</span><span style="font-family: monospace;"> xmlName</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"><br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 使用专门的xmlSApply函数，等价于上一条</span><span style="font-family: monospace;"><br />xmlSApply</span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">top</span><span style="color: #339933; font-family: monospace;">,</span><span style="font-family: monospace;"> xmlName</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"> <br />&nbsp;<br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 使用xpath语法进行XML查询</span><span style="font-family: monospace;"><br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 找出合乎条件的节点，例如找出所有主演的节点集合</span><span style="font-family: monospace;"><br /></span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">node </span><span style="font-family: monospace;">&lt;-</span><span style="font-family: monospace;"> getNodeSet</span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">top</span><span style="color: #339933; font-family: monospace;">,</span><span style="font-family: monospace;"><br />                    path=</span><span style="color: blue; font-family: monospace;">"//db:attribute[@name='cast']"</span><span style="color: #009900; font-family: monospace;">)</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"><br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 然后取出其中的元素</span><span style="font-family: monospace;"><br /></span><a href="http://inside-r.org/r-doc/base/sapply" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">sapply</span></a><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">node</span><span style="color: #339933; font-family: monospace;">,</span><span style="font-family: monospace;">xmlValue</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"><br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 也可以从根节点一步操作得到结果</span><span style="font-family: monospace;"><br /></span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">cast </span><span style="font-family: monospace;">&lt;-</span><span style="font-family: monospace;"> xpathSApply</span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">top</span><span style="color: #339933; font-family: monospace;">,</span><span style="font-family: monospace;"><br />                     path=</span><span style="color: blue; font-family: monospace;">"//db:attribute[@name='cast']"</span><span style="color: #339933; font-family: monospace;">,</span><span style="font-family: monospace;"><br />                     xmlValue</span><span style="color: #009900; font-family: monospace;">)</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"><br />&nbsp;<br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 取出link节点中的属性和属性值</span><span style="font-family: monospace;"><br /></span><span style="color: #666666; font-family: monospace; font-style: italic;"># 定义命名空间，再使用前述函数</span><span style="font-family: monospace;"><br />namespaces </span><span style="font-family: monospace;">&lt;-</span><span style="font-family: monospace;"> </span><a href="http://inside-r.org/r-doc/base/c" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">c</span></a><span style="color: #009900; font-family: monospace;">(</span><a href="http://inside-r.org/r-doc/splines/ns" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">ns</span></a><span style="font-family: monospace;">=</span><span style="color: blue; font-family: monospace;">'http://www.w3.org/2005/Atom'</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"><br />getNodeSet</span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">top</span><span style="color: #339933; font-family: monospace;">,</span><span style="font-family: monospace;">  </span><span style="color: blue; font-family: monospace;">"//ns:link"</span><span style="color: #339933; font-family: monospace;">,</span><span style="font-family: monospace;"> namespaces</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"><br />xpathSApply</span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">top</span><span style="color: #339933; font-family: monospace;">,</span><span style="font-family: monospace;">  </span><span style="color: blue; font-family: monospace;">"//ns:link"</span><span style="color: #339933; font-family: monospace;">,</span><span style="font-family: monospace;"> <br />            fun=xmlAttrs</span><span style="color: #339933; font-family: monospace;">,</span><span style="font-family: monospace;"><br />            namespaces=namespaces</span><span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;"><br />xpathApply</span><span style="color: #009900; font-family: monospace;">(</span><span style="font-family: monospace;">top</span><span style="color: #339933; font-family: monospace;">,</span><span style="font-family: monospace;">  </span><span style="color: blue; font-family: monospace;">"//ns:link"</span><span style="color: #339933; font-family: monospace;">,</span><span style="font-family: monospace;"> <br />           fun=xmlGetAttr</span><span style="color: #339933; font-family: monospace;">,</span><span style="font-family: monospace;"><br />           </span><span style="color: blue; font-family: monospace;">'href'</span><span style="color: #339933; font-family: monospace;">,</span><span style="font-family: monospace;"> <br />           namespaces=namespaces</span><span style="color: #009900; font-family: monospace;">)</span></pre></div></div>
