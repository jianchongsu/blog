--- 
layout: post
name: blog-post_31
title: "\xE7\x94\xA8igraph\xE5\x8C\x85\xE6\x8E\xA2\xE7\xB4\xA2\xE4\xB8\x96\xE7\x95\x8C\xE8\x88\xAA\xE7\xA9\xBA\xE7\xBD\x91\xE7\xBB\x9C"
date: 2012-07-31 12:26:00 +08:00
categories: 
- SNA
- "\xE5\x85\xAC\xE5\xBC\x80\xE6\x95\xB0\xE6\x8D\xAE"
permalink: /2012/07/blog-post_31.html
---
<div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-oFh1M8d7Ezw/UBfyb_CWkvI/AAAAAAAABEk/uKqHlnHs3u4/s1600/airport2.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="389" src="http://3.bp.blogspot.com/-oFh1M8d7Ezw/UBfyb_CWkvI/AAAAAAAABEk/uKqHlnHs3u4/s400/airport2.JPG" width="400" /></a></div>本文使用的数据仍然是<a href="http://xccds1977.blogspot.com/2012/07/blog-post_26.html">上篇博文中</a>用到的世界航班数据，不过本例不再仅限于中国国内航班。如果用社交网络的角度来观察数据，一个机场可以看作是一个人，而机场之间的来往航班可以看作是人与人之间的某种联系。整体世界的航线可以看作是一个社交网络。那么用<b>R语言的<a href="http://xccds1977.blogspot.com/2012/06/igraph.html">igraph包</a></b>来简单探索一下这个社交网络，看能不能得到什么发现。现在<a href="http://internet-map.net/">星图</a>真得很热门，所以本文最后也会搞一个山寨出来。<br /><br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R"><span style="color: #666666; font-family: monospace; font-style: italic;"><a name='more'></a># 仍然是上一篇博文的数据 </span><br />data.port <span style="font-family: monospace;">&lt;-</span> <a href="http://inside-r.org/r-doc/utils/read.csv" style="font-family: monospace;"><span style="color: #003399;">read.csv</span></a><span style="color: #009900; font-family: monospace;">(</span><span style="color: blue; font-family: monospace;">'d:/airports.dat'</span><span style="color: #339933; font-family: monospace;">,</span>F<span style="color: #009900; font-family: monospace;">)</span><br />data.line <span style="font-family: monospace;">&lt;-</span> <a href="http://inside-r.org/r-doc/utils/read.csv" style="font-family: monospace;"><span style="color: #003399;">read.csv</span></a><span style="color: #009900; font-family: monospace;">(</span><span style="color: blue; font-family: monospace;">'d:/routes.dat'</span><span style="color: #339933; font-family: monospace;">,</span>F<span style="color: #009900; font-family: monospace;">)</span><br />&nbsp;<br /><span style="color: #666666; font-family: monospace; font-style: italic;"># 机场数据整理，除去重复的和没有编号的机场</span><br />airports <span style="font-family: monospace;">&lt;-</span>data.port<span style="color: #009900; font-family: monospace;">[</span>data.port<span style="font-family: monospace;">$</span>V5<span style="font-family: monospace;">!</span>=<span style="color: blue; font-family: monospace;">''</span><span style="color: #339933; font-family: monospace;">,</span><br />                      <a href="http://inside-r.org/r-doc/base/c" style="font-family: monospace;"><span style="color: #003399;">c</span></a><span style="color: #009900; font-family: monospace;">(</span><span style="color: blue; font-family: monospace;">'V5'</span><span style="color: #339933; font-family: monospace;">,</span><span style="color: blue; font-family: monospace;">'V4'</span><span style="color: #339933; font-family: monospace;">,</span><span style="color: blue; font-family: monospace;">'V3'</span><span style="color: #009900; font-family: monospace;">)</span><span style="color: #009900; font-family: monospace;">]</span><br /><a href="http://inside-r.org/r-doc/base/names" style="font-family: monospace;"><span style="color: #003399;">names</span></a><span style="color: #009900; font-family: monospace;">(</span>airports<span style="color: #009900; font-family: monospace;">)</span> <span style="font-family: monospace;">&lt;-</span> <a href="http://inside-r.org/r-doc/base/c" style="font-family: monospace;"><span style="color: #003399;">c</span></a><span style="color: #009900; font-family: monospace;">(</span><span style="color: blue; font-family: monospace;">'name'</span><span style="color: #339933; font-family: monospace;">,</span><span style="color: blue; font-family: monospace;">'country'</span><span style="color: #339933; font-family: monospace;">,</span><span style="color: blue; font-family: monospace;">'city'</span><span style="color: #009900; font-family: monospace;">)</span><br />airports<span style="font-family: monospace;">$</span>city <span style="font-family: monospace;">&lt;-</span> <a href="http://inside-r.org/r-doc/base/as.character" style="font-family: monospace;"><span style="color: #003399;">as.character</span></a><span style="color: #009900; font-family: monospace;">(</span>airports<span style="font-family: monospace;">$</span>city<span style="color: #009900; font-family: monospace;">)</span><br />airports <span style="font-family: monospace;">&lt;-</span> airports<span style="color: #009900; font-family: monospace;">[</span><span style="font-family: monospace;">!</span><a href="http://inside-r.org/r-doc/base/duplicated" style="font-family: monospace;"><span style="color: #003399;">duplicated</span></a><span style="color: #009900; font-family: monospace;">(</span>airports<span style="font-family: monospace;">$</span>name<span style="color: #009900; font-family: monospace;">)</span><span style="color: #339933; font-family: monospace;">,</span><span style="color: #009900; font-family: monospace;">]</span><br />&nbsp;<br /><span style="color: #666666; font-family: monospace; font-style: italic;"># 航线数据整理，只保留起飞和降落地点</span><br />goodlines <span style="font-family: monospace;">&lt;-</span> <span style="color: #009900; font-family: monospace;">(</span>data.line<span style="color: #009900; font-family: monospace;">[</span><span style="color: #339933; font-family: monospace;">,</span><span style="color: blue; font-family: monospace;">'V3'</span><span style="color: #009900; font-family: monospace;">]</span> <span style="font-family: monospace;">%in%</span> airports<span style="font-family: monospace;">$</span>name<span style="color: #009900; font-family: monospace;">)</span> <span style="font-family: monospace;">&amp;</span><br />       <span style="color: #009900; font-family: monospace;">(</span>data.line<span style="color: #009900; font-family: monospace;">[</span><span style="color: #339933; font-family: monospace;">,</span><span style="color: blue; font-family: monospace;">'V5'</span><span style="color: #009900; font-family: monospace;">]</span> <span style="font-family: monospace;">%in%</span> airports<span style="font-family: monospace;">$</span>name<span style="color: #009900; font-family: monospace;">)</span><br />airlines <span style="font-family: monospace;">&lt;-</span> data.line<span style="color: #009900; font-family: monospace;">[</span>goodlines<span style="color: #339933; font-family: monospace;">,</span><a href="http://inside-r.org/r-doc/base/c" style="font-family: monospace;"><span style="color: #003399;">c</span></a><span style="color: #009900; font-family: monospace;">(</span><span style="color: blue; font-family: monospace;">'V3'</span><span style="color: #339933; font-family: monospace;">,</span><span style="color: blue; font-family: monospace;">'V5'</span><span style="color: #009900; font-family: monospace;">)</span><span style="color: #009900; font-family: monospace;">]</span><br /><a href="http://inside-r.org/r-doc/base/names" style="font-family: monospace;"><span style="color: #003399;">names</span></a><span style="color: #009900; font-family: monospace;">(</span>airlines<span style="color: #009900; font-family: monospace;">)</span> <span style="font-family: monospace;">&lt;-</span> <a href="http://inside-r.org/r-doc/base/c" style="font-family: monospace;"><span style="color: #003399;">c</span></a><span style="color: #009900; font-family: monospace;">(</span><span style="color: blue; font-family: monospace;">'from'</span><span style="color: #339933; font-family: monospace;">,</span><span style="color: blue; font-family: monospace;">'to'</span><span style="color: #009900; font-family: monospace;">)</span><br />&nbsp;<span style="color: #666666; font-family: monospace; font-style: italic;"># 加载igraph包，生成网络图对象</span><br /><a href="http://inside-r.org/r-doc/base/library" style="font-family: monospace;"><span style="color: #003399;">library</span></a><span style="color: #009900; font-family: monospace;">(</span><a href="http://inside-r.org/packages/cran/igraph" style="font-family: monospace;">igraph</a><span style="color: #009900; font-family: monospace;">)</span><br />g <span style="font-family: monospace;">&lt;-</span> graph.data.frame<span style="color: #009900; font-family: monospace;">(</span>airlines<span style="color: #339933; font-family: monospace;">,</span> vertices=airports<span style="color: #339933; font-family: monospace;">,</span>directed=F<span style="color: #009900; font-family: monospace;">)</span><br /><span style="color: #666666; font-family: monospace; font-style: italic;"># 删除没有航线的机场</span><br />g<span style="font-family: monospace;">&lt;-</span> g <span style="font-family: monospace;">-</span> V<span style="color: #009900; font-family: monospace;">(</span>g<span style="color: #009900; font-family: monospace;">)</span><span style="color: #009900; font-family: monospace;">[</span>degree<span style="color: #009900; font-family: monospace;">(</span>g<span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;">==</span><span style="color: #cc66cc; font-family: monospace;">0</span><span style="color: #009900; font-family: monospace;">]</span><br />&nbsp;<br /><span style="color: #666666; font-family: monospace; font-style: italic;"># 合并航线，将同一航线的频次放入weight属性</span><br />is.multiple<span style="color: #009900; font-family: monospace;">(</span>g<span style="color: #009900; font-family: monospace;">)</span><br />E<span style="color: #009900; font-family: monospace;">(</span>g<span style="color: #009900; font-family: monospace;">)</span><span style="font-family: monospace;">$</span>weight <span style="font-family: monospace;">&lt;-</span> count.multiple<span style="color: #009900; font-family: monospace;">(</span>g<span style="color: #009900; font-family: monospace;">)</span><br />g1 <span style="font-family: monospace;">&lt;-</span> simplify<span style="color: #009900; font-family: monospace;">(</span>g<span style="color: #339933; font-family: monospace;">,</span> remove.multiple = <span style="color: black; font-family: monospace;">TRUE</span><span style="color: #339933; font-family: monospace;">,</span> remove.loops = <span style="color: black; font-family: monospace;">TRUE</span><span style="color: #339933; font-family: monospace;">,</span><br />              edge.attr.comb = <span style="color: blue; font-family: monospace;">'mean'</span><span style="color: #009900; font-family: monospace;">)</span><br /><a href="http://inside-r.org/r-doc/base/summary" style="font-family: monospace;"><span style="color: #003399;">summary</span></a><span style="color: #009900; font-family: monospace;">(</span>g1<span style="color: #009900; font-family: monospace;">)</span><br />&nbsp;<br /><span style="color: #666666; font-family: monospace; font-style: italic;"># 从上面观察整个机场群共有</span><span style="color: #666666;"><i><b>3218个机场，16822条航线</b>，来</i></span><span style="color: #666666; font-style: italic;">判断这些机场整体是否连通？</span></pre><pre class="r geshifilter-R" style="font-family: monospace;">is.connected<span style="color: #009900;">(</span>g1<span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 存在一些不能连通的机场，观察有哪些相互断开的机场群？</span><br />clusters<span style="color: #009900;">(</span>g1<span style="color: #009900;">)</span>$csize<br />V<span style="color: #009900;">(</span>g1<span style="color: #009900;">)</span><span style="color: #009900;">[</span>clusters<span style="color: #009900;">(</span>g1<span style="color: #009900;">)</span>$membership==<span style="color: #cc66cc;">2</span><span style="color: #009900;">]</span>$country<br /><span style="color: #666666; font-style: italic;"># 发现有一些机场属于西南太平洋上的岛国，</span><span style="color: #666666; font-style: italic;">去掉这些处于边缘状态的机场</span><br />g2 &lt;- g1 - V<span style="color: #009900;">(</span>g1<span style="color: #009900;">)</span><span style="color: #009900;">[</span>clusters<span style="color: #009900;">(</span>g1<span style="color: #009900;">)</span>$membership!=<span style="color: #cc66cc;">1</span><span style="color: #009900;">]</span><br />&nbsp;<br /><span style="color: #666666; font-style: italic;"># 观察哪<b>一对机场之间航班频次最多</b>，原来是香港和曼谷，它们之间的航班达到28次，果然是有基情。</span><br />E<span style="color: #009900;">(</span>g2<span style="color: #009900;">)</span><span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/which.max"><span style="color: #003399;">which.max</span></a><span style="color: #009900;">(</span>E<span style="color: #009900;">(</span>g2<span style="color: #009900;">)</span>$weight<span style="color: #009900;">)</span><span style="color: #009900;">]</span><br />V<span style="color: #009900;">(</span>g2<span style="color: #009900;">)</span><span style="color: #009900;">[</span><span style="color: blue;">'BKK'</span><span style="color: #009900;">]</span>$city<br />V<span style="color: #009900;">(</span>g2<span style="color: #009900;">)</span><span style="color: #009900;">[</span><span style="color: blue;">'HKG'</span><span style="color: #009900;">]</span>$city<br />&nbsp;<br /><span style="color: #666666; font-style: italic;"># 哪个机场的<b>直航城市最多</b>，法兰克福位于首位，它与237个机场间有直飞航班。从下面的分布图来看，大部分机场的直航城市并不多，只有少数机场特别突出，我们还可以列出直航城市最多的十大机场。</span><br />V<span style="color: #009900;">(</span>g2<span style="color: #009900;">)</span><span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/which.max"><span style="color: #003399;">which.max</span></a><span style="color: #009900;">(</span>degree<span style="color: #009900;">(</span>g2<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">]</span>$city<br /><a href="http://inside-r.org/r-doc/graphics/plot"><span style="color: #003399;">plot</span></a><span style="color: #009900;">(</span>degree.distribution<span style="color: #009900;">(</span>g2<span style="color: #009900;">)</span><span style="color: #339933;">,</span> <a href="http://inside-r.org/r-doc/base/log"><span style="color: #003399;">log</span></a>=<span style="color: blue;">"xy"</span><span style="color: #009900;">)</span><br />V<span style="color: #009900;">(</span>g2<span style="color: #009900;">)</span>$city<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/order"><span style="color: #003399;">order</span></a><span style="color: #009900;">(</span>degree<span style="color: #009900;">(</span>g2<span style="color: #009900;">)</span><span style="color: #339933;">,</span>decreasing=T<span style="color: #009900;">)</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #cc66cc;">1</span>:<span style="color: #cc66cc;">10</span><span style="color: #009900;">]</span></pre><div class="separator" style="clear: both; text-align: center;"></div><pre class="r geshifilter-R">&nbsp;<span style="color: #666666; font-family: monospace; font-style: italic;">#&nbsp;</span><span style="color: #666666;"><i>Google使用的PageRank值代表了一个网站的重要性。PageRank根据网页之间的超链接来确定一个页面的等级。那么机场的重要性也可以从航线的多寡来确定。</i></span><span style="color: #666666;"><i>&nbsp;</i></span><span style="color: #666666; font-style: italic;">根据pagerank计算出</span><span style="color: #666666; font-style: italic;">机场前十强，分别是</span><span style="color: #666666;"><i>"Chicago" "Denver" "Los Angeles" "Houston"  "London" "Frankfurt" "Paris"  "Beijing" "Singapore" "Bangkok"</i></span><i style="color: #666666;">&nbsp;</i></pre><pre class="r geshifilter-R" style="font-family: monospace;">V<span style="color: #009900;">(</span>g2<span style="color: #009900;">)</span>$city<span style="color: #009900;">[</span><a href="http://inside-r.org/r-doc/base/order"><span style="color: #003399;">order</span></a><span style="color: #009900;">(</span>page.rank<span style="color: #009900;">(</span>g2<span style="color: #009900;">)</span>$vector<span style="color: #339933;">,</span>decreasing=T<span style="color: #009900;">)</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #cc66cc;">1</span>:<span style="color: #cc66cc;">10</span><span style="color: #009900;">]</span><br />&nbsp;<br /><span style="color: #666666; font-style: italic;"># 观察两个机场之间是否连通直航，这里判断的是武汉到开罗，结果是否</span><br />are.connected<span style="color: #009900;">(</span>g2<span style="color: #339933;">,</span><span style="color: blue;">'WUH'</span><span style="color: #339933;">,</span><span style="color: blue;">'CAI'</span><span style="color: #009900;">)</span><br />&nbsp;<br /><span style="color: #666666; font-style: italic;"># 那么应当如何转机呢，这实际上是寻找网络中的最短连线wuhan-&gt;cairo，给出的结果是先从武汉到东京，再到莫斯科，最后到开罗。</span><br />V<span style="color: #009900;">(</span>g2<span style="color: #009900;">)</span><span style="color: #009900;">[</span>get.shortest.paths<span style="color: #009900;">(</span>g2<span style="color: #339933;">,</span><span style="color: blue;">'WUH'</span><span style="color: #339933;">,</span><span style="color: blue;">'CAI'</span><span style="color: #009900;">)</span><span style="color: #009900;">[</span><span style="color: #009900;">[</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">]</span><span style="color: #009900;">]</span><span style="color: #009900;">]</span>$city<br />&nbsp;<br /><span style="color: #666666; font-style: italic;"># 还可以使用网络分析方法中的社群探测，发现网络中有三个主要的社群，观察社群特征，它们分别对应了美洲，欧洲与中东地区，亚太地区</span><br />commu &lt;-  fastgreedy.community<span style="color: #009900;">(</span>g2<span style="color: #009900;">)</span><br />commu$membership<br />sizes<span style="color: #009900;">(</span>commu<span style="color: #009900;">)</span><br />V<span style="color: #009900;">(</span>g2<span style="color: #009900;">)</span><span style="color: #009900;">[</span>commu$membership==<span style="color: #cc66cc;">1</span><span style="color: #009900;">]</span>$country<br />V<span style="color: #009900;">(</span>g2<span style="color: #009900;">)</span><span style="color: #009900;">[</span>commu$membership==<span style="color: #cc66cc;">2</span><span style="color: #009900;">]</span>$country<br />V<span style="color: #009900;">(</span>g2<span style="color: #009900;">)</span><span style="color: #009900;">[</span>commu$membership==<span style="color: #cc66cc;">3</span><span style="color: #009900;">]</span>$country</pre><pre class="r geshifilter-R"><i><span style="color: #666666;"># 绘制网络图，由于机场数量太多，所以略去了连线，只留下圆点来表示机场，圆的大小表示机场的重要性，不同的颜色表示不同的社群</span></i><br />rank.max &lt;- max(page.rank(g2)$vector)<br />rank.min &lt;- min(page.rank(g2)$vector)<br />size &lt;- 20*(page.rank(g2)$vector -rank.min)/(rank.max-rank.min)+1<br />V(g2)$size &lt;- size<br />V(g2)$color &lt;- 'grey'<br />V(g2)$frame.color &lt;- 'black'<br />V(g2)[commu$membership==1]$color &lt;- 'red4'<br />V(g2)[commu$membership==2]$color &lt;- 'darkseagreen3'<br />V(g2)[commu$membership==3]$color &lt;- 'darkslategray3'<br />V(g2)$label &lt;- NA<br />E(g2)$color &lt;- 'white'<br />plot(g2, layout=layout.sphere)</pre><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-ic-Boy_O4CE/UBfy4dQGAZI/AAAAAAAABEs/XxbsioXhDsM/s1600/airport.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="397" src="http://2.bp.blogspot.com/-ic-Boy_O4CE/UBfy4dQGAZI/AAAAAAAABEs/XxbsioXhDsM/s400/airport.JPG" width="400" /></a></div><pre class="r geshifilter-R"></pre></div></div>
