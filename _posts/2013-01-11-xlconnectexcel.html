--- 
layout: post
name: xlconnectexcel
title: "\xE7\x94\xA8XLConnect\xE5\x8C\x85\xE6\x93\x8D\xE6\x8E\xA7Excel\xE8\xA1\xA8\xE6\xA0\xBC"
date: 2013-01-11 20:00:00 +08:00
categories: 
- "\xE6\x95\xB0\xE6\x8D\xAE\xE5\xAF\xBC\xE5\x85\xA5"
permalink: /2013/01/xlconnectexcel.html
---
<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-erVtKb0-aM4/UO_9QGUSfCI/AAAAAAAABXM/D8gy2kYvw2E/s1600/excel_logo.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-erVtKb0-aM4/UO_9QGUSfCI/AAAAAAAABXM/D8gy2kYvw2E/s1600/excel_logo.png" /></a></div>作为一个R迷，为什么要去捣鼓XLS文件？其实这种需求场景很多的啦，比如其它部门的同事有批量的Excel文件要处理，或者家里一把手的直接命令。Excel里面已经有不少函数可以处理数据了，包括简单的矩阵运算以及透视表什么的，但归根到底它还是需要鼠标点来点去，伤手腕啊。为了保护右手我们要提倡用代码控制一切需要鼠标的动作。高级的Excel玩家可能会用VBA去做自动处理，更高明的玩家则跳出三界外，从外部来控制单位格数据的输入输出。<br /><br />R语言中有很多包可以处理表格文档，包括最为通用的RODBC包，XLConnect包也是操控Excel文档的利器，功能很丰富。使用该包的前提是要安装好Java，还要在环境变量里搞好设置。之后就可以安装加载包了。我们可以将表格文档看做是数据输入和输出端，R则是中间的运算单元。二者主要是通过数据框格式和工作表单元格进行交换。下面来看将iris数据框写入和读取的示例（其实是翻译的官方文档）。<br /><br /><a name='more'></a>从层级上来看，Excel文档数据有三个级别，分别是文档(file)、工作表(sheet)、区域(region)。所以从R写入数据也有几个步骤。<br /><br /><pre class="r geshifilter-R"><span style="color: #666666; font-style: italic;"># 读取或创建一个XLSX文件，此步相当于建立一个连接</span><br />xls &lt;- loadWorkbook<span style="color: #009900;">(</span><span style="color: blue;">'test.xlsx'</span><span style="color: #339933;">,</span>create=<span style="color: black; font-weight: bold;">TRUE</span><span style="color: #009900;">)</span> <br /><span style="color: #666666; font-style: italic;"># 创建工作表</span><br />createSheet<span style="color: #009900;">(</span>xls<span style="color: #339933;">,</span>name=<span style="color: blue;">'namesheet'</span><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 写入数据</span><br />writeWorksheet<span style="color: #009900;">(</span>xls<span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/datasets/iris"><span style="color: #003399; font-weight: bold;">iris</span></a><span style="color: #339933;">,</span><span style="color: blue;">'nameshee'</span><span style="color: #339933;">,</span><br />               startRow=<span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span>startCol=<span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span> <span style="color: #666666; font-style: italic;"># 数据出现的左上角位置</span><br />               header=<span style="color: black; font-weight: bold;">TRUE</span><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 存入硬盘，直到此步方才有文档生成</span><br />saveWorkbook<span style="color: #009900;">(</span>xls<span style="color: #009900;">)</span></pre><br />上面四个步骤是新建文档、新建工作表、写入数据、最后存盘。如果要写入数据的同时创建好区域名称，则在第三步有所不同。<br /><pre class="r geshifilter-R"><span style="color: #666666; font-style: italic;"># 创建区域名</span><br />createName<span style="color: #009900;">(</span>xls<span style="color: #339933;">,</span>name=<span style="color: blue;">'nameregion'</span><span style="color: #339933;">,</span><br />           <a href="http://inside-r.org/r-doc/stats/formula"><span style="color: #003399; font-weight: bold;">formula</span></a>=<span style="color: blue;">'namesheet!$C$5'</span><span style="color: #339933;">,</span> <span style="color: #666666; font-style: italic;">#区域的左上角单元格位置</span><br />           overwrite=<span style="color: black; font-weight: bold;">TRUE</span><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 写入数据</span><br />writeNamedRegion<span style="color: #009900;">(</span>xls<span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/datasets/iris"><span style="color: #003399; font-weight: bold;">iris</span></a><span style="color: #339933;">,</span>name=<span style="color: blue;">'nameregion'</span><span style="color: #009900;">)</span></pre><br />读取文档则简单的多<br /><br /><pre class="r geshifilter-R">xls &lt;- loadWorkbook<span style="color: #009900;">(</span><span style="color: blue;">'test.xlsx'</span><span style="color: #339933;">,</span>create=<span style="color: black; font-weight: bold;">TRUE</span><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399; font-weight: bold;">data</span></a> &lt;- readWorksheet<span style="color: #009900;">(</span>xls<span style="color: #339933;">,</span> <span style="color: blue;">'namesheet'</span><span style="color: #339933;">,</span><br />              startRow=<span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span> startCol=<span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span><br />              endRow=<span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span>endCol=<span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span> <span style="color: #666666; font-style: italic;">#取0表示自动判断</span><br />              header=<span style="color: black; font-weight: bold;">TRUE</span><span style="color: #009900;">)</span></pre>上面读写文档都有多个步骤，如果想一步到位，也有相应的快捷函数。比较好玩的是还可以往Excel中插入图片。我们可以先利用R的绘图能力，建立好一张图片，例如叫作iris.png，再向表格中的区域位置插入图片。<br /><pre class="r geshifilter-R">xls &lt;- loadWorkbook<span style="color: #009900;">(</span><span style="color: blue;">'test.xlsx'</span><span style="color: #339933;">,</span>create=<span style="color: black; font-weight: bold;">TRUE</span><span style="color: #009900;">)</span><br />addImage<span style="color: #009900;">(</span>xls<span style="color: #339933;">,</span><span style="color: blue;">'iris.png'</span><span style="color: #339933;">,</span>name=<span style="color: blue;">'nameregion'</span><span style="color: #339933;">,</span>originalSize=<span style="color: black; font-weight: bold;">TRUE</span><span style="color: #009900;">)</span><br />saveWorkbook<span style="color: #009900;">(</span>xls<span style="color: #009900;">)</span></pre>使用demo(addImage)可以查看详细的演示过程。<br /><br /><!-----><!-----><!-----><!----->
